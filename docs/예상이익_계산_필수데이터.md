# 예상이익 계산 필수 데이터 가이드

## 📊 공통 필수 데이터

### 1. **예상 월 매출** (`expected_monthly_sales`)
- **가장 중요**: 이 값이 0이면 대부분의 전략에서 `won: None` 반환
- **계산 방법**:
  - **1순위**: `mtd_sales` (이번 달 누적 매출) → 경과 일수로 월 예상치 계산
  - **2순위**: `avg_daily_sales` (평균 일매출) → 30일 곱하기
  - **3순위**: `mtd_sales` 그대로 사용 (추정 불가)

**필요한 입력 데이터:**
- ✅ **점장 마감 데이터** (`daily_close` 테이블)
  - 최소 1일 이상의 마감 데이터 필요
  - 경과 일수가 많을수록 예상치가 정확해짐

---

## 🎯 전략별 추가 데이터

### 1. **SURVIVAL (생존선 전략)**
**필수:**
- ✅ 손익분기점 (`break_even_sales`)
  - 고정비 + 변동비율 계산 필요
  - `목표 비용구조` 페이지에서 설정 필요

**선택:**
- 변동비율 (`variable_cost_rate`)
  - 없으면 기본값 30% 사용

**계산 공식:**
```
won = (손익분기점 - 예상매출) × (1 - 변동비율)
```

---

### 2. **MARGIN (마진 개선 전략)**
**필수:**
- ✅ 예상 월 매출

**선택 (더 정교한 계산):**
- 건강검진 Q 축 데이터
  - Q 리스크가 "red"면 보수적 적용 (1%p 개선)
  - 없으면 표준 적용 (2%p 개선)

**계산 공식:**
```
won = 예상매출 × 개선률(1~2%p)
```

---

### 3. **COST (원가 개선 전략)**
**필수:**
- ✅ 예상 월 매출

**선택 (더 정교한 계산):**
- 재료 집중도 (`top3_cost_concentration_pct`)
  - 상위 3개 재료의 원가 집중도
  - 70% 이상이면 2%p 개선, 아니면 1.5%p 개선
  - `재료 등록` 페이지에서 재료/원가 데이터 필요

**계산 공식:**
```
won = 예상매출 × 개선률(1.5~2%p)
```

---

### 4. **PORTFOLIO (포트폴리오 개선 전략)**
**필수:**
- ✅ 예상 월 매출

**선택 (더 정교한 계산):**
- 객단가 (`sales_per_visitor`)
  - `sales_per_visitor = monthly_sales / visitors_mtd`
  - 있으면: 객단가 +3% 개선 가정
  - 없으면: 매출 +2% 개선 가정 (보수적)

**필요한 입력:**
- 네이버 방문자 데이터 (`naver_visitors` 테이블)
  - 또는 매출 데이터로 역산

**계산 공식:**
```
있으면: won = (객단가 × 3%) × 방문자수 × (1 - 변동비율)
없으면: won = 예상매출 × 2% × (1 - 변동비율)
```

---

### 5. **ACQUISITION (방문자 증가 전략)**
**필수:**
- ✅ 예상 월 매출

**선택 (더 정교한 계산):**
- 방문자 데이터 (`visitors_mtd`)
  - 있으면: 실제 방문자 수 기반 계산
  - 없으면: 매출 기반 보수적 추정
- 건강검진 M 축 데이터
  - M 리스크가 "red"면 3% 증가 가정 (보수적)
  - 없으면 5% 증가 가정 (표준)

**필요한 입력:**
- 네이버 방문자 데이터 (`naver_visitors` 테이블)

**계산 공식:**
```
있으면: won = 추가방문자 × 객단가 × (1 - 변동비율)
없으면: won = 예상매출 × 증가률(3~5%) × (1 - 변동비율)
```

---

### 6. **OPERATIONS (운영 개선 전략)**
**필수:**
- ✅ 예상 월 매출
- 변동비율 (`variable_cost_rate`)

**계산 공식:**
```
won = 예상매출 × 2% (리스크 회피) × (1 - 변동비율)
```
- 항상 "간접효과"로 분류
- 정량화가 어려운 운영 리스크 감소 효과

---

## 📋 데이터 입력 우선순위

### 최소 요구사항 (예상이익 계산 가능)
1. ✅ **점장 마감 1일 이상** → `mtd_sales` 계산 가능
2. ✅ **목표 비용구조 설정** → 손익분기점 계산 가능 (SURVIVAL 전략용)

### 정교한 계산을 위한 추가 데이터
3. ✅ **재료 등록** → 재료 집중도 계산 (COST 전략)
4. ✅ **네이버 방문자 데이터** → 객단가 계산 (PORTFOLIO, ACQUISITION 전략)
5. ✅ **건강검진 실시** → Q/M 축 리스크 데이터 (MARGIN, ACQUISITION 전략)

---

## ⚠️ 주의사항

### `won: None`이 반환되는 경우
1. **예상 월 매출이 0이거나 계산 실패**
   - 해결: 점장 마감 데이터 입력
2. **손익분기점이 0이거나 계산 실패** (SURVIVAL 전략만)
   - 해결: 목표 비용구조 페이지에서 고정비/변동비 설정
3. **Impact 계산 중 예외 발생**
   - 로그 확인 필요

### 데이터가 부족할 때
- 대부분의 전략은 `expected_monthly_sales`만 있으면 최소한의 추정치 제공
- 추가 데이터가 있으면 더 정교한 계산 가능
- `won: None`일 때는 메시지를 표시하지 않음 (과도한 노출 방지)

---

## 🔍 디버깅 팁

### 예상이익이 계산되지 않을 때 확인사항
1. **점장 마감 데이터 확인**
   ```python
   # strategy_cards.py에서
   monthly_sales = load_monthly_sales_total(store_id, year, month) or 0
   # 이 값이 0이면 won: None
   ```

2. **예상 월 매출 계산 확인**
   ```python
   # impact_engine.py의 _estimate_expected_monthly_sales
   mtd_sales = kpi.get("mtd_sales")  # 이 값이 0이면 문제
   ```

3. **DEV 모드에서 확인**
   ```python
   st.session_state["_dev_mode"] = True
   # ZONE 1 디버그 정보에서 cards 개수와 첫 번째 카드 확인
   ```
