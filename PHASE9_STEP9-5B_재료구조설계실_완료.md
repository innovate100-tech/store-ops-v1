# PHASE 9 / STEP 9-5B — Ingredient Structure Design Lab 완료

## 📋 작업 목표

기존 "재료 구조 설계실(ingredient_management.py)"을
"재료 구조 설계실(원가 집중 · 대체재 · 발주 구조)" 전략 페이지로 업그레이드했습니다.

이 페이지는 단순 재료 등록이 아니라,
**"이 가게의 원가 리스크 구조를 설계하는 전략실"**이 되었습니다.

---

## ✅ 완료된 작업

### 1. 재료 구조 헬퍼 함수 생성
- **파일**: `ui_pages/design_lab/ingredient_structure_helpers.py` (신규 생성)
- **기능**: 재료 구조 분석 관련 헬퍼 함수
  - `calculate_ingredient_usage_cost()`: 재료별 사용금액 계산 (daily_sales_items × recipes × ingredients.unit_cost)
  - `calculate_cost_concentration()`: 원가 집중도 계산 (TOP3, TOP5)
  - `identify_high_risk_ingredients()`: 고위험 재료 판별 (원가 비중 20%+ & 연결 메뉴 3개+)
  - `check_order_structure_status()`: 발주 구조 상태 판정
  - `get_ingredient_structure_verdict()`: 재료 구조 판결문 생성

### 2. 재료 구조 설계실 업그레이드
- **파일**: `ui_pages/ingredient_management.py` (수정)
- **변경**: 전략 페이지로 전면 업그레이드
- **제목**: "재료 구조 설계실 (원가 집중 · 대체재 · 발주 구조)"로 변경

### 3. 사이드바 라벨 변경
- **파일**: `app.py` (수정)
- **변경**: "재료 구조 설계실" → "재료 구조 설계실 (원가 집중 · 대체재 · 발주 구조)"

---

## 📝 페이지 구조 (4층)

### ZONE A: 코치 요약 (Ingredient Structure Verdict)
- **카드 4개**:
  1. 총 재료 수
  2. 원가 TOP3 집중도 (%)
  3. 고위험 재료 수 (원가 20%+ & 메뉴 3개+)
  4. 발주 구조 상태 (안전/주의/위험)
- **판결문**: 재료 구조 진단 결과
  - 예: "현재 원가의 61%가 3개 재료에 집중되어 있습니다."
- **추천 액션**: 고위험 재료 보기 / 대체 구조 설계 / 발주 구조 점검

### ZONE B: 구조 맵 (Ingredient Structure Map)
1. **재료 원가 집중도 Pareto 차트**
   - X: 재료명 (상위 10개)
   - Y: 누적 원가 비율 (%)
   - 70%, 90% 기준선 표시

2. **재료 영향도 테이블**
   - 컬럼: 재료명, 총 사용금액, 원가 비중 %, 연결 메뉴 수, 위험도
   - 위험도 자동 판정: 🔴 고위험 / ⚠️ 주의 / ✅ 안전

### ZONE C: 사장 학교 (Ingredient Structure Theory)
- "원가는 '비율'이 아니라 '집중도'로 무너진다"
- "대체 불가능 재료는 사업 리스크다"
- "발주는 비용이 아니라 구조다"

### ZONE D: 설계 도구 (Ingredient Strategy Tools)
1. **고위험 재료 테이블** (핵심)
   - 컬럼: 재료명, 원가 비중 %, 연결 메뉴 수, 총 사용금액, 위험 사유
   - 기능:
     - 대체 가능 여부 (O/X toggle, session_state)
     - 발주 유형 (단일 / 복수 / 미설정, session_state)
     - 필터: 전체 / 원가 비중 순 / 연결 메뉴 수 순
     - 클릭 시 → 연결 메뉴 목록 표시

2. **대체 구조 설계 패널**
   - 선택 재료 기준:
     - 연결된 메뉴 리스트
     - "이 재료가 빠지면 영향받는 메뉴"
   - 입력 요소:
     - 대체 가능 재료 메모 (session_state)
     - 구조 전략 메모 (session_state)
   - ※ DB 저장 아님, 설계 보드 개념

3. **기존 재료 관리 기능** (하단 유지)
   - 재료 등록
   - 단가 수정
   - 단위 관리
   - 안전재고 설정

---

## 📝 수정된 파일 목록

### 1. `ui_pages/design_lab/ingredient_structure_helpers.py` (신규 생성)
- 재료 구조 분석 관련 헬퍼 함수들
- 재료 사용금액 계산 (daily_sales_items × recipes × ingredients.unit_cost)
- 원가 집중도 계산
- 고위험 재료 판별
- 발주 구조 상태 판정

### 2. `ui_pages/ingredient_management.py` (수정)
- 전략 페이지로 전면 업그레이드
- ZONE A: 재료 구조 코치 요약
- ZONE B: 재료 구조 맵 (Pareto 차트, 영향도 테이블)
- ZONE C: 재료 구조 이론 카드
- ZONE D: 재료 구조 전략 도구 (고위험 재료 테이블, 대체 구조 설계 패널, 기존 재료 관리 기능)

### 3. `app.py` (수정)
- 사이드바 라벨 변경: "재료 구조 설계실" → "재료 구조 설계실 (원가 집중 · 대체재 · 발주 구조)"

---

## ✅ 앱 실행 시 확인 체크리스트

### 라우팅 확인
- [ ] 사이드바 "🔥 가게 설계" → "재료 구조 설계실 (원가 집중 · 대체재 · 발주 구조)" 클릭 → 새 페이지 진입 OK

### 재료 구조 설계실 페이지
- [ ] ZONE A (코치 요약) 정상 표시
  - [ ] 총 재료 수 카드
  - [ ] 원가 TOP3 집중도 카드
  - [ ] 고위험 재료 수 카드
  - [ ] 발주 구조 상태 카드
  - [ ] 판결문 정상 표시
  - [ ] 추천 액션 버튼 정상 동작
- [ ] ZONE B (구조 맵) 정상 표시
  - [ ] 재료 원가 집중도 Pareto 차트
  - [ ] 재료 영향도 테이블
- [ ] ZONE C (사장 학교) 정상 표시
- [ ] ZONE D (설계 도구) 정상 표시
  - [ ] 고위험 재료 테이블 정상 표시
  - [ ] 필터 동작 (전체/원가 비중 순/연결 메뉴 수 순)
  - [ ] 대체 가능 여부 toggle 동작
  - [ ] 발주 유형 selectbox 동작
  - [ ] 대체 구조 설계 패널 정상 동작
  - [ ] 기존 재료 관리 기능 정상 동작

### 재료 구조 분석 기능
- [ ] 재료 사용금액 정상 계산 (판매량 데이터 기반)
- [ ] 원가 집중도 정상 계산
- [ ] 고위험 재료 자동 판별
- [ ] 발주 구조 상태 정상 판정

---

## 🎯 기대 동작

### 사용자 경험
1. **전략 관점**: 단순 재료 등록이 아닌 원가 리스크 구조 설계
2. **위험 진단**: 원가 집중도와 고위험 재료를 한눈에 파악
3. **대체 구조 설계**: 고위험 재료의 대체재와 전략 메모 작성
4. **CTA 연결**: 문제 발견 시 바로 해당 설계실로 이동

### 코드 안정성
- 기존 재료 등록/수정/삭제 기능 그대로 유지
- session_state 기반 저장 (DB 스키마 변경 없음)
- store_id 기준 key 분리로 충돌 방지

---

## 📌 참고사항

### 재료 사용금액 계산
- **계산식**: daily_sales_items × recipes × ingredients.unit_cost
- **데이터 소스**:
  - `daily_sales_items_effective.csv`: 판매량 데이터
  - `recipes.csv`: 레시피 (메뉴-재료 연결)
  - `ingredient_master.csv`: 재료 단가
- **판매량 데이터 없을 경우**: 레시피 기반으로만 계산 (기본값 1)

### 원가 집중도 계산
- **TOP3 집중도**: 상위 3개 재료 사용금액 합 ÷ 전체 재료 사용금액 × 100
- **기준**: 70% 이상 위험, 50% 이상 주의

### 고위험 재료 판별
- **기준**: 원가 비중 상위 20% AND 연결 메뉴 수 3개 이상
- **위험 사유**: 자동 생성 (원가 비중 %, 연결 메뉴 수)

### 발주 구조 상태 판정
- **안전**: 발주 단위 설정률 80% 이상
- **주의**: 발주 단위 설정률 50~79%
- **위험**: 발주 단위 설정률 50% 미만 또는 재료 없음

### 포트폴리오 판결 로직
- **우선순위**:
  1. TOP3 집중도 70% 이상 → 매우 취약
  2. 고위험 재료 존재 → 구조 리스크
  3. TOP3 집중도 50% 이상 → 대체 구조 검토
  4. 그 외 → 비교적 안정

---

## 🚀 배포 준비

모든 수정이 완료되었습니다. 다음 단계:
1. ✅ 앱 재시작
2. ✅ "재료 구조 설계실 (원가 집중 · 대체재 · 발주 구조)" 메뉴 클릭 → 새 페이지 진입 확인
3. ✅ 재료 구조 분석 기능 정상 동작 확인
4. ✅ 고위험 재료 테이블에서 대체 가능 여부/발주 유형 설정 동작 확인
5. ✅ 대체 구조 설계 패널에서 메모 작성 동작 확인

---

## 📊 작업 요약

| 항목 | 상태 | 비고 |
|------|------|------|
| 재료 구조 헬퍼 함수 생성 | ✅ 완료 | ingredient_structure_helpers.py |
| ZONE A 재료 구조 코치 요약 | ✅ 완료 | 4개 카드 + 판결문 |
| ZONE B 재료 구조 맵 | ✅ 완료 | Pareto 차트 + 영향도 테이블 |
| ZONE C 재료 구조 이론 | ✅ 완료 | 3개 카드 |
| ZONE D 고위험 재료 테이블 | ✅ 완료 | 필터 3가지 |
| ZONE D 대체 구조 설계 패널 | ✅ 완료 | 메모 작성 (session_state) |
| 기존 재료 관리 기능 유지 | ✅ 완료 | 하단 유지 |
| 사이드바 라벨 변경 | ✅ 완료 | app.py |

---

## ✅ 최종 확인

- [x] 재료 구조 헬퍼 함수 생성 완료
- [x] ZONE A/B/C 재료 구조 관점으로 업그레이드 완료
- [x] ZONE D 고위험 재료 테이블 추가 완료
- [x] ZONE D 대체 구조 설계 패널 추가 완료
- [x] 기존 재료 관리 기능 유지 완료
- [x] 사이드바 라벨 변경 완료
- [ ] 앱 실행 및 동작 확인 (사용자 확인 필요)

**참고**: 
- 재료 구조 분석은 판매량 데이터 기반으로 계산됩니다 (판매량 데이터 없으면 레시피만 고려).
- 고위험 재료 정보와 대체 구조 메모는 session_state로 저장됩니다 (DB 저장은 다음 단계).
- 발주 구조 상태는 발주 단위 설정률로 판정됩니다.
