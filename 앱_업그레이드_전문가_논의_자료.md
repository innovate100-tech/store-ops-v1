# 매장 운영 시스템 v1 - 앱 업그레이드 전문가 논의 자료

**작성일**: 2026-01-23  
**목적**: 전문가와 앱 업그레이드 논의를 위한 종합 자료  
**버전**: v1.0

---

## 📋 목차

1. [앱 카테고리 구조](#1-앱-카테고리-구조)
2. [카테고리별 페이지 세부항목](#2-카테고리별-페이지-세부항목)
3. [페이지간 숫자 연계 및 충돌 분석](#3-페이지간-숫자-연계-및-충돌-분석)
4. [코드 및 개발구조](#4-코드-및-개발구조)
5. [데이터 모델 및 스키마](#5-데이터-모델-및-스키마)

---

## 1. 앱 카테고리 구조

앱은 **6개의 주요 카테고리**로 구성되어 있으며, 각 카테고리는 특정 업무 영역을 담당합니다.

### 1.1 🏠 사장 계기판
**목적**: 매장 운영의 핵심 지표를 한눈에 확인

### 1.2 📋 오늘 마감
**목적**: 일일 영업 마감 작업

### 1.3 🛒 운영(내일 장사 준비)
**목적**: 다음 영업일을 위한 발주 및 재고 관리

### 1.4 📊 분석(원인 찾기)
**목적**: 매출, 판매, 원가 등 운영 데이터 분석

### 1.5 🧾 성적표(월간)
**목적**: 월간 목표 설정 및 실제 성과 평가

### 1.6 ⚙️ 관리/보정(예외)
**목적**: 기본 데이터 관리 및 예외 상황 처리

---

## 2. 카테고리별 페이지 세부항목

### 2.1 🏠 사장 계기판

#### 페이지: 홈 (`ui_pages/home/home_page.py`)

**주요 섹션 (9개):**

1. **상단 성장 단계 메시지**
   - DAY1/DAY3/DAY7 단계별 안내
   - 데이터 단계(LEVEL 0~3)에 따른 메시지

2. **상태판**
   - 이번 달 매출 (누적 금액)
   - 마감률 (마감된 일수/전체 일수)
   - 연속 마감 스트릭 (연속 마감 일수)

3. **시작 미션 3개**
   - 미션 1: 메뉴 3개 등록하기
   - 미션 2: 점장마감 3회 하기
   - 미션 3: 이번 달 성적표 1회 만들기
   - 각 미션별 진행률 바 및 완료 보상 문장 표시

4. **핵심 숫자 카드 (4개)**
   - 오늘 매출
   - 이번 달 매출
   - 객단가
   - 이번 달 이익

5. **오늘 하나만 추천**
   - 데이터 단계(LEVEL 0~3)에 따른 추천 액션
   - 자동 코치 모드 활성화 시 "코치의 한 가지 제안"으로 표시

6. **문제 TOP3 / 잘한 점 TOP3**
   - 룰 기반 자동 분석
   - 각 항목별 상세 페이지로 이동 버튼

7. **이상 징후 (조기경보 시스템)**
   - 최대 3개 표시
   - 매출 감소, 마감 누락, 판매량 급감 등 감지

8. **우리 가게 숫자 구조**
   - 고정비, 변동비율, 손익분기점 매출
   - 매출 구간별 예상 이익 테이블
   - 실제정산 또는 목표 비용구조 기준으로 표시

9. **이번 달 운영 메모**
   - daily_close에서 메모 최신 5개 표시

**특징:**
- 데이터 단계(LEVEL 0~3)에 따라 화면 구성 변경
- DAY0 전용 홈 화면 (데이터 없을 때)
- 자동 코치 모드 (미션 3개 완료 시 활성화)
- 사장 단계 판별 (DAY1/DAY3/DAY7)

---

### 2.2 📋 오늘 마감

#### 페이지: 점장 마감 (`ui_pages/manager_close.py`)

**주요 섹션 (4개):**

1. **공식 입력 안내 박스**
   - 점장마감이 공식 기록임을 안내

2. **마감 입력 폼**
   - 날짜 선택
   - 매출 입력 (카드매출, 현금매출, 총매출)
   - 방문자 수 입력
   - 메뉴별 판매량 입력 (동적 메뉴 목록)
   - 특이사항 입력 (issues)
   - 운영 메모 입력 (memo)

3. **기존 마감 확인**
   - 선택한 날짜에 이미 마감 기록이 있는지 확인
   - 판매량 보정(overrides) 존재 여부 경고

4. **마감 완료 후 요약**
   - 총매출, 방문자수, 객단가, 판매 메뉴 수 카드
   - 판매량 TOP 3 메뉴 표시

**특징:**
- 같은 날짜로 다시 입력 시 기존 데이터 자동 업데이트
- 판매량 보정이 있으면 보정값이 최종 적용됨
- 저장 성공 시 풍선 애니메이션 표시

**저장 대상 테이블:**
- `daily_close` (upsert)
- `sales` (upsert)
- `naver_visitors` (upsert)
- `daily_sales_items` (해당 날짜 DELETE 후 INSERT)

---

### 2.3 🛒 운영(내일 장사 준비)

#### 페이지 1: 발주 관리 (`ui_pages/order_management.py`)

**주요 탭 구조 (6개):**

1. **🛡️ 안전재고 등록**
   - 재료별 안전재고 설정
   - 발주단위 및 변환비율 고려
   - `inventory` 테이블에 저장

2. **📦 현재 재고 현황**
   - 재료별 현재고 표시
   - 안전재고 대비 부족 여부 확인
   - `inventory` 테이블 조회/수정

3. **🛒 발주 추천**
   - 재기획 중 (현재 비워둠)

4. **📋 진행 현황**
   - 재기획 중 (현재 비워둠)

5. **🏢 공급업체**
   - 재기획 중 (현재 비워둠)

6. **📊 발주 분석**
   - 재기획 중 (현재 비워둠)

**사용 시점**: 발주가 필요한 시점 (보통 주 1-2회)

---

#### 페이지 2: 재료 사용량 집계 (`ui_pages/ingredient_usage_summary.py`)

**주요 섹션 (3개):**

1. **기간 선택**
   - 시작일/종료일 선택

2. **사용 단가 TOP 10 재료**
   - 순위, 재료명, 총 사용량, 총 사용단가, 비율, 누적 비율, ABC 등급

3. **전체 재료 사용 단가 순위 (ABC 분석)**
   - 모든 재료의 사용 단가 순위표
   - ABC 등급별 통계 (A/B/C 등급별 재료 수, 총 사용단가, 비율 합계)

**계산 로직:**
- 판매량(`daily_sales_items`) × 레시피(`recipes`) = 재료 사용량
- 재료 사용량 × 재료 단가 = 재료 사용 단가
- ABC 분석: A등급(상위 70%), B등급(70-90%), C등급(90% 이상)

**사용 시점**: 발주 전 재료 소비량 확인 시

---

### 2.4 📊 분석(원인 찾기)

#### 페이지 1: 통합 대시보드 (`ui_pages/dashboard/dashboard.py`)

**주요 섹션 (4개):**

1. **진단 정보**
   - 데이터 로드 상태 확인

2. **손익분기 섹션**
   - 손익분기 매출 분석
   - 고정비, 변동비율, 손익분기점 매출 계산

3. **매출 섹션**
   - 매출 트렌드 및 분석
   - 날짜별 매출 추이 차트

4. **메뉴 섹션**
   - 메뉴별 성과 분석
   - 메뉴별 매출, 판매량, 원가율

**특징:**
- 모듈화된 구조 (context, data_loaders, metrics, sections)
- 성능 측정 기능 포함

---

#### 페이지 2: 매출 관리 (`ui_pages/sales_management.py`)

**주요 섹션 (10개):**

1. **이번달 요약 (KPI 카드)**
   - 이번달 누적 매출, 평균 일일 매출
   - 이번달 총 방문자, 평균 객단가
   - 목표 달성률

2. **기간별 비교 분석**
   - 전월 대비 (매출, 방문자 변화율)
   - 작년 동월 대비
   - 주간 비교 (이번 주 vs 지난 주)

3. **요일별 패턴 분석**
   - 요일별 평균매출, 총매출, 평균방문자, 객단가
   - 최고/최저 요일 표시

4. **목표 달성 현황**
   - 목표 매출, 현재 누적 매출
   - 일평균 목표/실적
   - 예상 월 매출 및 달성률
   - 남은 일수 기준 필요 일평균

5. **매출 트렌드**
   - 최근 7일 vs 최근 30일 평균 비교
   - 트렌드 변화율

6. **알림 및 경고**
   - 목표 대비 저조한 날짜
   - 전일 대비 급락
   - 연속 저조일
   - 월말 목표 달성 위험

7. **월별 요약 (최근 6개월)**
   - 월별 영업일수, 월총매출, 일평균매출
   - 월총방문자, 월별객단가, 전월대비 성장률

8. **예상 매출 및 목표 달성 가능성**
   - 이번달 예상 총 매출
   - 예상 목표 달성률
   - 필요 일평균

9. **저장된 매출 내역**
   - 날짜, 매장, 카드매출, 현금매출, 총매출, 방문자수 표시

10. **이달 일일 매출과 방문자 사이의 연관성**
    - 상관계수 계산 (피어슨 상관계수)
    - 상관관계 해석 (강한 양의 상관관계 등)
    - 일일 매출/방문자수 표

**특징:**
- SSOT 함수(`load_monthly_sales_total`) 사용으로 데이터 일관성 유지
- 매출 새로고침 버튼으로 캐시 무효화 가능

---

#### 페이지 3: 판매 관리 (`ui_pages/sales_analysis.py`)

**주요 섹션 (8개):**

1. **분석 기간 선택**
   - 시작일/종료일 선택

2. **기간 내 요약 (KPI 카드)**
   - 총 판매량, 총 매출, 총 원가, 총 이익
   - 일평균 판매량

3. **판매 ABC 분석**
   - 메뉴별 매출 비율 및 누계 비율
   - ABC 등급 부여 (A: 상위 70%, B: 70-90%, C: 90% 이상)
   - 원가, 총판매원가, 이익, 이익률, 원가율 표시

4. **인기 메뉴 TOP 10**
   - 순위, 메뉴명, 판매수량, 매출, 비율, ABC 등급

5. **수익성 분석**
   - 최고 수익성 메뉴 (이익률 기준 TOP 5)
   - 저수익성 메뉴 (이익률 30% 미만)

6. **판매 트렌드 분석**
   - 최근 7일 vs 최근 30일 평균 판매량 비교
   - 일별 판매량 추이 표

7. **요일별 인기 메뉴**
   - 요일별 TOP 3 메뉴 표시

8. **메뉴별 성장률 분석**
   - 기간을 반으로 나눠 전반기/후반기 비교
   - 성장률 TOP 10 메뉴

**계산 로직:**
- 판매량 × 판매가 = 매출
- 매출 - 원가 = 공헌이익
- 원가 = 레시피 사용량 × 재료 단가 합계

---

#### 페이지 4: 원가 파악 (`ui_pages/cost_overview.py`)

**주요 기능:**

1. **메뉴별 원가 계산**
   - 메뉴, 레시피, 재료 데이터 기반 원가 계산
   - 원가 = 레시피 사용량 × 재료 단가 합계

2. **원가율 분석**
   - 원가율 = (원가 ÷ 판매가) × 100
   - 원가율 순위 정렬

3. **원가 경고**
   - 원가율 35% 이상 메뉴 표시

**데이터 요구사항:**
- 메뉴 마스터 (메뉴명, 판매가)
- 레시피 (메뉴명, 재료명, 사용량)
- 재료 마스터 (재료명, 단위, 단가)

---

### 2.5 🧾 성적표(월간)

#### 페이지 1: 목표 비용구조 (`ui_pages/target_cost_structure.py`)

**주요 섹션 (3개):**

1. **기간 선택 및 전월 데이터 복사**
   - 연도/월 선택
   - 전월 데이터 복사 버튼

2. **손익분기점 계산 및 상단 표시**
   - 고정비, 변동비율, 손익분기점 매출 자동 계산
   - 목표 매출 설정

3. **비용 항목 입력 (5개 카테고리)**
   - **임차료**: 고정비 (금액 직접 입력)
   - **인건비**: 고정비 (금액 직접 입력)
   - **재료비**: 변동비 (매출 대비 비율 입력)
   - **공과금**: 고정비 (금액 직접 입력)
   - **부가세&카드수수료**: 변동비 (매출 대비 비율 입력)
   - 각 항목별 금액 또는 비율 입력
   - 항목 추가/수정/삭제

**계산 공식:**
- 손익분기점 매출 = 고정비 ÷ (1 - 변동비율)
- 고정비 = 임차료 + 인건비 + 공과금
- 변동비율 = 재료비율 + 부가세&카드수수료율

**저장 대상:**
- `expense_structure` 테이블

---

#### 페이지 2: 목표 매출구조 (`ui_pages/target_sales_structure.py`)

**주요 섹션 (1개):**

1. **매출 수준별 비용·영업이익 시뮬레이션**
   - 목표 매출 기준 ±500만원, ±1,000만원, ±1,500만원 시나리오
   - 각 시나리오별:
     - 매출
     - 비용 합계 및 세부내역
     - 추정 영업이익
   - 5대 비용 세부 계산:
     - 임차료 (고정비)
     - 인건비 (고정비)
     - 공과금 (고정비)
     - 재료비 (매출 × 재료비율)
     - 부가세&카드수수료 (매출 × 부가세&카드수수료율)

**계산 기반:**
- 목표 비용구조 페이지의 고정비/변동비율 기반 계산
- 목표 매출 설정 필요 (`targets` 테이블)

---

#### 페이지 3: 실제정산 (`ui_pages/settlement_actual.py`)

**주요 섹션 (5개):**

1. **기간 선택**
   - 연도/월 선택

2. **정산 상태 관리**
   - draft/final 상태 설정
   - 이전 달 데이터 복사

3. **비용 항목 입력 (5개 카테고리)**
   - 템플릿 기반 비용 항목 자동 로드
   - 카테고리별 입력:
     - 임차료
     - 인건비
     - 재료비
     - 공과금
     - 부가세&카드수수료
   - 입력 타입: 금액(amount) 또는 비율(rate)
   - 항목별 금액/비율 입력

4. **자동 계산**
   - 고정비 합계
   - 변동비 계산 (매출 × 변동비율)
   - 총 비용 계산
   - 손익 계산 (매출 - 총 비용)

5. **템플릿 관리**
   - 비용 항목 템플릿 저장/로드
   - 템플릿 추가/수정/삭제

**저장 대상:**
- `actual_settlement_items` 테이블
- `cost_item_templates` 테이블

**특징:**
- 템플릿 기반 구조로 입력 편의성 향상
- draft/final 상태 관리로 정산 진행 상황 추적
- 저장된 값 자동 복원 기능

---

#### 페이지 4: 주간 리포트 (`ui_pages/weekly_report.py`)

**주요 섹션 (2개):**

1. **리포트 입력 폼**
   - 시작일/종료일 선택

2. **리포트 생성**
   - PDF 형식으로 리포트 생성
   - 포함 내용:
     - 총매출, 일평균 매출
     - 방문자수 총합, 일평균
     - 매출 vs 방문자 추세 차트
     - 메뉴별 판매 TOP 10
     - 재료 사용량 TOP 10
     - 발주 추천 TOP 10
   - 생성된 리포트 목록 (최근 10개)
   - 파일명, 크기, 생성일시
   - PDF 다운로드 버튼

---

### 2.6 ⚙️ 관리/보정(예외)

#### 페이지 1: 매출 보정 (`ui_pages/sales_entry.py`)

**주요 섹션 (4개):**

1. **보정 도구 안내**
   - 일반적인 매출 입력은 점장마감 사용 안내

2. **매출 입력**
   - 단일 입력 또는 일괄 입력 모드
   - 날짜, 매장, 카드매출, 현금매출, 총매출 입력

3. **방문자 수 입력**
   - 단일 입력 또는 일괄 입력 모드
   - 날짜, 방문자수 입력

4. **저장 결과 표시**
   - 성공/경고 메시지 표시
   - 저장된 데이터 요약

**저장 대상:**
- `sales` 테이블 (upsert)
- `naver_visitors` 테이블 (upsert, 방문자 탭에서만)
- **주의**: `daily_close`, `daily_sales_items`는 건드리지 않음

---

#### 페이지 2: 판매량 보정 (`ui_pages/sales_volume_entry.py`)

**주요 섹션 (2개):**

1. **보정 도구 안내**
   - 점장마감 이후 판매량 수정용 안내

2. **일일 판매 입력 (전 메뉴 일괄 입력)**
   - 판매 날짜 선택
   - 마감 존재 여부 확인 및 안내
   - 모든 메뉴의 판매 수량을 3열 그리드로 한 번에 입력
   - 0은 미판매로 처리
   - 판매량 보정 저장 (점장마감 판매량보다 우선 적용)

**저장 대상:**
- `daily_sales_items` 테이블
- **주의**: 기존 (날짜, 메뉴) 있으면 qty에 누적, 없으면 insert

**특징:**
- 점장마감보다 우선 적용되는 보정 기능
- 마감된 날짜에도 수정 가능
- 일괄 입력으로 효율적인 보정 작업

---

#### 페이지 3: 메뉴 등록 (`ui_pages/menu_management.py`)

**주요 섹션 (3개):**

1. **입력 모드 선택**
   - 단일 입력 / 일괄 입력

2. **메뉴 입력 폼**
   - 메뉴명, 판매가 입력
   - 일괄 입력 시 여러 메뉴 동시 입력 (최대 개수 설정 가능)

3. **메뉴 목록 및 관리**
   - 등록된 메뉴 목록 표시
   - 메뉴 수정/삭제 기능
   - 메뉴 카테고리 관리

**저장 대상:**
- `menu_master` 테이블

---

#### 페이지 4: 재료 등록 (`ui_pages/ingredient_management.py`)

**주요 섹션 (3개):**

1. **재료 입력 폼**
   - 재료명, 단위, 단가 입력
   - 발주단위 및 변환비율 설정 (발주 시 사용)

2. **재료 목록 및 관리**
   - 등록된 재료 목록 표시
   - 재료 수정/삭제 기능

3. **진단 기능** (개발 모드)
   - DB 연결 상태 확인
   - 쿼리 실행 결과 확인

**저장 대상:**
- `ingredients` 테이블

---

#### 페이지 5: 레시피 등록 (`app.py` 내장)

**주요 섹션 (2개):**

1. **레시피 일괄 등록**
   - 메뉴 선택
   - 등록할 재료 개수 선택 (최대 30개)
   - 재료명 검색 기능
   - 재료별 사용량 입력
   - 조리방법 입력 (줄글로 입력)
   - 일괄 저장

2. **레시피 검색 및 수정**
   - 메뉴별 레시피 조회
   - 메뉴 정보 카드 (판매가, 원가, 원가율)
   - 구성 재료 및 사용량 테이블
   - 조리방법 표시
   - 재료별 사용량 수정/삭제

**저장 대상:**
- `recipes` 테이블

---

#### 페이지 6: 직원 연락망 (`ui_pages/staff_contacts.py`)

**주요 섹션 (2개):**

1. **직원 추가**
   - 이름, 역할, 연락처 입력

2. **직원 목록**
   - 등록된 직원 정보 표시 및 수정/삭제

**특징:**
- 임시 세션 상태 기반 (추후 DB 연결 예정)

---

#### 페이지 7: 협력사 연락망 (`ui_pages/vendor_contacts.py`)

**주요 섹션 (2개):**

1. **협력사 추가**
   - 업체명, 담당자, 연락처, 유형(재료 공급/배달/기타), 메모 입력

2. **협력사 목록**
   - 등록된 협력사 정보 표시 및 수정/삭제

**특징:**
- 임시 세션 상태 기반 (추후 DB 연결 예정)
- 업체 유형별 분류

---

#### 페이지 8: 게시판 (`ui_pages/board.py`)

**주요 섹션 (3개):**

1. **게시글 작성**
   - 제목, 내용 입력

2. **게시글 목록**
   - 작성자, 작성일시, 제목, 내용 표시

3. **게시글 수정/삭제**
   - 각 게시글별 수정/삭제 기능

**특징:**
- 임시 세션 상태 기반 (추후 DB 연결 예정)
- 내부 커뮤니케이션 용도

---

## 3. 페이지간 숫자 연계 및 충돌 분석

### 3.1 데이터 흐름 체인

#### 체인 1: 마스터 데이터 체인 (초기 설정, 변경 시 업데이트)

```
재료 등록 (🥬)
    ↓ [재료명, 단위, 단가, 발주단위, 변환비율]
메뉴 등록 (🍽️)
    ↓ [메뉴명, 판매가]
레시피 등록 (📝)
    ↓ [메뉴명 + 재료명 + 사용량] 매핑
원가 파악 (💰)
    ↓ [메뉴별 원가, 원가율 계산]
```

**숫자 연동:**
- 재료 단가 × 레시피 사용량 = 메뉴 원가
- 메뉴 원가 ÷ 판매가 × 100 = 원가율

---

#### 체인 2: 일일 운영 데이터 체인 (매일 사용)

```
점장 마감 (📋) 또는 매출 등록 (💰)
    ↓ [날짜별 매출, 방문자수]
    ↓ [메뉴별 판매수량] → daily_sales_items
판매량 등록 (📦) [선택적]
    ↓ [추가 판매량 데이터]
재료 사용량 집계 (📈)
    ↓ [daily_sales_items × recipes] 계산
    ↓ [재료별 총 사용량, 총 사용단가]
발주 관리 (🛒)
    ↓ [재료 사용량 + 현재고 + 안전재고]
    ↓ [발주 추천, 발주 분석]
```

**숫자 연동:**
- 메뉴 판매수량 × 레시피 사용량 = 재료 사용량
- 재료 사용량 × 재료 단가 = 재료 사용 단가
- 현재고 - 예상 사용량 < 안전재고 → 발주 필요
- 발주 수량 = 안전재고 + 예상 사용량 - 현재고

---

#### 체인 3: 분석 및 대시보드 체인 (주기적 조회)

```
매출 관리 (📊)
    ↓ [sales 데이터 분석]
판매 관리 (📦)
    ↓ [daily_sales_items + menu_master 분석]
    ↓ [ABC 분석, 메뉴별 성과]
통합 대시보드 (📊)
    ↓ [모든 데이터 통합 분석]
    ↓ [손익분기점, 매출 추이, 메뉴 성과]
```

**숫자 연동:**
- 매출 = 판매수량 × 판매가
- 공헌이익 = 매출 - 원가
- 손익분기점 매출 = 고정비 ÷ (1 - 변동비율)

---

#### 체인 4: 재무 계획 및 정산 체인 (월 1-2회)

```
목표 비용구조 (💳)
    ↓ [월별 목표 비용 항목 설정]
    ↓ [임차료, 인건비, 재료비, 공과금, 부가세&카드수수료]
목표 매출구조 (📈)
    ↓ [목표 비용구조 기반]
    ↓ [손익분기점 매출, 목표 매출 계산]
실제정산 (🧾)
    ↓ [목표 비용구조 + 목표 매출구조]
    ↓ [실제 매출 (sales) + 실제 비용 입력]
    ↓ [목표 vs 실제 비교 분석]
```

**숫자 연동:**
- 손익분기점 매출 = 고정비 ÷ (1 - 변동비율)
- 목표 매출 = 손익분기점 매출 × 목표 마진율
- 목표 대비 달성률 = (실제 매출 ÷ 목표 매출) × 100
- 목표 대비 비용 차이 = 실제 비용 - 목표 비용
- 순이익 = 실제 매출 - 실제 비용

---

### 3.2 주요 충돌 지점

#### 충돌 1: 매출 데이터 (sales) / daily_close

| 상황 | 결과 | 비고 |
|------|------|------|
| 마감보고만 사용 | ✅ daily_close = sales, 일치 | 정상 |
| 매출 등록만 사용 | ✅ sales만 갱신, daily_close 없음 | 매출 분석 등은 sales 기준으로 동작 |
| **마감보고 후 매출 등록** | ⚠️ **sales만 덮어씀, daily_close는 그대로** | **sales ≠ daily_close** 불일치 |
| 매출 등록 후 마감보고 | ✅ 마감보고가 sales 다시 upsert | 마감보고 값이 최종, 일치 |

**문제점:**
- 매출 등록은 `daily_close`를 절대 수정하지 않음
- 마감보고로 넣은 "공식" 매출과, 매출 등록으로 나중에 수정한 `sales`가 같은 날짜에 공존하면 숫자 불일치 발생

---

#### 충돌 2: 방문자 데이터 (naver_visitors)

| 상황 | 결과 | 비고 |
|------|------|------|
| 마감보고만 / 매출 등록(방문자)만 | ✅ 각자 upsert, 일치 | 정상 |
| **같은 날짜에 둘 다 입력** | ⚠️ **나중에 저장한 쪽이 최종** | upsert라 덮어쓰기, 충돌 아닌 대체 |

**문제점:**
- 논리적 "충돌"이라기보다 저장 순서에 따라 값이 바뀜
- 같은 날 마감보고와 매출 등록(방문자)를 둘 다 쓰면, 의도치 않게 나중 입력이 이전 입력을 덮어씀 가능

---

#### 충돌 3: 판매량 데이터 (daily_sales_items) — **가장 큰 충돌**

| 상황 | 결과 | 비고 |
|------|------|------|
| 마감보고만 사용 | ✅ 해당일 `daily_sales_items` = 마감 입력분 | 정상 |
| 판매량 등록만 사용 | ✅ 메뉴별 누적만 반영 | 정상 |
| **마감보고 후 판매량 등록** | ✅ 마감 입력 + **추가분 누적** | "보완 입력" 용도로는 의도대로 동작 |
| **판매량 등록 후 마감보고** | 🚨 **해당 날짜 daily_sales_items 전부 DELETE 후 INSERT** | **판매량 등록분 전부 삭제**, 마감보고 입력분만 남음 |

**문제점:**
- 마감보고 트랜잭션은 해당 (store_id, date)의 `daily_sales_items`를 전부 지운 뒤, `sales_items` JSONB만 넣음
- 같은 날짜에 판매량 등록으로 먼저 넣어둔 데이터가 있으면, 마감보고 저장 시 전부 삭제되고, 마감보고에 입력한 메뉴/수량만 남음
- 재료 사용량 집계·발주·판매 분석 등은 모두 `daily_sales_items`를 쓰므로, "판매량 등록만 하고 마감은 안 했다"가 나중에 "마감만 했다"로 바뀌면, 이전 판매량 등록분이 사라져 숫자가 틀어짐

---

### 3.3 권장 사용 흐름 (충돌 최소화)

1. **일일 매출·방문자·판매량을 한 번에 넣을 때**
   → **마감보고(점장 마감)만** 사용
   - `daily_close` + `sales` + `naver_visitors` + `daily_sales_items`가 한 트랜잭션으로 맞게 저장됨

2. **매출만 따로 수정·추가할 때**
   - 해당 날짜에 마감보고를 이미 했다면
     → 매출 등록으로 `sales`를 바꿔도 `daily_close`는 안 바뀌어 불일치 발생
     → 가능하면 마감보고에서 같은 날짜로 다시 저장하는 쪽 권장
   - 아직 마감보고를 안 한 날이면
     → 매출 등록만 써도 됨 (이후 마감보고 시 sales가 한 번 더 upsert됨)

3. **판매량만 추가·수정할 때**
   - 해당 날짜 마감보고를 이미 했다
     → 판매량 등록으로 누적만 하면 됨. 마감보고 데이터는 유지되고, 추가분만 더해짐
   - 해당 날짜 마감보고를 아직 안 했다
     → 판매량 등록 먼저 한 뒤, 같은 날 마감보고를 하면
     → 방금 넣은 판매량이 전부 삭제되므로,
     → 반드시 "마감보고 먼저 → 부족분만 판매량 등록" 순서 권장

4. **방문자만 넣을 때**
   - 마감보고 / 매출 등록(방문자) 둘 다 `naver_visitors`를 upsert하므로,
     → 같은 날짜에 한쪽만 쓰는 것이 안전
     → 이미 마감보고에 방문자까지 넣는 루틴이 있으면, 방문자만 따로 매출 등록에서 넣는 경우를 줄이는 것이 좋음

---

### 3.4 숫자 연동 포인트 요약

1. **원가 계산**: 재료 단가 × 레시피 사용량 = 메뉴 원가
2. **재료 사용량**: 메뉴 판매수량 × 레시피 사용량 = 재료 사용량
3. **발주 계산**: 현재고 - 예상 사용량 < 안전재고 → 발주 필요
4. **손익분기점**: 고정비 ÷ (1 - 변동비율) = 손익분기점 매출
5. **목표 대비 달성률**: (실제 매출 ÷ 목표 매출) × 100
6. **공헌이익**: 매출 - 원가
7. **원가율**: (원가 ÷ 판매가) × 100

---

## 4. 코드 및 개발구조

### 4.1 프로젝트 구조

```
store_ops_v1/
├── app.py                    # 메인 Streamlit 앱 (라우팅, 사이드바)
├── requirements.txt          # 필요한 패키지 목록
├── README.md                 # 프로젝트 설명
├── sql/                      # 데이터베이스 스키마 및 SQL
│   ├── schema.sql            # 메인 스키마 (모든 테이블 정의)
│   ├── schema_expense_structure.sql
│   └── ...
├── ui_pages/                 # 페이지 모듈
│   ├── __init__.py
│   ├── home/                 # 홈 페이지 모듈화
│   │   ├── home_page.py
│   │   ├── home_data.py
│   │   ├── home_components.py
│   │   └── ...
│   ├── dashboard/            # 대시보드 모듈화
│   │   ├── dashboard.py
│   │   ├── context.py
│   │   ├── data_loaders.py
│   │   ├── metrics.py
│   │   └── sections.py
│   ├── manager_close.py      # 점장 마감
│   ├── sales_entry.py        # 매출 보정
│   ├── sales_volume_entry.py # 판매량 보정
│   ├── sales_management.py   # 매출 관리
│   ├── sales_analysis.py     # 판매 관리
│   ├── cost_overview.py      # 원가 파악
│   ├── menu_management.py    # 메뉴 등록
│   ├── ingredient_management.py # 재료 등록
│   ├── ingredient_usage_summary.py # 재료 사용량 집계
│   ├── order_management.py   # 발주 관리
│   ├── target_cost_structure.py # 목표 비용구조
│   ├── target_sales_structure.py # 목표 매출구조
│   ├── settlement_actual.py  # 실제정산
│   ├── weekly_report.py      # 주간 리포트
│   └── ...
├── src/                      # 소스 코드 모듈
│   ├── __init__.py
│   ├── auth.py               # 인증 (Supabase Auth)
│   ├── bootstrap.py          # 앱 초기화
│   ├── storage_supabase.py   # Supabase 데이터 저장/로드
│   ├── analytics.py          # 분석 함수 (상관계수, 원가 계산 등)
│   ├── order_service.py      # 발주 서비스 로직
│   ├── order_ui.py           # 발주 UI 컴포넌트
│   ├── reporting.py          # 리포트 생성 모듈
│   ├── pdf_charts.py         # PDF 차트 생성
│   ├── pdf_scorecard_mvp.py  # PDF 성적표 생성
│   ├── ui.py                 # UI 컴포넌트
│   ├── ui_helpers.py         # UI 헬퍼 함수
│   ├── ui/                   # UI 모듈
│   │   ├── theme_manager.py  # 테마 관리
│   │   ├── common_header.py  # 공통 헤더
│   │   └── ...
│   └── utils/                # 유틸리티
│       ├── time_utils.py
│       ├── cache_tokens.py
│       └── ...
└── archive/                  # 아카이브 (구버전 코드)
```

---

### 4.2 기술 스택

- **프론트엔드**: Streamlit (Python 웹 프레임워크)
- **백엔드**: Supabase (PostgreSQL + Auth)
- **데이터 처리**: pandas, numpy
- **시각화**: matplotlib, plotly
- **PDF 생성**: reportlab
- **언어**: Python 3.11+

---

### 4.3 주요 모듈 설명

#### `app.py` (메인 앱)
- **역할**: Streamlit 앱 진입점, 라우팅, 사이드바 메뉴
- **주요 기능**:
  - 인증 체크
  - 온보딩 모드 체크
  - 사이드바 메뉴 렌더링
  - 페이지 라우팅
- **라인 수**: ~4,000+ 라인 (리팩토링 필요)

#### `src/storage_supabase.py`
- **역할**: Supabase 데이터 저장/로드 함수
- **주요 함수**:
  - `load_csv()`: 테이블 데이터 로드 (캐시 적용)
  - `save_sales()`: 매출 저장
  - `save_daily_close()`: 일일 마감 저장
  - `save_expense_item()`: 비용 항목 저장
  - 등등...

#### `src/analytics.py`
- **역할**: 분석 함수 모음
- **주요 함수**:
  - `calculate_correlation()`: 상관계수 계산
  - `calculate_menu_cost()`: 메뉴 원가 계산
  - `calculate_ingredient_usage()`: 재료 사용량 계산

#### `src/auth.py`
- **역할**: 인증 및 권한 관리
- **주요 함수**:
  - `check_login()`: 로그인 체크
  - `get_current_store_id()`: 현재 매장 ID 조회
  - `get_user_stores()`: 사용자 매장 목록 조회

---

### 4.4 개발 패턴

#### 데이터 로딩 패턴
- `@st.cache_data(ttl=60)` 데코레이터 사용
- TTL(Time To Live) 60초로 캐시 관리
- `load_csv()` 함수로 통일된 데이터 로딩

#### 페이지 렌더링 패턴
- 각 페이지는 `render_*()` 함수로 구현
- `app.py`에서 라우팅하여 호출

#### 상태 관리
- Streamlit의 `st.session_state` 사용
- 페이지 간 상태 공유

---

### 4.5 코드 품질 이슈

#### 리팩토링 필요 파일
1. **app.py** (~4,000+ 라인)
   - 진단 기능 분리 필요
   - 라우팅만 남기기

2. **settlement_actual.py** (~1,500+ 라인)
   - 헬퍼 함수들이 너무 많음
   - 데이터 로더, 진단, 상태 관리 분리 필요

3. **target_cost_structure.py** (~900+ 라인)
   - 계산 로직과 UI 폼 분리 필요

4. **sales_management.py** (~600+ 라인)
   - 섹션별 UI 분리 가능

---

## 5. 데이터 모델 및 스키마

### 5.1 핵심 엔티티 관계도

```
stores (매장)
  ├── user_profiles (사용자-매장 연결)
  │
  ├── sales (일별 매출)
  ├── naver_visitors (일별 방문자)
  ├── daily_close (일별 마감 통합)
  │
  ├── menu_master (메뉴)
  │   ├── recipes (레시피) → ingredients (재료)
  │   └── daily_sales_items (일별 판매 내역)
  │
  ├── ingredients (재료)
  │   └── inventory (재고)
  │
  ├── targets (목표 매출/비용)
  ├── expense_structure (월별 비용 구조)
  ├── actual_settlement_items (월별 실제 정산 항목)
  ├── cost_item_templates (비용 항목 템플릿)
  └── abc_history (ABC 분석 히스토리)
```

---

### 5.2 주요 테이블 상세

#### stores (매장)
```sql
CREATE TABLE stores (
    id UUID PRIMARY KEY,
    name TEXT NOT NULL,
    created_at TIMESTAMPTZ,
    updated_at TIMESTAMPTZ
);
```

#### sales (매출)
```sql
CREATE TABLE sales (
    id UUID PRIMARY KEY,
    store_id UUID REFERENCES stores(id),
    date DATE NOT NULL,
    card_sales NUMERIC(12, 0) DEFAULT 0,
    cash_sales NUMERIC(12, 0) DEFAULT 0,
    total_sales NUMERIC(12, 0) NOT NULL,
    UNIQUE(store_id, date)
);
```

#### daily_close (일일 마감)
```sql
CREATE TABLE daily_close (
    id UUID PRIMARY KEY,
    store_id UUID REFERENCES stores(id),
    date DATE NOT NULL,
    card_sales NUMERIC(12, 0) DEFAULT 0,
    cash_sales NUMERIC(12, 0) DEFAULT 0,
    total_sales NUMERIC(12, 0) DEFAULT 0,
    visitors INTEGER DEFAULT 0,
    sales_items JSONB,  -- 메뉴별 판매량
    memo TEXT,
    UNIQUE(store_id, date)
);
```

#### daily_sales_items (일일 판매 내역)
```sql
CREATE TABLE daily_sales_items (
    id UUID PRIMARY KEY,
    store_id UUID REFERENCES stores(id),
    date DATE NOT NULL,
    menu_id UUID REFERENCES menu_master(id),
    qty INTEGER NOT NULL DEFAULT 0,
    UNIQUE(store_id, date, menu_id)
);
```

#### menu_master (메뉴 마스터)
```sql
CREATE TABLE menu_master (
    id UUID PRIMARY KEY,
    store_id UUID REFERENCES stores(id),
    name TEXT NOT NULL,
    price NUMERIC(10, 0) NOT NULL,
    UNIQUE(store_id, name)
);
```

#### ingredients (재료 마스터)
```sql
CREATE TABLE ingredients (
    id UUID PRIMARY KEY,
    store_id UUID REFERENCES stores(id),
    name TEXT NOT NULL,
    unit TEXT NOT NULL,
    unit_cost NUMERIC(10, 2) NOT NULL,
    UNIQUE(store_id, name)
);
```

#### recipes (레시피)
```sql
CREATE TABLE recipes (
    id UUID PRIMARY KEY,
    store_id UUID REFERENCES stores(id),
    menu_id UUID REFERENCES menu_master(id),
    ingredient_id UUID REFERENCES ingredients(id),
    qty NUMERIC(10, 2) NOT NULL,
    UNIQUE(store_id, menu_id, ingredient_id)
);
```

#### inventory (재고)
```sql
CREATE TABLE inventory (
    id UUID PRIMARY KEY,
    store_id UUID REFERENCES stores(id),
    ingredient_id UUID REFERENCES ingredients(id),
    on_hand NUMERIC(10, 2) DEFAULT 0,
    safety_stock NUMERIC(10, 2) DEFAULT 0,
    UNIQUE(store_id, ingredient_id)
);
```

#### expense_structure (비용 구조)
```sql
CREATE TABLE expense_structure (
    id UUID PRIMARY KEY,
    store_id UUID REFERENCES stores(id),
    year INTEGER NOT NULL,
    month INTEGER NOT NULL CHECK (month >= 1 AND month <= 12),
    category TEXT NOT NULL CHECK (category IN ('임차료', '재료비', '인건비', '공과금', '부가세&카드수수료')),
    item_name TEXT NOT NULL,
    amount NUMERIC(12, 2) NOT NULL DEFAULT 0,
    notes TEXT,
    UNIQUE(store_id, year, month, category, item_name)
);
```

#### targets (목표)
```sql
CREATE TABLE targets (
    id UUID PRIMARY KEY,
    store_id UUID REFERENCES stores(id),
    year INTEGER NOT NULL,
    month INTEGER NOT NULL CHECK (month >= 1 AND month <= 12),
    target_sales NUMERIC(12, 0) DEFAULT 0,
    UNIQUE(store_id, year, month)
);
```

#### actual_settlement_items (실제 정산 항목)
```sql
CREATE TABLE actual_settlement_items (
    id UUID PRIMARY KEY,
    store_id UUID REFERENCES stores(id),
    year INTEGER NOT NULL,
    month INTEGER NOT NULL,
    category TEXT NOT NULL,
    item_name TEXT NOT NULL,
    amount NUMERIC(12, 2),
    rate NUMERIC(5, 2),  -- 비율 (%)
    UNIQUE(store_id, year, month, category, item_name)
);
```

#### cost_item_templates (비용 항목 템플릿)
```sql
CREATE TABLE cost_item_templates (
    id UUID PRIMARY KEY,
    store_id UUID REFERENCES stores(id),
    category TEXT NOT NULL,
    item_name TEXT NOT NULL,
    item_type TEXT DEFAULT 'normal' CHECK (item_type IN ('normal', 'fixed', 'percent')),
    is_recurring BOOLEAN DEFAULT FALSE,
    UNIQUE(store_id, category, item_name)
);
```

---

### 5.3 데이터 테이블별 사용 페이지 정리

| 테이블 | 입력 페이지 | 사용 페이지 |
|--------|-----------|-----------|
| `menu_master` | 메뉴 등록 | 레시피 등록, 원가 파악, 판매 관리, 통합 대시보드, 주간 리포트 |
| `ingredients` | 재료 등록 | 레시피 등록, 원가 파악, 재료 사용량 집계, 발주 관리 |
| `recipes` | 레시피 등록 | 원가 파악, 재료 사용량 집계, 판매 관리, 통합 대시보드 |
| `sales` | 매출 등록, 점장 마감 | 매출 관리, 통합 대시보드, 실제정산, 주간 리포트 |
| `daily_sales_items` | 점장 마감, 판매량 등록 | 재료 사용량 집계, 판매 관리, 목표 매출구조, 통합 대시보드, 주간 리포트 |
| `daily_close` | 점장 마감 | 통합 대시보드, 주간 리포트 |
| `expense_structure` | 목표 비용구조 | 목표 매출구조, 실제정산, 통합 대시보드 |
| `targets` | 목표 매출구조 | 실제정산, 통합 대시보드 |
| `actual_settlement_items` | 실제정산 | 실제정산 (비교 분석) |
| `inventory` | 발주 관리 | 발주 관리 (발주 추천) |

---

### 5.4 Row Level Security (RLS)

모든 테이블에 RLS가 활성화되어 있으며, 사용자는 자신의 매장(`store_id`) 데이터만 접근할 수 있습니다.

**RLS 정책 예시:**
```sql
CREATE POLICY "Users can view sales from their store"
    ON sales FOR SELECT
    USING (store_id = get_user_store_id());
```

`get_user_store_id()` 함수는 현재 로그인한 사용자의 `user_profiles.store_id`를 반환합니다.

---

## 6. 업그레이드 논의 포인트

### 6.1 즉시 개선 필요 사항

1. **페이지간 데이터 충돌 해결**
   - 마감보고 vs 매출 등록 vs 판매량 등록 충돌 방지 로직
   - 데이터 일관성 보장 메커니즘

2. **코드 리팩토링**
   - app.py 분리 (라우팅만 남기기)
   - settlement_actual.py 모듈화
   - 중복 코드 제거

3. **입력 검증 표준화**
   - 모든 페이지에 일관된 검증 로직 적용
   - 에러 메시지 표준화

### 6.2 기능 개선 제안

1. **발주 관리 완성**
   - 현재 4개 탭이 비어있음
   - 발주 추천, 진행 현황, 공급업체, 발주 분석 기능 구현

2. **데이터 시각화 강화**
   - 더 많은 차트 및 그래프
   - 대시보드 개선

3. **자동화 기능**
   - POS 연동 (API)
   - 자동 매출 입력
   - 알림 시스템

### 6.3 성능 개선

1. **캐시 전략 개선**
   - 마스터 데이터와 트랜잭션 데이터별 다른 TTL 적용
   - 캐시 무효화 타이밍 최적화

2. **데이터 로딩 최적화**
   - 지연 로딩 (Lazy Loading) 적용
   - 필요한 컬럼만 선택적으로 로드

3. **쿼리 최적화**
   - 인덱스 활용 개선
   - 불필요한 조인 제거

---

## 7. 결론

이 문서는 매장 운영 시스템 v1의 전체 구조를 종합적으로 정리한 자료입니다. 전문가와의 업그레이드 논의 시 다음 사항을 중심으로 논의할 수 있습니다:

1. **데이터 일관성**: 페이지간 충돌 해결 방안
2. **코드 품질**: 리팩토링 우선순위 및 계획
3. **기능 완성도**: 미완성 기능 구현 계획
4. **성능 최적화**: 사용자 경험 개선 방안

---

**문서 버전**: v1.0  
**최종 수정일**: 2026-01-23
