# PHASE 10 / STEP 10-6: "매출 하락 원인 찾기" 원클릭 플로우 완성

## 작업 개요
HOME / 가게 설계 센터 / 장사 분석 어디서든 동일한 CTA 버튼으로 진입 가능한 "매출 하락 원인 찾기" 원클릭 플로우 완성.
3단 구조로 원인 파악 + "어디를 고칠지"까지 자동 유도.

---

## 생성/수정된 파일 목록

### 1. 신규 페이지 생성
- **`ui_pages/diagnostics/__init__.py`** (신규)
- **`ui_pages/diagnostics/sales_drop_oneclick.py`** (신규)
  - `render_sales_drop_oneclick()` - 메인 렌더링 함수
  - `_analyze_when_dropped()` - STEP 1: 언제부터 떨어졌나?
  - `_analyze_what_dropped()` - STEP 2: 무엇이 떨어졌나?
  - `_analyze_top_menu_changes()` - 상위메뉴 변화 분석
  - `_suggest_fixes()` - STEP 3: 어디를 고치나?
  - `_render_step1_result()` - STEP 1 결과 UI
  - `_render_step2_result()` - STEP 2 결과 UI
  - `_render_default_actions()` - 기본 액션 (원인 불명확 시)

### 2. 라우팅/사이드바 연결
- **`app.py`** (수정)
  - "🚨 문제 분석" 카테고리에 "매출 하락 원인 찾기" 메뉴 추가 (상단)
  - 라우팅 추가: `elif page == "매출 하락 원인 찾기"`

### 3. 공통 CTA 버튼 연결
- **`ui_pages/home/home_page.py`** (수정)
  - ZONE 1 "오늘 입력 바로가기" 아래에 "📉 매출 하락 원인 찾기" 버튼 추가 (상시 노출)
- **`ui_pages/design_lab/design_center.py`** (수정)
  - 런치패드 액션 후보에 "매출 하락 원인 찾기" 연결 (page="매출 하락 원인 찾기")
  - 에러 시 기본 액션에도 연결

---

## 핵심 구현 내용

### 1. 3단 구조 플로우

#### STEP 1: 언제부터 떨어졌나?
- **입력**: 기간 선택 (7/14/30일), 비교 방식 (전주/전월), 기준 날짜
- **분석**:
  - 최근 N일 평균 vs 비교구간 평균
  - 하락률(%), 하락액
  - 하락 시작점 추정 (rolling avg가 baseline 아래로 지속 3일 연속)
  - 최근 추세 (최근 3일 vs 그 전 3일)
- **UI**:
  - 요약 카드 3개: 최근 평균 매출, 비교구간 평균 매출, 변화율/변화액
  - 하락 시작 추정일 표시
  - 최근 추세 표시 (하락/회복/변동 없음)
  - 간단 라인차트 (매출 vs baseline)

#### STEP 2: 무엇이 떨어졌나?
- **KPI 분해**:
  - A) 네이버방문자 변화 (유입)
  - B) 객단가 변화 (매출/네이버방문자)
  - C) 판매량 변화 (총 판매수량, daily_sales_items 기반)
  - D) 상위메뉴 변화 (Top 메뉴 매출/수량 순위 변동)
- **원인 후보 자동 생성** (최대 3개):
  - "네이버방문자 -18% → 유입 감소형"
  - "객단가 -12% → 할인/구성/업셀 실패형"
  - "판매량 -15% → 주문 감소형"
  - "Top 메뉴 2개 이상 급감 → 주력메뉴 흔들림형"
- **UI**:
  - 원인 후보 카드 (자동 감지)
  - KPI delta 테이블 (최근 vs 비교)
  - 상위메뉴 변화 테이블 (순위 하락/이탈 메뉴, 최대 5개)

#### STEP 3: 어디를 고치나?
- **추천 수리 액션** (우선순위 기반):
  - 네이버방문자 하락이 가장 크면 → [매출 분석] + [포트폴리오 설계실] 보조
  - 객단가 하락이 가장 크면 → [메뉴 수익 구조 설계실(가격·마진)] 우선
  - 판매량/Top 메뉴 급감이면 → [메뉴 포트폴리오 설계실] + [판매·메뉴 분석]
  - 설계 인사이트 기반 추가 추천:
    - 원가율/재료 집중 위험 → [재료 구조 설계실]
    - 손익분기점 위험 → [수익 구조 설계실]
- **UI**:
  - 우선 액션 1개 강조 (그라데이션 카드)
  - 나머지 액션은 "다른 가능성 보기" expander에 배치
  - 각 액션에 CTA 버튼 (전략 실행 탭으로 이동 가능)

### 2. 비교 방식 정의

#### 전주 대비
- 비교 구간: 최근 구간에서 7일 shift
- 예: 최근 14일 (1/10~1/23) vs 전주 14일 (1/3~1/16)

#### 전월 대비
- 비교 구간: 최근 구간에서 28일 shift (간단화)
- 예: 최근 14일 (1/10~1/23) vs 전월 14일 (12/13~12/26)

### 3. 원인 후보 생성 규칙 (우선순위)

1. **네이버방문자 하락** (change_pct < -10%)
   - 라벨: "네이버방문자 {change_pct:.1f}% → 유입 감소형"

2. **객단가 하락** (change_pct < -10%)
   - 라벨: "객단가 {change_pct:.1f}% → 할인/구성/업셀 실패형"

3. **판매량 하락** (change_pct < -10%)
   - 라벨: "판매량 {change_pct:.1f}% → 주문 감소형"

4. **상위메뉴 급감** (Top 메뉴 2개 이상 -20% 이상)
   - 라벨: "Top 메뉴 2개 이상 급감 → 주력메뉴 흔들림형"

### 4. 추천 수리 액션 매핑표

| 원인 유형 | 우선 액션 | 보조 액션 | 설계 인사이트 기반 추가 |
|---------|---------|---------|-------------------|
| 네이버방문자 하락 | 매출 분석 | 메뉴 포트폴리오 설계실 | - |
| 객단가 하락 | 메뉴 수익 구조 설계실 | - | - |
| 판매량/상위메뉴 급감 | 메뉴 포트폴리오 설계실 | 판매·메뉴 분석 | - |
| - | - | - | 원가 집중도 높음 → 재료 구조 설계실 |
| - | - | - | 손익분기점 위험 → 수익 구조 설계실 |

---

## 데이터 정책 준수

### SSOT best_available 사용
- ✅ `load_best_available_daily_sales()` 사용 (sales 직접 조회 금지)
- ✅ `v_daily_sales_best_available` VIEW 기반
- ✅ 판매량: `load_csv('daily_sales_items.csv')` → `v_daily_sales_items_effective` VIEW 사용

### 용어 통일
- ✅ "방문자" → "네이버방문자"로 통일

---

## 품질/안전 가드

### 1. 데이터 부족 처리
- 매출 데이터 없을 때: "데이터가 부족합니다" 안내 + [오늘 입력(마감/보정)] 버튼 제공
- 판매량/방문자 데이터 없을 때: "판매량/방문자 데이터가 부족합니다" 안내
- 모든 단계에서 None 체크 및 기본값 설정

### 2. 캐시 활용
- `_analyze_when_dropped()`: `@st.cache_data(ttl=300)` 적용
- `_analyze_top_menu_changes()`: `@st.cache_data(ttl=300)` 적용
- store_id/기간/비교방식 키 기반 캐싱

### 3. 에러 처리
- 모든 함수에 try-except 적용
- DEV 모드에서만 상세 에러 메시지 출력
- 에러 발생 시 안전하게 빈 결과 반환 (앱 깨짐 방지)

---

## 공통 CTA 버튼 위치

### 1. HOME
- **위치**: ZONE 1 "오늘 입력 바로가기" 아래
- **버튼**: `[📉 매출 하락 원인 찾기]` (상시 노출, primary 타입)
- **연결**: `page="매출 하락 원인 찾기"`

### 2. 가게 설계 센터
- **위치**: 런치패드 액션 후보
- **연결**: `page="매출 하락 원인 찾기"` (기본 점수 50점)
- **상태**: Top3 개인화에 포함될 수 있음 (운영 데이터 기반 점수 추가 가능)

### 3. 장사 분석 메뉴
- **위치**: 사이드바 "🚨 문제 분석" 카테고리 상단
- **메뉴**: "매출 하락 원인 찾기"

---

## 회귀 테스트 체크리스트

### ✅ 기본 기능
- [x] HOME/설계센터/사이드바 모두 동일 버튼으로 진입되는지
- [x] 7/14/30일 + 전주/전월 바꿔도 깨짐 없는지
- [x] 데이터 부족 케이스에서 안내/버튼이 뜨는지

### ✅ STEP 1: 언제부터 떨어졌나?
- [x] 최근 평균 vs 비교구간 평균 정확히 계산되는지
- [x] 하락 시작점 추정이 정상 작동하는지
- [x] 최근 추세 표시가 정확한지
- [x] 라인차트가 정상 표시되는지

### ✅ STEP 2: 무엇이 떨어졌나?
- [x] 네이버방문자/객단가/판매량 변화율이 정확히 계산되는지
- [x] 원인 후보가 자동으로 생성되는지
- [x] 상위메뉴 변화 테이블이 정상 표시되는지

### ✅ STEP 3: 어디를 고치나?
- [x] 우선 액션이 가장 큰 변화율 원인 기반으로 선정되는지
- [x] 설계 인사이트 기반 추가 추천이 정상 작동하는지
- [x] CTA 버튼 클릭 시 해당 설계실로 이동하는지
- [x] 전략 실행 탭으로 이동하는지 (플래그 설정)

### ✅ 데이터 정책
- [x] SSOT best_available 사용 (sales 직접 조회 없음)
- [x] "네이버방문자" 용어 통일
- [x] 캐시 정상 작동

---

## 비교 방식 상세 정의

### 전주 대비
- **구간 계산**: 최근 구간에서 7일 shift
- **예시**: 
  - 최근 14일: 2026-01-10 ~ 2026-01-23
  - 전주 14일: 2026-01-03 ~ 2026-01-16

### 전월 대비
- **구간 계산**: 최근 구간에서 28일 shift (간단화)
- **예시**:
  - 최근 14일: 2026-01-10 ~ 2026-01-23
  - 전월 14일: 2025-12-13 ~ 2025-12-26

---

## 주의사항

1. **캐시 무효화**: 매출 데이터 입력 후 `_analyze_when_dropped.clear()` 호출 필요 (또는 자동 TTL 5분)
2. **성능**: 첫 로드 시 약간의 지연 가능 (캐시 적용 후 개선)
3. **데이터 부족**: 설계 인사이트가 없어도 기본 액션 제공

---

## 완료일
2026-01-24
