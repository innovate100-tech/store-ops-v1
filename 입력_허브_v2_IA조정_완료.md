# 입력 허브 v2 + IA 조정 완료 보고서

**작업 일자**: 2026-01-24  
**목적**: 입력 허브 추천 로직 v2 고도화 + 사이드바 IA 조정 (체크 결과/체크 히스토리를 분석 그룹으로 이동)

---

## 1️⃣ 사이드바 IA 변경 요약

### 변경 전

```
✍ 입력
  - 입력 허브
  - 일일 입력(통합)
  - 점장 마감
  - 매출 등록
  - 판매량 등록
  - 월간 성적표
  - 주간 리포트
  - 매장 체크리스트
  - 체크 결과
  - 체크 히스토리

📊 분석
  - 매출 하락 원인 찾기
  - 매출 분석
  - 판매·메뉴 분석
  - 원가 분석
```

### 변경 후

```
✍ 입력
  - 입력 허브
  - 일일 입력(통합)
  - 점장 마감
  - 매출 등록
  - 판매량 등록
  - 월간 성적표
  - 주간 리포트
  - 매장 체크리스트 (유지)

📊 분석
  - 체크 결과 (입력에서 이동)
  - 체크 히스토리 (입력에서 이동)
  - 매출 하락 원인 찾기
  - 매출 분석
  - 판매·메뉴 분석
  - 원가 분석
```

---

## 2️⃣ 입력 허브 추천 로직 v2

### 추천 우선순위

**P1. 오늘 입력(통합)이 "매출도 없고 기록도 없음"**
- 조건: `not has_sales and not has_any`
- 메시지: "📝 오늘 입력을 시작하세요"
- 버튼: "📝 오늘 입력(통합)"
- 페이지 키: "일일 입력(통합)"

**P2. 오늘 매출/기록은 있는데 "마감 없음"**
- 조건: `not has_close` (P1 통과 후)
- 메시지: "📋 오늘 마감을 완료하세요"
- 버튼: "📋 점장 마감"
- 페이지 키: "점장 마감"

**P3. 오늘 마감까지 완료했는데, 최근 7일 내 체크리스트 완료가 0회**
- 조건: `has_close and checklist_count == 0` (P1, P2 통과 후)
- 메시지: "📋 이번 주 점검을 한번 해보세요"
- 버튼: "📋 매장 체크리스트"
- 페이지 키: "건강검진 실시"

**P4. 월초(1~3일)이고 지난달 실제정산 미완료**
- 조건: `today.day <= 3 and not is_settlement_done` (P1, P2, P3 통과 후)
- 메시지: "📅 월초입니다. 지난달 정산을 마무리하세요"
- 버튼: "📅 월간 정산(실제 입력)"
- 페이지 키: "실제정산"

**Fallback. 예외 발생/판단 불가**
- 메시지: "📝 오늘 입력을 시작하세요"
- 버튼: "📝 오늘 입력(통합)"
- 페이지 키: "일일 입력(통합)"

---

## 3️⃣ 구현 세부 사항

### 3.1 새로 추가된 헬퍼 함수

#### `_count_completed_checklists_last_7_days(store_id: str) -> int`
- **목적**: 최근 7일 내 완료된 체크리스트 개수 조회
- **구현**:
  - `health_check_sessions` 테이블 조회
  - `completed_at`이 NULL이 아닌 세션만 카운트
  - `completed_at >= (today - 6일)` 조건 (총 7일)
- **에러 처리**: 예외 발생 시 0 반환 (페이지 크래시 방지)

#### `_is_monthly_settlement_done_for_prev_month(store_id: str) -> bool`
- **목적**: 지난달 실제정산 완료 여부 확인
- **구현**:
  - `load_actual_settlement_items()` 함수 재사용
  - 지난달(year, month) 계산
  - `actual_settlement_items` 테이블에서 항목 존재 여부 확인
  - 항목이 1개 이상 있으면 완료로 간주
- **에러 처리**: 예외 발생 시 False 반환 (P4 건너뛰도록)

### 3.2 추천 로직 개선

**기존 v1 로직**:
- 오늘 데이터 없음 → 오늘 입력 추천
- 오늘 데이터 있음 → 점장 마감 추천

**신규 v2 로직**:
- P1: 매출/기록 없음 → 오늘 입력 추천
- P2: 매출/기록 있음 + 마감 없음 → 점장 마감 추천
- P3: 마감 완료 + 체크리스트 7일 0회 → 매장 체크리스트 추천
- P4: 월초(1~3일) + 지난달 정산 미완료 → 월간 정산 추천
- Fallback: 예외 발생 시 오늘 입력 추천

### 3.3 기록 여부 판단 로직

**"기록 있음" 판단**:
```python
has_any = has_sales or has_visitors or has_close
```

- `has_sales`: sales 테이블에 오늘 데이터 존재
- `has_visitors`: naver_visitors 테이블에 오늘 데이터 존재
- `has_close`: daily_close 테이블에 오늘 데이터 존재

---

## 4️⃣ 수정된 파일 목록

### 4.1 app.py

**위치**: 라인 1516-1534

**변경 내용**:
- "체크 결과", "체크 히스토리"를 입력 그룹에서 분석 그룹으로 이동
- "매장 체크리스트"는 입력 그룹에 유지
- Page key는 기존 유지 ("검진 결과 요약", "검진 히스토리", "건강검진 실시")

**변경 전**:
```python
"✍ 입력": [
    ...
    ("매장 체크리스트", "건강검진 실시"),
    ("체크 결과", "검진 결과 요약"),
    ("체크 히스토리", "검진 히스토리"),
],
"📊 분석": [
    ("매출 하락 원인 찾기", "매출 하락 원인 찾기"),
    ...
],
```

**변경 후**:
```python
"✍ 입력": [
    ...
    ("매장 체크리스트", "건강검진 실시"),
],
"📊 분석": [
    ("체크 결과", "검진 결과 요약"),  # 입력에서 이동
    ("체크 히스토리", "검진 히스토리"),  # 입력에서 이동
    ("매출 하락 원인 찾기", "매출 하락 원인 찾기"),
    ...
],
```

### 4.2 ui_pages/input/input_hub.py

**변경 내용**:
1. **새 함수 추가**:
   - `_count_completed_checklists_last_7_days()` (라인 17-46)
   - `_is_monthly_settlement_done_for_prev_month()` (라인 49-79)

2. **추천 로직 v2 구현**:
   - `_get_today_recommendation()` 함수 완전 재작성 (라인 82-170)
   - 우선순위 P1~P4 + Fallback 로직 구현

3. **Import 추가**:
   - `get_supabase_client` (라인 8)
   - `load_actual_settlement_items` (라인 9)
   - `timedelta` (라인 11)

---

## 5️⃣ 기능 영향 없음 체크리스트

### ✅ Page Key 유지
- [x] "건강검진 실시" 키 유지 (라우팅 키)
- [x] "검진 결과 요약" 키 유지 (라우팅 키)
- [x] "검진 히스토리" 키 유지 (라우팅 키)
- [x] "실제정산" 키 유지 (라우팅 키)
- [x] 모든 내부 이동에서 page key 유지

### ✅ 함수명/파일명 유지
- [x] 함수명 변경 없음 (`render_input_hub`, `render_health_check_result`, `render_health_check_history`)
- [x] 파일명 변경 없음 (`input_hub.py`, `health_check_result.py`, `health_check_history.py`)
- [x] 모듈 경로 변경 없음

### ✅ DB/테이블명 유지
- [x] 테이블명 변경 없음 (health_check_sessions, actual_settlement_items 등)
- [x] DB 쿼리 변경 없음 (조회만 추가)
- [x] 저장 로직 변경 없음

### ✅ 로직 변경 없음
- [x] 페이지 렌더링 로직 변경 없음
- [x] 데이터 처리 로직 변경 없음 (조회만 추가)
- [x] 라우팅 로직 변경 없음

### ✅ 라우팅 유지
- [x] `elif page == "건강검진 실시":` 유지
- [x] `elif page == "검진 결과 요약":` 유지
- [x] `elif page == "검진 히스토리":` 유지
- [x] `elif page == "실제정산":` 유지

---

## 6️⃣ 검증 체크리스트

### 사이드바 메뉴
- [ ] 입력 그룹에 "매장 체크리스트"만 표시됨
- [ ] 입력 그룹에서 "체크 결과", "체크 히스토리" 제거됨
- [ ] 분석 그룹에 "체크 결과", "체크 히스토리" 표시됨
- [ ] 각 메뉴 클릭 시 해당 페이지로 정상 이동

### 입력 허브 추천 로직
- [ ] P1: 오늘 매출/기록 없음 → "📝 오늘 입력(통합)" 추천
- [ ] P2: 오늘 매출/기록 있음 + 마감 없음 → "📋 점장 마감" 추천
- [ ] P3: 마감 완료 + 체크리스트 7일 0회 → "📋 매장 체크리스트" 추천
- [ ] P4: 월초(1~3일) + 지난달 정산 미완료 → "📅 월간 정산(실제 입력)" 추천
- [ ] Fallback: 예외 발생 시 "📝 오늘 입력(통합)" 추천

### 안정성 체크
- [ ] 앱 크래시 없음
- [ ] 무한 rerun 없음
- [ ] 에러 발생 시 fallback 동작 확인

---

## 7️⃣ 테스트 시나리오

### 시나리오 1: P1 조건 (오늘 매출/기록 없음)
1. 오늘 매출/방문자/마감 데이터가 없는 상태
2. 입력 허브 접근
3. **예상 결과**: "📝 오늘 입력을 시작하세요" 메시지 + "📝 오늘 입력(통합)" 버튼

### 시나리오 2: P2 조건 (오늘 매출/기록 있음 + 마감 없음)
1. 오늘 매출 또는 방문자 데이터는 있지만 마감은 없는 상태
2. 입력 허브 접근
3. **예상 결과**: "📋 오늘 마감을 완료하세요" 메시지 + "📋 점장 마감" 버튼

### 시나리오 3: P3 조건 (마감 완료 + 체크리스트 7일 0회)
1. 오늘 마감 완료 상태
2. 최근 7일 내 체크리스트 완료 0회
3. 입력 허브 접근
4. **예상 결과**: "📋 이번 주 점검을 한번 해보세요" 메시지 + "📋 매장 체크리스트" 버튼

### 시나리오 4: P4 조건 (월초 + 지난달 정산 미완료)
1. 오늘 날짜가 1~3일
2. 지난달 actual_settlement_items가 0개
3. 입력 허브 접근
4. **예상 결과**: "📅 월초입니다. 지난달 정산을 마무리하세요" 메시지 + "📅 월간 정산(실제 입력)" 버튼

### 시나리오 5: 사이드바 IA 확인
1. 사이드바 입력 그룹 확인
2. **예상 결과**: "매장 체크리스트"만 표시, "체크 결과", "체크 히스토리" 없음
3. 사이드바 분석 그룹 확인
4. **예상 결과**: "체크 결과", "체크 히스토리" 표시

---

## 8️⃣ 주의 사항

### 8.1 Page Key 유지

**중요**: 모든 라우팅에서 page key는 기존 그대로 유지됩니다.

- 사이드바: 라벨만 변경, page key는 "건강검진 실시", "검진 결과 요약", "검진 히스토리" 유지
- 입력 허브: 추천 버튼의 page key는 기존 유지
- 내부 이동: 모든 버튼에서 page key는 기존 유지

**이유**: 라우팅 로직(`elif page == "건강검진 실시"`)과의 호환성 유지

### 8.2 에러 처리

**안전 가드**:
- 모든 DB 조회는 `try-except`로 감싸서 예외 발생 시 안전한 기본값 반환
- `_count_completed_checklists_last_7_days()`: 예외 시 0 반환
- `_is_monthly_settlement_done_for_prev_month()`: 예외 시 False 반환
- `_get_today_recommendation()`: 예외 시 Fallback 반환

**이유**: 페이지 크래시 방지 및 사용자 경험 유지

### 8.3 DB 조회 최소화

**최적화**:
- 체크리스트 조회: 1회 (count 쿼리)
- 월간 정산 조회: 1회 (기존 함수 재사용)
- 오늘 상태 조회: 1회 (기존 함수 재사용)

**총 DB 호출**: 최대 3회 (P3, P4 조건 확인 시)

---

## 9️⃣ 변경 상세 내역

### 9.1 app.py 변경

**위치**: 라인 1516-1534

**변경 내용**:
- "체크 결과", "체크 히스토리"를 입력 그룹에서 분석 그룹으로 이동
- "매장 체크리스트"는 입력 그룹에 유지

### 9.2 input_hub.py 변경

**추가된 함수**:
1. `_count_completed_checklists_last_7_days()`: 최근 7일 체크리스트 완료 개수 조회
2. `_is_monthly_settlement_done_for_prev_month()`: 지난달 실제정산 완료 여부 확인

**수정된 함수**:
1. `_get_today_recommendation()`: v1 → v2로 완전 재작성
   - P1~P4 우선순위 로직 구현
   - Fallback 처리 추가

**Import 추가**:
- `get_supabase_client`
- `load_actual_settlement_items`
- `timedelta`

---

**작성일**: 2026-01-24  
**담당**: 입력 허브 v2 + IA 조정 작업
