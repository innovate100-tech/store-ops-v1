# 비용 분석 페이지 고도화 기획안

**작성 일자**: 2026-01-24  
**목적**: 목표 비용구조의 5대 핵심 비용 심층 분석 및 다른 데이터와의 통합 분석

---

## 📋 개요

현재 비용 분석 페이지는 기본적인 고정비/변동비 지표와 시뮬레이션만 제공합니다.  
**목표 비용구조**의 **5대 핵심 비용** (임차료, 인건비, 공과금, 재료비, 부가세&카드수수료)을 **금액과 비율 모두** 분석하고, **매출·실제정산·재료 사용량** 등 다른 데이터와 통합 분석하여 **사장님께 실질적으로 도움이 되는 인사이트**를 제공하도록 고도화합니다.

---

## 1. 핵심 개선 사항

### 1.1 5대 핵심 비용 상세 분석 (신규)

**목적**: 각 비용 카테고리의 금액·비율·구성·트렌드를 한눈에 파악.

#### A. 비용 카테고리별 상세 분석

| 카테고리 | 분석 항목 | 데이터 소스 |
|---------|---------|------------|
| **임차료** (고정비) | 금액, 매출 대비 비율, 전월 대비, 작년 동월 대비 | `expense_structure` (category='임차료') |
| **인건비** (고정비) | 금액, 매출 대비 비율, 전월 대비, 작년 동월 대비, 인당 평균 | `expense_structure` (category='인건비') |
| **공과금** (고정비) | 금액, 매출 대비 비율, 전월 대비, 작년 동월 대비 | `expense_structure` (category='공과금') |
| **재료비** (변동비) | 비율(%), 매출 대비 금액, 전월 대비, 작년 동월 대비, 재료 사용량과 연계 | `expense_structure` (category='재료비') + 재료 사용량 데이터 |
| **부가세&카드수수료** (변동비) | 비율(%), 매출 대비 금액, 전월 대비, 작년 동월 대비, 카드 매출 비율과 연계 | `expense_structure` (category='부가세&카드수수료') + 매출 데이터 |

**UI 형태**:
- 5개 카테고리별 탭 또는 아코디언
- 각 카테고리: 금액/비율 카드, 세부 항목 리스트, 트렌드 차트, 전월/작년 동월 비교

#### B. 비용 구조 시각화

- **파이 차트**: 5대 비용 카테고리별 비중 (금액 기준)
- **바 차트**: 카테고리별 금액 + 매출 대비 비율 (이중 축)
- **트렌드 라인**: 최근 6개월 비용 추이 (카테고리별)
- **워터폴 차트**: 매출 → 각 비용 차감 → 영업이익 (시각적 손익 구조)

### 1.2 매출·비용 통합 분석 (신규)

**목적**: 매출 수준에 따른 비용 변화와 수익성 분석.

#### A. 매출 수준별 5대 비용 상세 시뮬레이션

**기존**: 매출 수준별 총 비용·영업이익만 표시  
**개선**: 매출 수준별 **5대 비용 각각의 금액** 표시

| 매출 수준 | 임차료 | 인건비 | 공과금 | 재료비 | 부가세&카드 | 총비용 | 영업이익 |
|----------|--------|--------|--------|--------|------------|--------|---------|
| 손익분기 | 100만 | 200만 | 50만 | 350만 | 100만 | 800만 | 0만 |
| 목표 매출 | 100만 | 200만 | 50만 | 500만 | 150만 | 1000만 | 500만 |
| 현재 매출 | 100만 | 200만 | 50만 | 420만 | 120만 | 890만 | 310만 |

**UI 형태**:
- 매출 슬라이더 또는 입력 필드
- 실시간 계산 테이블 (5대 비용 + 총비용 + 영업이익)
- 차트: 매출 수준별 5대 비용 스택 바 차트

#### B. 매출 대비 비용 효율성 분석

- **비용률**: 각 카테고리 / 매출 × 100
- **목표 대비**: 목표 비용률 vs 실제 비용률
- **인사이트**: "재료비가 목표 대비 2%p 높습니다. 재료 사용량을 확인하세요."

### 1.3 실제정산 데이터와 비교 분석 (신규)

**목적**: 목표 비용구조 vs 실제정산 비교로 실행 가능한 인사이트 제공.

#### A. 목표 vs 실제 비교

| 카테고리 | 목표 금액 | 실제 금액 | 차이 | 목표 비율 | 실제 비율 | 차이 |
|---------|----------|----------|------|----------|----------|------|
| 임차료 | 100만원 | 100만원 | 0만원 | 10% | 9.5% | -0.5%p |
| 인건비 | 200만원 | 210만원 | +10만원 | 20% | 20.0% | 0%p |
| ... | ... | ... | ... | ... | ... | ... |

**인사이트**:
- "인건비가 목표 대비 +10만원 초과했습니다. (목표 200만원 vs 실제 210만원)"
- "재료비율이 목표 대비 +2%p 높습니다. 재료 사용량을 확인하세요."

#### B. 비용 초과/절감 자동 진단

- 초과 비용 카테고리 자동 식별
- 절감 가능 비용 추정
- 우선순위별 액션 아이템 제안

### 1.4 재료 사용량과 연계 분석 (신규)

**목적**: 재료비 비율이 높을 때 재료 사용량 데이터와 연계하여 원인 분석.

#### A. 재료비 vs 재료 사용량 상관 분석

- **재료비율**: `expense_structure` (category='재료비')
- **재료 사용량**: `ingredient_usage_summary` 또는 재료 사용량 집계 데이터
- **상관 분석**: 재료비율 변화와 재료 사용량 변화의 상관관계

**인사이트**:
- "재료비율이 전월 대비 +3%p 증가했습니다. 재료 사용량도 +5% 증가했습니다."
- "재료 사용량은 동일한데 재료비율이 증가했습니다. 재료 단가 상승을 확인하세요."

#### B. TOP 재료 사용량과 재료비 연계

- TOP 5 재료 사용량 표시
- 각 재료의 단가 추정 (재료비 / 사용량)
- 재료 단가 상승 감지 및 알림

### 1.5 비용 구조 최적화 시뮬레이션 (신규)

**목적**: 비용 구조 변경 시나리오별 수익성 분석.

#### A. 비용 절감 시나리오

- 각 카테고리별 절감 가능 금액/비율 입력
- 절감 시 예상 영업이익 계산
- 우선순위별 절감 효과 비교

**예시**:
- "인건비 10% 절감 시 → 월 영업이익 +20만원 증가 예상"
- "재료비율 2%p 절감 시 → 월 영업이익 +30만원 증가 예상"

#### B. 비용 구조 민감도 분석 (강화)

**기존**: 고정비/변동비율 변화만  
**개선**: **5대 비용 각각의 변화** 시나리오

| 시나리오 | 임차료 | 인건비 | 공과금 | 재료비율 | 부가세&카드 | 총비용 | 영업이익 | 변화 |
|---------|--------|--------|--------|----------|------------|--------|---------|------|
| 현재 | 100만 | 200만 | 50만 | 35% | 5% | 890만 | 310만 | — |
| 인건비 -10% | 100만 | 180만 | 50만 | 35% | 5% | 870만 | 330만 | +20만 |
| 재료비율 -2%p | 100만 | 200만 | 50만 | 33% | 5% | 860만 | 340만 | +30만 |

---

## 2. 새로운 페이지 구조 (고도화)

### 2.1 ZONE A: 핵심 지표 (기존 유지 + 강화)

**추가 지표**:
- 5대 비용 카테고리별 금액 요약 (5개 카드)
- 5대 비용 카테고리별 매출 대비 비율 요약
- 총 비용 (고정비 + 변동비)
- 비용률 (총 비용 / 매출 × 100)

### 2.2 ZONE B: 5대 핵심 비용 상세 분석 (신규)

**내용**:
- 5개 카테고리별 탭 또는 아코디언
- 각 카테고리:
  - 금액/비율 카드
  - 세부 항목 리스트 (item_name별 금액/비율)
  - 전월 대비 / 작년 동월 대비 비교
  - 트렌드 차트 (최근 6개월)

### 2.3 ZONE C: 비용 구조 시각화 (신규)

**내용**:
- 파이 차트: 5대 비용 비중
- 바 차트: 카테고리별 금액 + 매출 대비 비율
- 워터폴 차트: 매출 → 각 비용 차감 → 영업이익
- 트렌드 라인: 최근 6개월 비용 추이

### 2.4 ZONE D: 목표매출 달성 시 비용구조 (기존 유지 + 강화)

**추가 내용**:
- 5대 비용 각각의 금액 표시 (기존: 고정비/변동비만)
- 5대 비용 각각의 매출 대비 비율 표시
- 스택 바 차트: 매출 수준별 5대 비용 구성

### 2.5 ZONE E: 매출 수준별 5대 비용 시뮬레이션 (기존 강화)

**기존**: 매출 수준별 총 비용·영업이익  
**개선**: 매출 수준별 **5대 비용 각각의 금액** 상세 표시

**내용**:
- 매출 입력 슬라이더/필드
- 실시간 계산 테이블 (5대 비용 + 총비용 + 영업이익)
- 스택 바 차트: 매출 수준별 5대 비용 구성
- 여러 매출 수준 동시 비교 (손익분기, 목표, 현재, 사용자 입력)

### 2.6 ZONE F: 목표 vs 실제 비교 (신규)

**내용**:
- 목표 비용구조 vs 실제정산 비교 테이블
- 차이 분석 (금액 차이, 비율 차이)
- 초과/절감 카테고리 자동 식별
- 인사이트 및 액션 아이템

### 2.7 ZONE G: 재료 사용량 연계 분석 (신규)

**내용**:
- 재료비율 vs 재료 사용량 상관 분석
- TOP 재료 사용량과 재료비 연계
- 재료 단가 추정 및 상승 감지

### 2.8 ZONE H: 비용 구조 최적화 시뮬레이션 (신규)

**내용**:
- 비용 절감 시나리오 입력
- 절감 시 예상 영업이익 계산
- 5대 비용 각각의 민감도 분석
- 우선순위별 절감 효과 비교

### 2.9 ZONE I: 비용 구조 입력 현황 (기존 유지)

- 5개 카테고리별 입력 현황
- 세부 항목 리스트

---

## 3. 데이터 함수 정리 및 증명

### 3.1 5대 비용 데이터 로딩 함수

```python
def _load_five_core_costs(store_id: str, year: int, month: int) -> dict:
    """
    5대 핵심 비용 로드 및 정규화
    
    Returns:
        dict: {
            '임차료': {'amount': float, 'rate': float, 'items': list},
            '인건비': {'amount': float, 'rate': float, 'items': list},
            '공과금': {'amount': float, 'rate': float, 'items': list},
            '재료비': {'amount': float, 'rate': float, 'items': list},  # rate는 %, amount는 매출 기준 계산
            '부가세&카드수수료': {'amount': float, 'rate': float, 'items': list},  # rate는 %, amount는 매출 기준 계산
        }
    """
    expense_df = load_expense_structure(year, month, store_id)
    monthly_sales = load_monthly_sales_total(store_id, year, month) or 0.0
    
    result = {}
    categories = ['임차료', '인건비', '공과금', '재료비', '부가세&카드수수료']
    
    for cat in categories:
        cat_df = expense_df[expense_df['category'] == cat] if not expense_df.empty else pd.DataFrame()
        
        if cat in ['임차료', '인건비', '공과금']:
            # 고정비: amount는 금액, rate는 매출 대비 비율
            amount = float(cat_df['amount'].sum()) if not cat_df.empty else 0.0
            rate = (amount / monthly_sales * 100) if monthly_sales > 0 else 0.0
        else:
            # 변동비: amount는 비율(%), rate도 동일, 실제 금액은 매출 × rate
            rate = float(cat_df['amount'].sum()) if not cat_df.empty else 0.0  # % 단위
            amount = (monthly_sales * rate / 100) if monthly_sales > 0 else 0.0
        
        items = cat_df.to_dict('records') if not cat_df.empty else []
        
        result[cat] = {
            'amount': amount,
            'rate': rate,
            'items': items
        }
    
    return result
```

**증명**:
- 고정비: `amount`는 `expense_structure.amount` 합계 (금액)
- 변동비: `amount`는 `expense_structure.amount` 합계 (비율 %) × 매출 / 100
- 비율: 고정비는 `amount / 매출 × 100`, 변동비는 `expense_structure.amount` 합계 (이미 %)

### 3.2 매출 수준별 5대 비용 계산 함수

```python
def _calculate_costs_by_sales_level(
    sales_level: float,
    five_core_costs: dict
) -> dict:
    """
    매출 수준별 5대 비용 계산
    
    Args:
        sales_level: 시뮬레이션 매출 (원)
        five_core_costs: _load_five_core_costs() 결과
    
    Returns:
        dict: {
            '임차료': float,
            '인건비': float,
            '공과금': float,
            '재료비': float,
            '부가세&카드수수료': float,
            '총비용': float,
            '영업이익': float
        }
    """
    # 고정비: 금액 그대로
    rent = five_core_costs['임차료']['amount']  # 고정비 금액
    labor = five_core_costs['인건비']['amount']  # 고정비 금액
    utility = five_core_costs['공과금']['amount']  # 고정비 금액
    
    # 변동비: 매출 × 비율(%)
    material_rate = five_core_costs['재료비']['rate']  # % 단위
    fee_rate = five_core_costs['부가세&카드수수료']['rate']  # % 단위
    
    material = sales_level * (material_rate / 100)
    fee = sales_level * (fee_rate / 100)
    
    total_cost = rent + labor + utility + material + fee
    profit = sales_level - total_cost
    
    return {
        '임차료': rent,
        '인건비': labor,
        '공과금': utility,
        '재료비': material,
        '부가세&카드수수료': fee,
        '총비용': total_cost,
        '영업이익': profit
    }
```

**증명**:
- 고정비: `expense_structure`의 금액 합계 (매출과 무관)
- 변동비: `expense_structure`의 비율(%) × 매출 / 100

### 3.3 목표 vs 실제 비교 함수

```python
def _compare_target_vs_actual(
    store_id: str,
    year: int,
    month: int,
    target_costs: dict,
    monthly_sales: float
) -> dict:
    """
    목표 비용구조 vs 실제정산 비교
    
    Args:
        target_costs: _load_five_core_costs() 결과 (목표)
        monthly_sales: 실제 매출
    
    Returns:
        dict: {
            '임차료': {'target_amount': float, 'actual_amount': float, 'diff': float, ...},
            ...
        }
    """
    # 실제정산 데이터 로드
    actual_items = load_actual_settlement_items(store_id, year, month)
    templates = load_cost_item_templates(store_id)
    
    # 실제 비용 계산 (템플릿 기반)
    actual_costs = {}
    for cat in ['임차료', '인건비', '공과금', '재료비', '부가세&카드수수료']:
        cat_templates = [t for t in templates if t.get('category') == cat]
        cat_amount = 0.0
        cat_rate = 0.0
        
        for template in cat_templates:
            template_id = template.get('id')
            actual_item = next((a for a in actual_items if a.get('template_id') == template_id), None)
            
            if actual_item:
                if actual_item.get('amount'):
                    cat_amount += float(actual_item['amount'])
                elif actual_item.get('percent'):
                    cat_rate += float(actual_item['percent'])
        
        if cat in ['임차료', '인건비', '공과금']:
            # 고정비: amount 사용
            actual_amount = cat_amount
            actual_rate = (actual_amount / monthly_sales * 100) if monthly_sales > 0 else 0.0
        else:
            # 변동비: rate 사용, amount는 계산
            actual_rate = cat_rate
            actual_amount = (monthly_sales * actual_rate / 100) if monthly_sales > 0 else 0.0
        
        target_amount = target_costs[cat]['amount']
        target_rate = target_costs[cat]['rate']
        
        actual_costs[cat] = {
            'target_amount': target_amount,
            'actual_amount': actual_amount,
            'diff_amount': actual_amount - target_amount,
            'target_rate': target_rate,
            'actual_rate': actual_rate,
            'diff_rate': actual_rate - target_rate
        }
    
    return actual_costs
```

---

## 4. UI/UX 개선

### 4.1 5대 비용 카드 그리드

- 5개 카드 (임차료, 인건비, 공과금, 재료비, 부가세&카드수수료)
- 각 카드: 금액, 매출 대비 비율, 전월 대비 변화율
- 클릭 시 상세 분석 확장

### 4.2 매출 수준별 시뮬레이션 UI 강화

- 매출 슬라이더 + 숫자 입력
- 실시간 계산 테이블 (5대 비용 + 총비용 + 영업이익)
- 스택 바 차트: 매출 수준별 5대 비용 구성
- 여러 시나리오 비교 (손익분기, 목표, 현재, 사용자 입력)

### 4.3 목표 vs 실제 비교 UI

- 비교 테이블 (목표/실제/차이)
- 색상 코딩: 초과(빨강), 절감(초록), 동일(회색)
- 차트: 목표 vs 실제 바 차트

### 4.4 재료 사용량 연계 UI

- 재료비율 vs 재료 사용량 이중 축 차트
- TOP 재료 사용량 테이블
- 재료 단가 추정 및 상승 감지 알림

---

## 5. 데이터 로딩 및 계산

### 5.1 필수 데이터

| 데이터 | 소스 | 용도 |
|--------|------|------|
| 목표 비용구조 | `load_expense_structure()` | 5대 비용 분석 |
| 실제정산 | `load_actual_settlement_items()` | 목표 vs 실제 비교 |
| 월간 매출 | `load_monthly_sales_total()` | 비용률 계산 |
| 재료 사용량 | 재료 사용량 집계 데이터 | 재료비 연계 분석 |
| 목표 매출 | `targets.csv` | 목표 달성 시뮬레이션 |

### 5.2 계산 로직

- **고정비 금액**: `expense_structure` (category='임차료'/'인건비'/'공과금')의 `amount` 합계
- **고정비 비율**: 고정비 금액 / 매출 × 100
- **변동비 비율**: `expense_structure` (category='재료비'/'부가세&카드수수료')의 `amount` 합계 (이미 %)
- **변동비 금액**: 매출 × 변동비 비율 / 100
- **매출 수준별 변동비**: 시뮬레이션 매출 × 변동비 비율 / 100

---

## 6. 구현 순서

| 단계 | 작업 | 비고 |
|------|------|------|
| 1 | **5대 비용 로딩 함수** | `_load_five_core_costs()` 구현 및 테스트 |
| 2 | **ZONE B: 5대 비용 상세 분석** | 카테고리별 탭/아코디언 + 상세 분석 |
| 3 | **ZONE C: 비용 구조 시각화** | 파이/바/워터폴/트렌드 차트 |
| 4 | **ZONE E: 매출 수준별 5대 비용 시뮬레이션** | 기존 시뮬레이션 강화 |
| 5 | **ZONE F: 목표 vs 실제 비교** | `_compare_target_vs_actual()` + UI |
| 6 | **ZONE G: 재료 사용량 연계** | 재료비율 vs 사용량 상관 분석 |
| 7 | **ZONE H: 비용 구조 최적화** | 절감 시나리오 + 민감도 분석 |
| 8 | **ZONE A 강화** | 5대 비용 카드 그리드 추가 |

---

## 7. 기대 효과

### 7.1 실용성

- **5대 비용 한눈에 파악**: 각 비용 카테고리의 금액·비율·구성 즉시 확인
- **매출 수준별 상세 분석**: 다양한 매출 수준에서 5대 비용 각각의 변화 확인
- **목표 vs 실제 비교**: 실행 가능한 개선 포인트 식별
- **재료 사용량 연계**: 재료비율 상승 원인 분석

### 7.2 경영 인사이트

- **비용 구조 최적화**: 절감 시나리오별 효과 비교
- **비용 초과 자동 진단**: 문제점 자동 발견 및 해결책 제시
- **재료 단가 상승 감지**: 재료비율 상승 원인 자동 분석

---

## 8. 정리

### 핵심 원칙

1. **5대 비용 중심**: 임차료, 인건비, 공과금, 재료비, 부가세&카드수수료 각각 상세 분석
2. **금액과 비율 모두**: 고정비는 금액 중심, 변동비는 비율 중심이지만 둘 다 표시
3. **다른 데이터와 연계**: 매출·실제정산·재료 사용량과 통합 분석
4. **실행 가능한 인사이트**: 문제점 발견 및 해결책 제시

### 다음 단계

1. 기획안 검토 및 승인
2. 5대 비용 로딩 함수부터 순차 구현
3. 각 ZONE별 테스트
4. 전체 통합 테스트
5. 사용자 피드백 반영

---

**작성일**: 2026-01-24  
**참고**: 
- `ui_pages/analysis/cost_analysis.py` (현재 구현)
- `ui_pages/analysis/sales_analysis.py` (매출 분석 고도화 참고)
- `src/storage_supabase.py` (데이터 로딩 함수)
