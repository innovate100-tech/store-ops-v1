# í™ˆ Step 8 ìµœì í™” ì™„ë£Œ ìš”ì•½

## ëª©í‘œ
í™ˆ ìµœì´ˆ ì§„ì…ì„ ë” ê°€ë³ê²Œ ë§Œë“¤ê¸°

## êµ¬í˜„ ì™„ë£Œ ì‚¬í•­

### 1. ë¬¸ì œ/ì˜í•œ ì  TOP1ë§Œ ê³„ì‚° (ê²½ëŸ‰í™”)
- âœ… `get_problems_top1()`: ê²½ëŸ‰ ë²„ì „ (TOP1ë§Œ ê³„ì‚°)
- âœ… `get_good_points_top1()`: ê²½ëŸ‰ ë²„ì „ (TOP1ë§Œ ê³„ì‚°)
- âœ… í™ˆ ì²« í™”ë©´ì—ì„œ TOP1ë§Œ í‘œì‹œ
- âœ… "ìì„¸íˆ ë³´ê¸°" ë²„íŠ¼ í´ë¦­ ì‹œì—ë§Œ TOP3 ê³„ì‚° (`session_state` ìºì‹œë¡œ ë°˜ë³µ ê³„ì‚° ë°©ì§€)

### 2. ì´ìƒ ì§•í›„ ê²½ëŸ‰ ë²„ì „
- âœ… `get_anomaly_signals_light()`: ê²½ëŸ‰ ë²„ì „ (1-2ê°œë§Œ)
- âœ… í™ˆ ìµœì´ˆ í‘œì‹œëŠ” ê²½ëŸ‰ ë²„ì „ë§Œ ì‚¬ìš©
- âœ… "ìì„¸íˆ ë³´ê¸°" ë²„íŠ¼ í´ë¦­ ì‹œì—ë§Œ ì „ì²´ 3ê°œ ê³„ì‚°

### 3. ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ ì¶”ê°€
- âœ… í™ˆ ìƒë‹¨ì— "ğŸ”„ ìƒˆë¡œê³ ì¹¨" ë²„íŠ¼ ì¶”ê°€
- âœ… í´ë¦­ ì‹œ `st.cache_data.clear()`, `st.cache_resource.clear()` ì‹¤í–‰
- âœ… `load_home_kpis(ttl=300)` ìºì‹œ ë¬´íš¨í™”

### 4. Import ì¶©ëŒ ì œê±°
- âœ… `ui_pages/home.py` â†’ `ui_pages/home_legacy.py`ë¡œ ë°±ì—…
- âœ… `ui_pages/home.py` ì‚­ì œ (íŒ¨í‚¤ì§€ `ui_pages/home/`ë§Œ ì‚¬ìš©)

### 5. ë¡œë“œ ì‹œê°„ ì¸¡ì •
- âœ… `_render_home_body()` ì‹œì‘ ì‹œ `time.time()` ê¸°ë¡
- âœ… KPI ë¡œë“œ ì™„ë£Œ í›„ ë¡œë“œ ì‹œê°„ ë¡œê·¸ ì¶œë ¥
- âœ… í˜•ì‹: `[í™ˆ ë¡œë“œ ì‹œê°„] {ì‹œê°„}ì´ˆ (store_id={id}, coaching_enabled={bool})`

---

## í™ˆ ìµœì´ˆ ì§„ì… ì‹œ ì¦‰ì‹œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜ ë¦¬ìŠ¤íŠ¸ (ìµœì¢…)

### ë°ì´í„° ë¡œë”© (ê²½ëŸ‰)
1. `detect_data_level(store_id)` - LEVEL íŒë³„ (sales, daily_close, expense_structure ì¡°íšŒ)
2. `detect_owner_day_level(store_id)` - DAY íŒë³„ (daily_close_count, actual_settlement ì¡°íšŒ)
3. `load_home_kpis(store_id, year, month)` - í†µí•© KPI ë¡œë” (ìºì‹œ 300ì´ˆ)
   - ì´ë²ˆ ë‹¬ ë§¤ì¶œ
   - ì˜¤ëŠ˜ ë§¤ì¶œ
   - ë§ˆê°ë¥ /ìŠ¤íŠ¸ë¦­
   - ê°ë‹¨ê°€
   - ì´ë²ˆ ë‹¬ ì´ìµ

### ê²½ëŸ‰ ë¶„ì„ í•¨ìˆ˜ (Step 8 ì¶”ê°€)
4. `get_problems_top1(store_id)` - ë¬¸ì œ TOP1ë§Œ ê³„ì‚° âš¡
5. `get_good_points_top1(store_id)` - ì˜í•œ ì  TOP1ë§Œ ê³„ì‚° âš¡
6. `get_anomaly_signals_light(store_id)` - ì´ìƒ ì§•í›„ 1-2ê°œë§Œ ê³„ì‚° âš¡

### coach_only (coaching_enabled=Trueì¼ ë•Œë§Œ)
7. `get_menu_count(store_id)` - ë©”ë‰´ ê°œìˆ˜
8. `get_close_count(store_id)` - ë§ˆê° ê°œìˆ˜
9. `check_actual_settlement_exists(store_id, year, month)` - ì •ì‚° ì¡´ì¬ ì—¬ë¶€
10. `get_today_one_action_with_day_context(store_id, data_level, True, day_level)` - ì˜¤ëŠ˜ ì¶”ì²œ

### ì œê±°ëœ ë¬´ê±°ìš´ í•¨ìˆ˜ (Lazy Loadë¡œ ì´ë™)
- âŒ `get_problems_top3()` - "ìì„¸íˆ ë³´ê¸°" í´ë¦­ ì‹œì—ë§Œ ì‹¤í–‰
- âŒ `get_good_points_top3()` - "ìì„¸íˆ ë³´ê¸°" í´ë¦­ ì‹œì—ë§Œ ì‹¤í–‰
- âŒ `get_anomaly_signals()` - "ìì„¸íˆ ë³´ê¸°" í´ë¦­ ì‹œì—ë§Œ ì‹¤í–‰
- âŒ `get_store_financial_structure()` - "ì¸ì‚¬ì´íŠ¸ ë”ë³´ê¸°" expanderì—ì„œë§Œ ì‹¤í–‰
- âŒ `get_monthly_memos()` - "ì¸ì‚¬ì´íŠ¸ ë”ë³´ê¸°" expanderì—ì„œë§Œ ì‹¤í–‰

---

## Step 8 ì „/í›„ ë¹„êµ

### Before (Step 7)
- í™ˆ ì§„ì… ì‹œ ì‹¤í–‰ í•¨ìˆ˜: **17ê°œ**
- ë¬´ê±°ìš´ ë¶„ì„ í•¨ìˆ˜: **3ê°œ** (problems_top3, good_points_top3, anomaly_signals)
- ì˜ˆìƒ ë¡œë”© ì‹œê°„: **2-5ì´ˆ** (ë°ì´í„° ì–‘ì— ë”°ë¼)

### After (Step 8)
- í™ˆ ì§„ì… ì‹œ ì‹¤í–‰ í•¨ìˆ˜: **10ê°œ** (ì•½ 41% ê°ì†Œ)
- ë¬´ê±°ìš´ ë¶„ì„ í•¨ìˆ˜: **0ê°œ** (lazy loadë¡œ ì´ë™)
- ê²½ëŸ‰ ë¶„ì„ í•¨ìˆ˜: **3ê°œ** (top1, top1, light)
- ì˜ˆìƒ ë¡œë”© ì‹œê°„: **0.5-1.5ì´ˆ** (ì•½ 70% ê°œì„ )

### ë¡œë“œ ì‹œê°„ ì¸¡ì • ë¡œê·¸ ì˜ˆì‹œ
```
[í™ˆ ë¡œë“œ ì‹œê°„] 0.823ì´ˆ (store_id=xxx, coaching_enabled=True)
[í™ˆ ë¡œë“œ ì‹œê°„] 1.145ì´ˆ (store_id=xxx, coaching_enabled=False)
```

---

## ë³€ê²½ íŒŒì¼ ëª©ë¡

### ì‹ ê·œ í•¨ìˆ˜ ì¶”ê°€
1. `ui_pages/home/home_rules.py`
   - `get_problems_top1()` - ê²½ëŸ‰ ë²„ì „
   - `get_good_points_top1()` - ê²½ëŸ‰ ë²„ì „

2. `ui_pages/home/home_alerts.py`
   - `get_anomaly_signals_light()` - ê²½ëŸ‰ ë²„ì „ (1-2ê°œ)

### ìˆ˜ì • íŒŒì¼
1. `ui_pages/home/home_page.py`
   - `_render_home_body()`: ë¡œë“œ ì‹œê°„ ì¸¡ì • ì¶”ê°€
   - `_render_home_body()`: ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ ì¶”ê°€
   - `_render_problems_good_points()`: TOP1ë§Œ í‘œì‹œ + "ìì„¸íˆ ë³´ê¸°" ë²„íŠ¼
   - `_render_anomaly_signals()`: ê²½ëŸ‰ ë²„ì „ ì‚¬ìš© + "ìì„¸íˆ ë³´ê¸°" ë²„íŠ¼

### ë°±ì—…/ì‚­ì œ
1. `ui_pages/home.py` â†’ `ui_pages/home_legacy.py` (ë°±ì—…)
2. `ui_pages/home.py` ì‚­ì œ (íŒ¨í‚¤ì§€ë§Œ ì‚¬ìš©)

---

## ì‚¬ìš©ì ê²½í—˜ ê°œì„ 

### Before
- í™ˆ ì§„ì… ì‹œ ëª¨ë“  ë¶„ì„ í•¨ìˆ˜ ì‹¤í–‰ (ëŠë¦¼)
- ë¬¸ì œ/ì˜í•œ ì  TOP3 ëª¨ë‘ ê³„ì‚°
- ì´ìƒ ì§•í›„ 3ê°œ ëª¨ë‘ ê³„ì‚°

### After
- í™ˆ ì§„ì… ì‹œ ê²½ëŸ‰ í•¨ìˆ˜ë§Œ ì‹¤í–‰ (ë¹ ë¦„)
- ë¬¸ì œ/ì˜í•œ ì  TOP1ë§Œ í‘œì‹œ, í•„ìš” ì‹œ "ìì„¸íˆ ë³´ê¸°"ë¡œ TOP3 ë¡œë“œ
- ì´ìƒ ì§•í›„ 1-2ê°œë§Œ í‘œì‹œ, í•„ìš” ì‹œ "ìì„¸íˆ ë³´ê¸°"ë¡œ ì „ì²´ ë¡œë“œ
- ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ìœ¼ë¡œ ìºì‹œ ë¬´íš¨í™” ê°€ëŠ¥

---

## ë‹¤ìŒ ë‹¨ê³„ (ì„ íƒ)
- ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§: ì‹¤ì œ ì‚¬ìš©ì í™˜ê²½ì—ì„œ ë¡œë“œ ì‹œê°„ ì¸¡ì •
- ì¶”ê°€ ìµœì í™”: í•„ìš” ì‹œ ë” ë§ì€ í•¨ìˆ˜ë¥¼ lazy loadë¡œ ì´ë™
