# PHASE 10 / STEP 10-6: "매출 하락 원인 찾기" 원클릭 플로우 완성

## 작업 개요
"매출 떨어질 때 원인 찾으러"라는 핵심 니즈를 하나의 플로우로 구현.
HOME / 가게 설계 센터 / 장사 분석 어디서든 [📉 매출 하락 원인 찾기] 버튼 하나로 진입하여,
원인 분해 → 책임 구조 판정 → 설계실 연결까지 자동 흐름 완성.

---

## 생성/수정된 파일 목록

### 1. Core 엔진 (신규)
- **`core/__init__.py`** (신규)
- **`core/sales_drop_engine.py`** (신규)
  - `analyze_sales_drop()` - 매출 하락 원인 분석 엔진
  - `_calculate_quantity_delta()` - 판매량 변화율 계산
  - `_estimate_drop_start_date()` - 하락 시작일 추정
  - `_calculate_recent_trend()` - 최근 추세 계산
  - `_analyze_menu_changes()` - 상위 메뉴 변화 분석
  - `_classify_primary_cause()` - 원인 분류 (traffic/menu/price/cost/structure)

### 2. 분석 페이지 (신규)
- **`ui_pages/analysis/__init__.py`** (신규)
- **`ui_pages/analysis/sales_drop_investigation.py`** (신규)
  - `render_sales_drop_investigation()` - 메인 페이지 렌더링
  - `_render_step1_when()` - STEP 1: 언제부터 떨어졌나?
  - `_render_step2_what()` - STEP 2: 무엇이 떨어졌나?
  - `_render_step3_where()` - STEP 3: 어디를 고치나?

### 3. 라우팅 업데이트 (수정)
- **`app.py`** (수정)
  - "매출 하락 원인 찾기" 페이지 라우팅을 새 페이지로 변경

### 4. 전역 연결 버튼 추가 (수정)
- **`ui_pages/sales_management.py`** (수정)
  - 상단에 "📉 매출 하락 원인 찾기" 버튼 추가
- **`ui_pages/sales_analysis.py`** (수정)
  - 상단에 "📉 매출 하락 원인 찾기" 버튼 추가
- **`ui_pages/home/home_page.py`** (이미 존재)
  - ZONE 1에 "📉 매출 하락 원인 찾기" 버튼 이미 존재
- **`ui_pages/design_lab/design_center.py`** (이미 존재)
  - ZONE D 런치패드에 "📉 매출 하락 원인 찾기" 버튼 이미 존재

---

## 핵심 구현 내용

### 1. STEP 1: 언제부터 떨어졌나?

#### UI 구성
- 기간 선택: 7일 / 14일 / 30일
- 비교 방식: 전주 대비 / 전월 대비
- 기준 날짜: 고급 옵션 (expander)

#### 계산 지표
- 총매출 (일평균)
- 네이버방문자 (일평균)
- 객단가
- 총 판매수량 (일평균)

#### 결과 출력
- 변화율(%) 및 증감 절대값
- 하락 시작 추정일
- 최근 추세 (회복 중 / 추가 하락 / 정체)

### 2. STEP 2: 무엇이 떨어졌나?

#### 원인 분류 (5가지)
1. **유입 문제 (traffic)**: 네이버방문자 감소
2. **메뉴 문제 (menu)**: 총 판매량 감소, 상위 메뉴 판매 급락
3. **가격/구조 문제 (price)**: 객단가 하락
4. **원가 구조 문제 (cost)**: 동일 매출 대비 원가 상승
5. **생존선 문제 (structure)**: 설계 상태 기반 판정

#### 출력 UI
- 핵심 원인 카드 (자동 1순위)
- 근거 2~3개 자동 표시
- 세부 지표 비교 테이블 (이전/현재/증감/상태)
- 상위 메뉴 변화 테이블 (TOP5, 판매량/매출 증감, 순위 변화)

### 3. STEP 3: 어디를 고치나?

#### 책임 구조 매핑
- 유입 문제 → 매출 분석 / 홈
- 메뉴 문제 → 메뉴 포트폴리오 설계실
- 가격 문제 → 메뉴 수익 구조 설계실
- 원가 문제 → 재료 구조 설계실
- 생존선 문제 → 수익 구조 설계실

#### 설계 상태 기반 우선순위 조정
- `design_state_loader`의 `get_primary_risk_area()` 활용
- 설계 상태 위험이 있으면 우선 액션으로 조정

#### 출력 UI
- 코치 판결: 원인 + 설계 상태 위험 동시 표시
- 지금 1순위 액션: 강조 카드 + 버튼
- 보조 액션 2개: expander 또는 리스트

---

## 데이터 정책 준수

### SSOT best_available 사용
- ✅ `load_best_available_daily_sales()` 사용
- ✅ `v_daily_sales_items_effective` 사용 (판매량)
- ✅ sales 직접 조회 금지

### Graceful Fallback
- 데이터 부족 시 안내 메시지 + 입력 페이지로 유도
- 분석 실패 시 기본 액션 제공

---

## 성능 최적화

### 캐시 활용
- `analyze_sales_drop()`: `@st.cache_data(ttl=300)` (5분)
- store_id/period_days/compare_type/key 기반 캐싱

---

## 전역 연결 위치

### HOME v2
- ZONE 1: "📉 매출 하락 원인 찾기" 버튼 (이미 존재)

### 가게 설계 센터
- ZONE D 런치패드: "📉 매출 하락 원인 찾기" 버튼 (이미 존재)

### 장사 분석
- **매출 관리** (`sales_management.py`): 상단 CTA 버튼 추가 ✅
- **판매·메뉴 분석** (`sales_analysis.py`): 상단 CTA 버튼 추가 ✅

---

## 동작 흐름

1. 사용자가 어디서든 [📉 매출 하락 원인 찾기] 버튼 클릭
2. STEP 1: 기간/비교 방식 선택 → 분석 시작
3. STEP 2: 원인 자동 분류 + 근거 표시
4. STEP 3: 설계 상태 기반 책임 구조 판정 + CTA 버튼
5. CTA 클릭 → 해당 설계실/분석 페이지로 이동 (전략 실행 탭 자동 선택)

---

## 회귀 테스트 체크리스트

### ✅ 페이지 접근
- [x] HOME에서 버튼 클릭 → 페이지 진입 OK
- [x] 설계 센터에서 버튼 클릭 → 페이지 진입 OK
- [x] 매출 관리에서 버튼 클릭 → 페이지 진입 OK
- [x] 판매·메뉴 분석에서 버튼 클릭 → 페이지 진입 OK

### ✅ STEP 1 분석
- [x] 7/14/30일 선택 정상 동작
- [x] 전주/전월 대비 비교 정상 동작
- [x] 변화율 계산 정확
- [x] 하락 시작일 추정 정상
- [x] 최근 추세 계산 정상

### ✅ STEP 2 원인 분류
- [x] 유입 문제 감지 정상
- [x] 메뉴 문제 감지 정상
- [x] 가격 문제 감지 정상
- [x] 원가 문제 감지 정상
- [x] 근거 자동 생성 정상
- [x] 상위 메뉴 변화 분석 정상

### ✅ STEP 3 책임 구조 매핑
- [x] 원인별 CTA 페이지 매핑 정상
- [x] 설계 상태 기반 우선순위 조정 정상
- [x] 전략 실행 탭 자동 선택 정상
- [x] 보조 액션 표시 정상

### ✅ 데이터 부족 처리
- [x] 매출 데이터 없을 때 안내 메시지
- [x] 판매량/방문자 데이터 없을 때 안내 메시지
- [x] 입력 페이지로 유도 버튼 작동

---

## 주의사항

1. **기존 파일**: `ui_pages/diagnostics/sales_drop_oneclick.py`는 레거시로 남아있음 (필요 시 삭제 가능)
2. **캐시**: 분석 결과는 5분 캐시 (같은 조건에서 재분석 시 즉시 반환)
3. **설계 상태 연동**: STEP 3에서 `design_state_loader`를 사용하여 더 정확한 우선순위 결정

---

## 완료일
2026-01-24
