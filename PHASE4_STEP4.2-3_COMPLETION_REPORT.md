# PHASE 4 / STEP 4.2-3 ì™„ë£Œ ìš”ì•½

**ì‘ì—…ì¼**: 2025-01-23  
**ëª©í‘œ**: ì‹¤ì œ ì¬ë£Œ ì‚¬ìš©ëŸ‰ ìƒì„± ê²½ë¡œë¥¼ ê³µì‹ íŒŒì´í”„ë¼ì¸ìœ¼ë¡œ 100% í†µì¼

---

## ê³µì‹ ì‚¬ìš©ëŸ‰ ì—”ì§„

### `calculate_ingredient_usage(daily_sales_df, recipe_df) -> pd.DataFrame`
- **ìœ„ì¹˜**: `src/analytics.py:125`
- **ì…ë ¥**:
  - `daily_sales_df`: ì¼ì¼ íŒë§¤ DataFrame (ë‚ ì§œ, ë©”ë‰´ëª…, íŒë§¤ìˆ˜ëŸ‰)
  - `recipe_df`: ë ˆì‹œí”¼ DataFrame (ë©”ë‰´ëª…, ì¬ë£Œëª…, ì‚¬ìš©ëŸ‰)
- **ì¶œë ¥**: DataFrame (ë‚ ì§œ, ì¬ë£Œëª…, ì´ì‚¬ìš©ëŸ‰)
- **ê³µì‹**: `ì¬ë£Œì‚¬ìš©ëŸ‰ = íŒë§¤ìˆ˜ëŸ‰ Ã— ë ˆì‹œí”¼ì‚¬ìš©ëŸ‰`
- **ë°ì´í„° ì†ŒìŠ¤**: 
  - `daily_sales_df`ëŠ” `load_csv('daily_sales_items.csv')`ë¥¼ í†µí•´ ë¡œë“œ
  - `load_csv()`ëŠ” ë‚´ë¶€ì ìœ¼ë¡œ `v_daily_sales_items_effective` ë·° ì‚¬ìš© (í—Œë²• ì¤€ìˆ˜)
  - ë·°ê°€ ì—†ìœ¼ë©´ `daily_sales_items` í…Œì´ë¸”ë¡œ fallback

---

## ìˆ˜ì • íŒŒì¼ ëª©ë¡

### 1. `src/storage_supabase.py`
- **ë³€ê²½**: `save_daily_close()` í•¨ìˆ˜ ë‚´ë¶€ ì¸ë¼ì¸ ê³„ì‚° ì œê±°
- **ìœ„ì¹˜**: 2046-2066ì¤„ (ì¸ë¼ì¸ ê³„ì‚°) â†’ ê³µì‹ í•¨ìˆ˜ í˜¸ì¶œë¡œ êµì²´
- **ë³€ê²½ ë‚´ìš©**:
  - ì¸ë¼ì¸ ê³„ì‚° ë¡œì§ ì œê±°: `for menu_name, sales_qty in sales_items: ... usage = sales_qty * recipe_qty`
  - `sales_items`ë¥¼ DataFrameìœ¼ë¡œ ë³€í™˜
  - `calculate_ingredient_usage()` í˜¸ì¶œ
  - ê²°ê³¼ë¥¼ ì¬ê³  ì°¨ê°ì— ì‚¬ìš©
- **Import ì¶”ê°€**: `from src.analytics import calculate_ingredient_usage`

---

## ì œê±°ëœ ì¸ë¼ì¸ ê³„ì‚° ìˆ˜

### `save_daily_close()` ë‚´ë¶€ ì¸ë¼ì¸ ê³„ì‚°
1. **ì¬ë£Œë³„ ì‚¬ìš©ëŸ‰ ê³„ì‚° ë¡œì§** (2046-2066ì¤„)
   - `for menu_name, sales_qty in sales_items:` ë£¨í”„
   - `menu_recipes` ì°¾ê¸°
   - `usage = sales_qty * recipe_qty` ê³„ì‚°
   - `ingredient_usage` ë”•ì…”ë„ˆë¦¬ ëˆ„ì 

**ì´ 1ê°œ ì¸ë¼ì¸ ê³„ì‚° ì œê±°** (ì•½ 20ì¤„ ì½”ë“œ)

---

## ë‚¨ì•„ ìˆëŠ” ì‚¬ìš©ëŸ‰ ê²½ë¡œ ìˆ˜

### âœ… ê³µì‹ ì—”ì§„ í•¨ìˆ˜ ì‚¬ìš© (SSOT ì¤€ìˆ˜)
1. `ui_pages/ingredient_usage_summary.py:25` - `calculate_ingredient_usage()` í˜¸ì¶œ
2. `ui_pages/dashboard/sections.py:523` - `calculate_ingredient_usage()` í˜¸ì¶œ
3. `app.py:2877` - `calculate_ingredient_usage()` í˜¸ì¶œ
4. `src/storage_supabase.py:2076` - `calculate_ingredient_usage()` í˜¸ì¶œ (ì¬ê³  ì°¨ê°ìš©)

**ë‚¨ì•„ ìˆëŠ” ê²½ë¡œ: 4ê°œ (ëª¨ë‘ SSOT ì¤€ìˆ˜)**

---

## í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ ê²°ê³¼

### êµ¬í˜„ëœ í†µí•© ë¡œì§
1. **ì ì¥ë§ˆê° ì €ì¥ ì‹œ**:
   - `save_daily_close()` í˜¸ì¶œ
   - `sales_items`ë¥¼ DataFrameìœ¼ë¡œ ë³€í™˜
   - `calculate_ingredient_usage()` í˜¸ì¶œ
   - ì¬ê³  ì°¨ê° ìˆ˜í–‰

2. **íŒë§¤ëŸ‰ ë³´ì • ì‹œ**:
   - `v_daily_sales_items_effective` ë·°ê°€ override ë°˜ì˜
   - `load_csv('daily_sales_items.csv')`ê°€ ë·° ì‚¬ìš©
   - `calculate_ingredient_usage()`ê°€ ìµœì¢… íŒë§¤ëŸ‰ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°

3. **ëŒ€ì‹œë³´ë“œ/ë¦¬í¬íŠ¸**:
   - ëª¨ë“  ìœ„ì¹˜ì—ì„œ `calculate_ingredient_usage()` ì‚¬ìš©
   - `v_daily_sales_items_effective` ë·° ê¸°ë°˜ ë°ì´í„° ì‚¬ìš©

### í…ŒìŠ¤íŠ¸ ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] ì ì¥ë§ˆê° í›„ ì¬ë£Œ ì‚¬ìš©ëŸ‰ ì •ìƒ ìƒì„±
- [ ] íŒë§¤ëŸ‰ ë³´ì • ì‹œ ì¬ê³„ì‚° ì •ìƒ
- [ ] ëŒ€ì‹œë³´ë“œ ì›ê°€/ì¬ê³  ìˆ˜ì¹˜ ìœ ì§€
- [ ] actual_settlement ì¬ë£Œë¹„ ìˆ˜ì¹˜ ìœ ì§€
- [ ] override íŒë§¤ëŸ‰ ë°˜ì˜ í™•ì¸
- [ ] ì§ì ‘ daily_sales_items joiní•œ ì½”ë“œ 0ê°œ

---

## ë°œê²¬ëœ ìœ„í—˜ ìš”ì†Œ

### 1. DataFrame ë³€í™˜ ì˜¤ë²„í—¤ë“œ
- **ìœ„ì¹˜**: `save_daily_close()` ë‚´ë¶€
- **ë¬¸ì œ**: `sales_items` ë¦¬ìŠ¤íŠ¸ë¥¼ DataFrameìœ¼ë¡œ ë³€í™˜í•˜ëŠ” ê³¼ì •
- **ì˜í–¥**: ì„±ëŠ¥ ì €í•˜ ê°€ëŠ¥ì„± (í•˜ì§€ë§Œ ë§ˆê° ì €ì¥ì€ ë¹ˆë²ˆí•˜ì§€ ì•ŠìŒ)
- **ìš°ì„ ìˆœìœ„**: ë‚®ìŒ (ì„±ëŠ¥ íŠœë‹ ê¸ˆì§€)

### 2. ì¬ë£Œëª… â†” ì¬ë£Œ ID ë§¤í•‘
- **ìœ„ì¹˜**: `save_daily_close()` ë‚´ë¶€
- **ë¬¸ì œ**: `calculate_ingredient_usage()`ëŠ” ì¬ë£Œëª… ë°˜í™˜, ì¬ê³  ì°¨ê°ì€ ì¬ë£Œ ID í•„ìš”
- **í•´ê²°**: ì¬ë£Œëª… â†’ ì¬ë£Œ ID ì—­ë§¤í•‘ ë¡œì§ ì¶”ê°€
- **ìš°ì„ ìˆœìœ„**: ì—†ìŒ (ì´ë¯¸ ì²˜ë¦¬ë¨)

### 3. v_daily_sales_items_effective ë·° ì˜ì¡´ì„±
- **ìœ„ì¹˜**: `load_csv('daily_sales_items.csv')` ë‚´ë¶€
- **ë¬¸ì œ**: ë·°ê°€ ì—†ìœ¼ë©´ `daily_sales_items` í…Œì´ë¸”ë¡œ fallback
- **ì˜í–¥**: override ë ˆì´ì–´ê°€ ì‘ë™í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ
- **ìš°ì„ ìˆœìœ„**: ë‚®ìŒ (ì´ë¯¸ fallback ë¡œì§ ì¡´ì¬)

### 4. ë ˆì‹œí”¼ ë°ì´í„° í˜•ì‹ ë³€í™˜
- **ìœ„ì¹˜**: `save_daily_close()` ë‚´ë¶€
- **ë¬¸ì œ**: DBì—ì„œ ë¡œë“œí•œ ë ˆì‹œí”¼ë¥¼ DataFrameìœ¼ë¡œ ë³€í™˜
- **ì˜í–¥**: ë³€í™˜ ê³¼ì •ì—ì„œ ì˜¤ë¥˜ ê°€ëŠ¥ì„±
- **ìš°ì„ ìˆœìœ„**: ë‚®ìŒ (ì—ëŸ¬ ì²˜ë¦¬ í¬í•¨)

---

## í—Œë²• ì¤€ìˆ˜ ìƒíƒœ

### âœ… ì™„ë£Œ
- ëª¨ë“  ì¬ë£Œ ì‚¬ìš©ëŸ‰ ê³„ì‚°ì´ `calculate_ingredient_usage()` í•¨ìˆ˜ ì‚¬ìš©
- `save_daily_close()` ë‚´ë¶€ ì¸ë¼ì¸ ê³„ì‚° ì œê±°
- `v_daily_sales_items_effective` ë·° ê¸°ë°˜ ë°ì´í„° ì‚¬ìš© (load_csv ë‚´ë¶€)
- ì§ì ‘ daily_sales_items joiní•œ ì½”ë“œ ì—†ìŒ

### ğŸ“‹ ë‹¤ìŒ ë‹¨ê³„ ê¶Œê³ 
- ì‹¤ì œ í…ŒìŠ¤íŠ¸ë¡œ ì¬ê³  ì°¨ê° ì •ìƒ ë™ì‘ í™•ì¸
- override íŒë§¤ëŸ‰ ë°˜ì˜ í™•ì¸
- ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ (DataFrame ë³€í™˜ ì˜¤ë²„í—¤ë“œ)

---

**ì‘ì—… ì™„ë£Œì¼**: 2025-01-23  
**ë‹¤ìŒ ë‹¨ê³„**: ì‹¤ì œ í…ŒìŠ¤íŠ¸ ë° ê²€ì¦
