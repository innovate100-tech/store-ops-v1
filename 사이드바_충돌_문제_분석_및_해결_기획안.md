# 사이드바 충돌 문제 분석 및 해결 기획안

## 1. 문제 분석

### 1.1 발견된 문제들

#### 문제 1: 기존 사이드바 강제 열기 JavaScript와의 충돌
- **위치**: `app.py` 645-849줄
- **문제**: 200ms마다 사이드바를 강제로 열고 폭을 덮어쓰는 로직이 접기/펼치기 기능과 충돌
- **증상**: 접기 버튼을 눌러도 사이드바가 다시 펼쳐짐

#### 문제 2: Streamlit 네이티브 사이드바 토글 버튼 활성화
- **증상**: 스크린샷에서 `«`, `»` 버튼이 보임
- **문제**: Streamlit의 기본 사이드바 토글 기능이 여전히 작동하여 커스텀 접기/펼치기와 충돌
- **영향**: 사용자가 혼란스러워하고, 두 가지 토글 메커니즘이 서로 간섭

#### 문제 3: 접힌 상태에서 텍스트가 여전히 표시됨
- **증상**: 접힌 상태에서도 "로그아웃", "캐시 클리어", "운영" 등의 텍스트가 보임
- **원인**: CSS 선택자가 충분히 구체적이지 않거나, Streamlit의 동적 렌더링으로 인해 CSS가 적용되지 않음
- **위치**: `app.py` 387-426줄 (접힌 상태 텍스트 숨김 CSS)

#### 문제 4: 여러 JavaScript 간의 실행 순서 충돌
- **문제**: 
  - 사이드바 강제 열기 JavaScript (645줄)
  - 사이드바 접기/펼치기 상태 관리 JavaScript (851줄)
  - 사이드바 내부 상태 설정 JavaScript (1025줄)
- **영향**: 여러 스크립트가 동시에 사이드바를 조작하여 최종 상태가 불안정

#### 문제 5: CSS 우선순위 문제
- **문제**: Streamlit의 기본 스타일이 커스텀 CSS보다 우선순위가 높을 수 있음
- **증상**: CSS로 설정한 폭이나 숨김 처리가 적용되지 않음

### 1.2 근본 원인

1. **이전 수정의 부작용**: 사이드바 아이콘 영어 문제를 해결하면서 사이드바를 "항상 열린 상태"로 고정하는 로직을 추가했는데, 이것이 새로운 접기/펼치기 기능과 충돌
2. **Streamlit의 제한사항**: Streamlit은 기본적으로 사이드바 접기/펼치기를 지원하지 않으므로, CSS와 JavaScript로 강제 구현해야 하는데, Streamlit의 내부 로직과 충돌
3. **다중 스크립트 간섭**: 여러 JavaScript가 동시에 실행되면서 서로 덮어쓰는 현상

## 2. 해결 방안

### 2.1 기존 사이드바 강제 열기 JavaScript 수정

**목표**: 접힌 상태를 존중하면서도 사이드바가 완전히 사라지지 않도록 보장

**변경 사항**:
1. `forceSidebarOpen()` 함수를 `maintainSidebarState()`로 이름 변경
2. 접힌 상태(`sidebar_collapsed`)를 확인하여 상태에 맞는 폭 설정
3. Streamlit 네이티브 토글 버튼 클릭 시에도 커스텀 상태 유지
4. 실행 주기를 200ms에서 500ms로 조정 (성능 개선)

### 2.2 Streamlit 네이티브 사이드바 토글 버튼 숨김

**목표**: `«`, `»` 버튼을 완전히 숨겨서 사용자가 커스텀 토글만 사용하도록 함

**방법**:
- CSS로 네이티브 토글 버튼 완전히 숨김
- JavaScript로 버튼 클릭 이벤트 차단

### 2.3 접힌 상태 텍스트 숨김 CSS 강화

**목표**: 접힌 상태에서 모든 텍스트가 완전히 숨겨지도록 보장

**방법**:
1. 더 구체적인 CSS 선택자 사용
2. `!important` 플래그 추가
3. 접힌 상태 마커 클래스 활용
4. Streamlit의 동적 렌더링을 고려한 선택자 추가

### 2.4 JavaScript 실행 순서 및 우선순위 정리

**목표**: 여러 JavaScript가 서로 간섭하지 않도록 실행 순서와 우선순위 명확화

**방법**:
1. 사이드바 상태 관리 JavaScript를 최우선으로 실행
2. 사이드바 강제 열기 JavaScript는 상태 관리 후 실행
3. 각 스크립트에 고유한 식별자 추가하여 중복 실행 방지

### 2.5 CSS 우선순위 강화

**목표**: 커스텀 CSS가 Streamlit 기본 스타일보다 우선 적용되도록 보장

**방법**:
1. 더 구체적인 선택자 사용
2. 인라인 스타일과 CSS 조합
3. `!important` 플래그 적절히 사용

## 3. 구현 계획

### 3.1 Phase 1: 기존 JavaScript 수정 및 통합

1. **사이드바 강제 열기 JavaScript 수정**
   - 함수명 변경: `forceSidebarOpen` → `maintainSidebarState`
   - 접힌 상태 감지 로직 추가
   - 상태에 따른 폭 동적 설정
   - 실행 주기 조정

2. **사이드바 접기/펼치기 상태 관리 JavaScript 개선**
   - 실행 타이밍 최적화
   - 상태 변경 감지 로직 강화
   - 다른 JavaScript와의 충돌 방지

### 3.2 Phase 2: Streamlit 네이티브 토글 버튼 처리

1. **CSS로 네이티브 토글 버튼 숨김**
   - 모든 가능한 선택자로 버튼 숨김
   - `display: none !important` 적용

2. **JavaScript로 클릭 이벤트 차단**
   - 네이티브 토글 버튼 클릭 이벤트 리스너 추가
   - 이벤트 전파 차단

### 3.3 Phase 3: 접힌 상태 텍스트 숨김 강화

1. **CSS 선택자 구체화**
   - 접힌 상태 마커 클래스 활용
   - 더 구체적인 선택자 사용
   - 모든 텍스트 요소 타겟팅

2. **JavaScript로 동적 숨김 처리**
   - 접힌 상태일 때 텍스트 요소 직접 숨김
   - MutationObserver로 새로 추가된 요소도 처리

### 3.4 Phase 4: 통합 테스트 및 최적화

1. **충돌 테스트**
   - 여러 시나리오에서 접기/펼치기 동작 확인
   - 페이지 이동 시 상태 유지 확인
   - 브라우저 새로고침 시 상태 확인

2. **성능 최적화**
   - 불필요한 JavaScript 실행 제거
   - 실행 주기 최적화
   - CSS 선택자 최적화

## 4. 예상 결과

### 4.1 정상 동작 시나리오

1. **펼친 상태 → 접힌 상태**
   - "◀ 접기" 버튼 클릭
   - 사이드바 폭이 15rem → 4rem으로 축소
   - 모든 텍스트 숨김, 아이콘만 표시
   - Streamlit 네이티브 토글 버튼 숨김

2. **접힌 상태 → 펼친 상태**
   - "▶ 펼치기" 버튼 클릭
   - 사이드바 폭이 4rem → 15rem으로 확대
   - 모든 텍스트 표시
   - 전체 메뉴 표시

3. **상태 유지**
   - 페이지 이동 시에도 상태 유지
   - 브라우저 새로고침 시 기본값(펼친 상태)으로 리셋

### 4.2 해결될 문제들

- ✅ 접기 버튼 클릭 시 사이드바가 다시 펼쳐지는 문제
- ✅ 접힌 상태에서 텍스트가 여전히 보이는 문제
- ✅ Streamlit 네이티브 토글 버튼과의 충돌
- ✅ 여러 JavaScript 간의 간섭 문제

## 5. 구현 체크리스트

### 5.1 JavaScript 수정
- [ ] `forceSidebarOpen` 함수를 `maintainSidebarState`로 변경
- [ ] 접힌 상태 감지 로직 추가
- [ ] 실행 주기 조정 (200ms → 500ms)
- [ ] 상태 관리 JavaScript 우선순위 설정

### 5.2 CSS 수정
- [ ] Streamlit 네이티브 토글 버튼 숨김
- [ ] 접힌 상태 텍스트 숨김 CSS 강화
- [ ] 더 구체적인 선택자 사용
- [ ] CSS 우선순위 확인

### 5.3 통합 및 테스트
- [ ] 모든 JavaScript 통합 테스트
- [ ] 접기/펼치기 동작 확인
- [ ] 상태 유지 확인
- [ ] 성능 테스트

## 6. 기술적 세부사항

### 6.1 Streamlit 네이티브 토글 버튼 선택자

```css
/* 모든 가능한 네이티브 토글 버튼 선택자 */
button[aria-label*="sidebar"],
button[aria-label*="메뉴"],
button[aria-label*="Menu"],
[data-testid="stHeader"] button:first-child,
header button:first-child
```

### 6.2 접힌 상태 감지 로직

```javascript
// 여러 소스에서 접힌 상태 확인
const collapsedAttr = sidebar.getAttribute('data-sidebar-collapsed');
const collapsedClass = sidebar.classList.contains('sidebar-collapsed');
const collapsedData = sidebar.getAttribute('data-collapsed');
const isCollapsed = collapsedAttr === 'true' || collapsedClass || collapsedData === 'true';
```

### 6.3 텍스트 숨김 우선순위

1. CSS 선택자로 기본 숨김
2. JavaScript로 동적 숨김 (CSS가 적용되지 않는 경우)
3. MutationObserver로 새로 추가된 요소 처리

## 7. 위험 요소 및 대응 방안

### 7.1 위험 요소

1. **Streamlit 업데이트로 인한 호환성 문제**
   - 대응: 버전별 선택자 유지보수

2. **브라우저별 렌더링 차이**
   - 대응: 크로스 브라우저 테스트

3. **성능 저하 가능성**
   - 대응: 실행 주기 최적화, 불필요한 로직 제거

### 7.2 롤백 계획

- 기존 코드 백업
- 단계별 구현으로 문제 발생 시 이전 단계로 롤백 가능

## 8. 다음 단계

1. 기획안 검토 및 승인
2. Phase 1 구현 시작
3. 단계별 테스트 및 검증
4. 최종 통합 및 배포
