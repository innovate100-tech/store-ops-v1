# 재고 입력 페이지 대량 입력 개선안

**작업 일자**: 2026-01-24  
**목적**: 전체 재료를 한 번에 빠르게 등록할 수 있는 UI 개선

---

## 🎯 사용 패턴 분석

### 현재 사용 패턴
- **빈도**: 한 달에 2~3번 점검
- **작업 특성**: 전체 재료의 현재고와 안전재고를 한 번에 등록
- **재료 수**: 수십 개 ~ 수백 개

### 현재 UI의 문제점
1. ❌ 단일 입력: 하나씩 선택해서 입력 → 너무 느림
2. ❌ 일괄 입력: 최대 20개, expander로 하나씩 펼쳐야 함 → 불편함
3. ❌ 전체 재료를 한 번에 볼 수 없음
4. ❌ 빠르게 입력할 수 있는 방식이 없음
5. ❌ 페이지 속도 이슈 가능성 (재료가 많을 경우)

---

## 🚀 개선 방향

### 핵심 원칙
1. **전체 재료를 한 번에 표시**
2. **Excel 스프레드시트처럼 인라인 편집 가능**
3. **일괄 저장으로 빠른 작업 완료**
4. **페이지 속도 최적화** (가상 스크롤, 페이지네이션, 필터링)

---

## 📋 개선안: 3-Zone 구조 (대량 입력 중심)

### **ZONE A: 대시보드 & 빠른 액션**
**목적**: 전체 현황 파악 및 빠른 작업

#### 구성 요소
1. **핵심 지표 카드 (4열)**
   - 전체 재료 수
   - 재고 등록 수
   - 발주 필요 수
   - 미등록 수

2. **빠른 액션 버튼**
   - 💾 전체 저장 (Primary)
   - 📋 기존 재고 불러오기
   - 🔄 초기화
   - 📥 CSV 내보내기 (향후)
   - 📤 CSV 가져오기 (향후)

3. **진행률 표시**
   - 재고 등록률: `등록된 재고 / 전체 재료 × 100%`

---

### **ZONE B: 대량 입력 테이블 (핵심)**
**목적**: 전체 재료를 한 번에 보고 빠르게 입력

#### 테이블 구조
**컬럼 구성**:
1. **재료명** (읽기 전용)
2. **재료 분류** (읽기 전용, 뱃지)
3. **단위** (읽기 전용, 기본 단위 / 발주 단위)
4. **현재고** (입력 가능, 발주 단위)
5. **안전재고** (입력 가능, 발주 단위)
6. **상태** (자동 계산, 색상 뱃지)
7. **기존 재고** (읽기 전용, 참고용)

#### 입력 방식
**옵션 1: Streamlit Data Editor (권장)**
- `st.data_editor()` 사용
- Excel 스프레드시트처럼 직접 편집 가능
- 현재고/안전재고 컬럼만 편집 가능하도록 설정
- 변경된 행만 하이라이트

**옵션 2: 커스텀 테이블 (대안)**
- `st.columns()` + `st.number_input()` 반복
- 각 행을 독립적인 입력 필드로 구성
- 스크롤 가능한 컨테이너로 감싸기

#### 페이지 속도 최적화
1. **페이지네이션**
   - 한 페이지에 50개씩 표시
   - 페이지 이동 버튼
   - 현재 페이지 표시

2. **필터링 (상단 고정)**
   - 재료 분류 필터
   - 재고 등록 상태 필터
   - 검색 (재료명)

3. **지연 로딩**
   - 초기에는 필터링된 데이터만 로드
   - 필요 시에만 전체 데이터 로드

4. **세션 상태 활용**
   - 입력한 데이터는 세션 상태에 저장
   - 페이지 이동해도 입력 데이터 유지

---

### **ZONE C: 저장 & 검증**
**목적**: 입력 데이터 검증 및 저장

#### 구성 요소
1. **저장 전 검증**
   - 필수 입력 확인 (현재고, 안전재고)
   - 숫자 유효성 검사
   - 변경된 항목만 표시

2. **저장 옵션**
   - 전체 저장: 모든 입력 데이터 저장
   - 변경된 항목만 저장: 변경된 행만 저장 (권장)

3. **저장 결과**
   - 성공/실패 개수 표시
   - 실패한 항목 목록 표시

---

## 🎨 UI/UX 디자인

### 레이아웃
```
┌─────────────────────────────────────────┐
│ ZONE A: 대시보드 & 빠른 액션            │
│ [지표 카드 4개] [저장 버튼] [기타 액션] │
└─────────────────────────────────────────┘
┌─────────────────────────────────────────┐
│ 필터 & 검색 (고정)                      │
│ [분류] [등록상태] [검색] [페이지네이션] │
└─────────────────────────────────────────┘
┌─────────────────────────────────────────┐
│ ZONE B: 대량 입력 테이블                │
│ ┌─────────────────────────────────────┐ │
│ │ 재료명 │ 분류 │ 단위 │ 현재고 │ 안전 │ │
│ │ ...    │ ...  │ ...  │ [입력] │ [입력]│ │
│ │ ...    │ ...  │ ...  │ [입력] │ [입력]│ │
│ └─────────────────────────────────────┘ │
│ [이전 페이지] [1/5] [다음 페이지]       │
└─────────────────────────────────────────┘
┌─────────────────────────────────────────┐
│ ZONE C: 저장 & 검증                     │
│ [변경된 항목: 15개] [저장] [초기화]     │
└─────────────────────────────────────────┘
```

### 색상 체계
- **정상**: 초록색 (#22C55E)
- **주의**: 노란색 (#F59E0B)
- **부족**: 빨간색 (#EF4444)
- **미등록**: 회색 (#9CA3AF)
- **변경됨**: 파란색 배경 (#DBEAFE)

---

## 🔄 데이터 흐름

### 1. 초기 로드
1. 재료 목록 로드 (필터링 적용)
2. 기존 재고 정보 로드
3. 세션 상태에 저장
4. 테이블 렌더링

### 2. 입력
1. 사용자가 테이블에서 직접 입력
2. 변경된 행을 세션 상태에 저장
3. 상태 자동 계산 (정상/주의/부족)
4. 변경된 행 하이라이트

### 3. 저장
1. 변경된 항목만 추출
2. 발주 단위 → 기본 단위 변환
3. 일괄 저장 (배치 처리)
4. 캐시 무효화
5. 화면 새로고침

---

## 📊 구현 상세

### Option 1: st.data_editor 사용 (권장)

```python
# 데이터프레임 준비
inventory_input_df = pd.DataFrame({
    '재료명': ingredient_names,
    '재료분류': categories,
    '단위': units,
    '현재고_입력': current_stocks,  # 발주 단위
    '안전재고_입력': safety_stocks,  # 발주 단위
    '상태': statuses,
    '기존_현재고': existing_current,
    '기존_안전재고': existing_safety
})

# 편집 가능한 컬럼 설정
edited_df = st.data_editor(
    inventory_input_df,
    column_config={
        '재료명': st.column_config.TextColumn('재료명', disabled=True),
        '재료분류': st.column_config.TextColumn('재료분류', disabled=True),
        '단위': st.column_config.TextColumn('단위', disabled=True),
        '현재고_입력': st.column_config.NumberColumn('현재고', min_value=0, format="%.2f"),
        '안전재고_입력': st.column_config.NumberColumn('안전재고', min_value=0, format="%.2f"),
        '상태': st.column_config.TextColumn('상태', disabled=True),
        '기존_현재고': st.column_config.NumberColumn('기존 현재고', disabled=True),
        '기존_안전재고': st.column_config.NumberColumn('기존 안전재고', disabled=True),
    },
    hide_index=True,
    num_rows="fixed",
    use_container_width=True,
    key="inventory_input_table"
)

# 변경 감지
if edited_df is not None:
    # 변경된 행 찾기
    changed_rows = edited_df != inventory_input_df
    # 세션 상태에 저장
    st.session_state['inventory_changes'] = edited_df[changed_rows.any(axis=1)]
```

### Option 2: 커스텀 테이블 (대안)

```python
# 페이지네이션
items_per_page = 50
total_pages = (len(ingredient_df) + items_per_page - 1) // items_per_page
current_page = st.session_state.get('inventory_page', 1)

# 페이지네이션 컨트롤
col_prev, col_page, col_next = st.columns([1, 10, 1])
with col_prev:
    if st.button("◀ 이전", disabled=(current_page == 1)):
        st.session_state['inventory_page'] = current_page - 1
        st.rerun()
with col_page:
    st.write(f"페이지 {current_page} / {total_pages}")
with col_next:
    if st.button("다음 ▶", disabled=(current_page == total_pages)):
        st.session_state['inventory_page'] = current_page + 1
        st.rerun()

# 현재 페이지 데이터
start_idx = (current_page - 1) * items_per_page
end_idx = start_idx + items_per_page
page_df = ingredient_df.iloc[start_idx:end_idx]

# 테이블 렌더링
for idx, row in page_df.iterrows():
    ingredient_name = row['재료명']
    # 입력 필드
    col1, col2, col3, col4, col5 = st.columns([3, 2, 2, 2, 2])
    with col1:
        st.write(f"**{ingredient_name}**")
    with col2:
        st.write(f"{unit}")
    with col3:
        current_input = st.number_input(
            "현재고",
            min_value=0.0,
            value=existing_current,
            key=f"inventory_current_{ingredient_name}_{current_page}",
            label_visibility="collapsed"
        )
    with col4:
        safety_input = st.number_input(
            "안전재고",
            min_value=0.0,
            value=existing_safety,
            key=f"inventory_safety_{ingredient_name}_{current_page}",
            label_visibility="collapsed"
        )
    with col5:
        # 상태 표시
        status = calculate_status(current_input, safety_input)
        st.markdown(f'<span style="color: {status_color};">{status}</span>', unsafe_allow_html=True)
    
    # 세션 상태에 저장
    if f"inventory_data_{ingredient_name}" not in st.session_state:
        st.session_state[f"inventory_data_{ingredient_name}"] = {
            'current': current_input,
            'safety': safety_input
        }
```

---

## ⚡ 성능 최적화

### 1. 데이터 로딩 최적화
- 필요한 컬럼만 로드
- 캐시 활용 (`@st.cache_data`)
- 지연 로딩 (필터링된 데이터만)

### 2. 렌더링 최적화
- 페이지네이션으로 한 번에 50개만 렌더링
- 변경된 행만 다시 계산
- 세션 상태 활용으로 불필요한 재렌더링 방지

### 3. 저장 최적화
- 변경된 항목만 저장 (배치 처리)
- 비동기 저장 (선택적)
- 진행률 표시

---

## 🔧 구현 체크리스트

### ZONE A: 대시보드 & 빠른 액션
- [ ] 핵심 지표 카드 (4개)
- [ ] 전체 저장 버튼
- [ ] 기존 재고 불러오기 버튼
- [ ] 초기화 버튼
- [ ] 진행률 표시

### ZONE B: 대량 입력 테이블
- [ ] 필터 & 검색 (고정)
- [ ] 페이지네이션 컨트롤
- [ ] 테이블 렌더링 (st.data_editor 또는 커스텀)
- [ ] 입력 필드 (현재고, 안전재고)
- [ ] 상태 자동 계산
- [ ] 변경된 행 하이라이트

### ZONE C: 저장 & 검증
- [ ] 변경된 항목 개수 표시
- [ ] 저장 전 검증
- [ ] 일괄 저장 기능
- [ ] 저장 결과 표시

### 성능 최적화
- [ ] 페이지네이션 구현
- [ ] 세션 상태 활용
- [ ] 캐시 최적화
- [ ] 변경 감지 최적화

---

## 🚀 향후 개선 사항

### Phase 2
- [ ] CSV 가져오기/내보내기
- [ ] 키보드 단축키 지원 (Tab, Enter)
- [ ] 자동 저장 (일정 시간마다)
- [ ] 변경 이력 추적

### Phase 3
- [ ] 가상 스크롤 (수백 개 재료 대응)
- [ ] 검색 하이라이트
- [ ] 일괄 작업 (안전재고 일괄 변경)
- [ ] 모바일 최적화

---

## 📝 주의사항

1. **세션 상태 관리**
   - 입력 데이터는 세션 상태에 저장
   - 페이지 이동 시에도 유지
   - 저장 후 초기화

2. **변환 비율 처리**
   - 입력: 발주 단위
   - 저장: 기본 단위 (발주 단위 × 변환비율)
   - 표시: 발주 단위

3. **성능 고려**
   - 재료가 많을 경우 페이지네이션 필수
   - 변경된 항목만 저장하여 DB 부하 감소
   - 캐시 활용으로 로딩 속도 개선

---

**작성일**: 2026-01-24  
**담당**: 재고 입력 페이지 대량 입력 개선안
