# PHASE 10 / STEP 10-9: 일일 입력 UX 1플로우 통합 완료

## 작업 개요
점장 마감 / 매출·네이버방문자 보정 / 판매량 보정을 "일일 입력(통합)" 1개 화면으로 통합 완료.
사장은 날짜 선택 → 숫자 입력 → 저장만 하면 되며, 마감/보정/임시 구분은 시스템이 자동 처리.

---

## 생성된 파일

### 신규 파일
- **`ui_pages/daily_input_hub.py`** (신규)
  - 통합 일일 입력 페이지
  - ZONE A: 날짜 & 상태
  - ZONE B: 입력 영역 (매출, 네이버방문자, 판매량)
  - ZONE C: 메모 & 저장

---

## 수정된 파일

### app.py
- **사이드바 카테고리 변경**
  - "🟢 오늘 입력" 카테고리 신규 생성
  - "일일 입력(통합)" 메뉴 추가
  - "🛠 운영 입력 · 관리"에서 다음 항목 제거:
    - "점장 마감" (사이드바 제거, 직접 접근 가능)
    - "매출·네이버방문자 보정" (사이드바 제거, 직접 접근 가능)
    - "판매량 보정" (사이드바 제거, 직접 접근 가능)

- **라우팅 추가**
  - `elif page == "일일 입력(통합)":` 라우팅 추가
  - 기존 페이지 라우팅은 유지 (직접 접근 가능)

---

## 화면 구조

### ZONE A: 날짜 & 상태
- **날짜 선택**: `st.date_input` (기본값: 오늘)
- **상태 자동 판정**:
  - `daily_close` 존재 → "✅ 마감 완료(보정 가능)"
  - `sales/visitors/items`만 존재 → "⚠️ 임시 기록"
  - 아무것도 없음 → "📝 미입력"
- **현재 값 요약**:
  - 총 매출 (best_available 기준)
  - 네이버방문자 (best_available 기준)

### ZONE B: 입력 영역

#### A) 매출
- 카드 매출 (number_input)
- 현금 매출 (number_input)
- 총 매출 (자동 계산: 카드 + 현금)
- 기존 값 자동 로드 (sales 테이블에서)

#### B) 네이버방문자
- 방문자 수 (number_input)
- 기존 값 자동 로드 (naver_visitors 테이블에서)

#### C) 판매량
- 전 메뉴 테이블 (3열 그리드)
- 메뉴별 수량 입력 (number_input)
- 기존 값 자동 로드 (daily_sales_items 테이블에서)
- 0도 저장 (모든 메뉴 저장)

### ZONE C: 메모 & 저장
- 운영 메모 (text_area, 선택사항)
- **[💾 저장]** 버튼
- **[📋 이 날짜 마감하기]** 버튼

---

## 저장 로직

### Case 1: [💾 저장] 버튼 (일반 저장)

#### daily_close 존재 시
- **동작**: "마감 보정"
- **실행**:
  1. `save_sales_entry()` 호출
     - `sales` upsert
     - `naver_visitors` upsert
     - `daily_close` 동기화 (매출 + 네이버방문자만)
  2. `save_daily_sales_item()` 호출 (모든 메뉴, UPSERT + audit)
- **daily_close**: memo, sales_items는 수정하지 않음
- **audit**: 모든 변경사항 기록
- **메시지**: "✅ 공식 마감 매출이 함께 수정되었습니다."

#### daily_close 없음 시
- **동작**: "임시 기록"
- **실행**:
  1. `save_sales_entry()` 호출
     - `sales` upsert
     - `naver_visitors` upsert
     - `daily_close`는 건드리지 않음
  2. `save_daily_sales_item()` 호출 (모든 메뉴, UPSERT + audit)
- **메시지**: "✅ 임시 기록이 저장되었습니다."

### Case 2: [📋 이 날짜 마감하기] 버튼

- **동작**: "공식 마감 생성"
- **실행**:
  1. `save_daily_close()` 호출
     - `daily_close` 생성/업데이트
     - `sales`, `naver_visitors` 파생 동기화
     - `daily_sales_items` UPSERT (모든 메뉴, 0 포함)
     - `issues`, `memo` 저장
- **메시지**: "✅ 마감이 완료되었습니다."

---

## 기존 페이지 처리

### 유지 (사이드바 제거, 직접 접근 가능)
- `ui_pages/manager_close.py` → 라우팅 유지
- `ui_pages/sales_entry.py` → 라우팅 유지
- `ui_pages/sales_volume_entry.py` → 라우팅 유지

**참고**: 기존 코드는 재사용, 사이드바에서만 제거하여 통합 페이지로 유도.

---

## UX 메시지

### 마감 존재 시
- 상태 배지: "✅ 마감 완료(보정 가능)"
- 저장 후: "✅ 공식 마감 매출이 함께 수정되었습니다."
- 안내: "ℹ️ **이미 마감된 날짜입니다.** 이번 저장은 보정 기록으로 반영됩니다."

### 마감 없음 시
- 상태 배지: "⚠️ 임시 기록" 또는 "📝 미입력"
- 저장 후: "✅ 임시 기록이 저장되었습니다."
- 안내: "ℹ️ **임시 기록으로 저장됩니다.** 나중에 마감 시 자동 반영됩니다."

---

## 데이터 정책 준수

### SSOT 정책
- ✅ `daily_close` = 공식 마감 기록
- ✅ `sales` / `naver_visitors` / `daily_sales_items` = 실제 통계 소스
- ✅ 보정 데이터도 통계에 즉시 반영
- ✅ UX에서 "테이블 이름" 노출 금지 (사용자에게는 "마감/보정/임시" 개념만)

### 저장 함수 사용
- ✅ `save_sales_entry()` - 매출/방문자 저장 (daily_close 동기화 포함)
- ✅ `save_daily_sales_item()` - 판매량 저장 (UPSERT + audit)
- ✅ `save_daily_close()` - 마감 생성
- ✅ `get_day_record_status()` - 날짜 상태 확인

---

## 테스트 시나리오

### 시나리오 1: 마감 없는 날 저장
1. 날짜 선택 (마감 없는 날)
2. 매출/방문자/판매량 입력
3. [💾 저장] 클릭
4. **기대 결과**:
   - `sales`, `naver_visitors`, `daily_sales_items` 저장
   - `daily_close`는 생성되지 않음
   - 상태: "⚠️ 임시 기록"
   - 메시지: "✅ 임시 기록이 저장되었습니다."

### 시나리오 2: 마감 있는 날 수정
1. 날짜 선택 (마감 있는 날)
2. 매출/방문자/판매량 수정
3. [💾 저장] 클릭
4. **기대 결과**:
   - `sales`, `naver_visitors`, `daily_sales_items` 저장
   - `daily_close`의 매출/방문자만 동기화
   - `daily_close`의 memo, sales_items는 수정하지 않음
   - 상태: "✅ 마감 완료(보정 가능)"
   - 메시지: "✅ 공식 마감 매출이 함께 수정되었습니다."

### 시나리오 3: 판매량만 수정
1. 날짜 선택 (기존 데이터 있는 날)
2. 판매량만 수정 (매출/방문자는 그대로)
3. [💾 저장] 클릭
4. **기대 결과**:
   - `daily_sales_items`만 UPSERT
   - `sales`, `naver_visitors`는 변경 없음
   - audit 기록 생성

### 시나리오 4: 마감 생성
1. 날짜 선택 (임시 기록 있는 날)
2. 매출/방문자/판매량 입력
3. 메모 입력
4. [📋 이 날짜 마감하기] 클릭
5. **기대 결과**:
   - `daily_close` 생성
   - `sales`, `naver_visitors` 파생 동기화
   - `daily_sales_items` UPSERT
   - 상태: "✅ 마감 완료(보정 가능)"
   - 메시지: "✅ 마감이 완료되었습니다."

### 시나리오 5: 저장 후 분석/홈 반영
1. 통합 페이지에서 저장
2. 홈 페이지로 이동
3. **기대 결과**:
   - 저장한 날짜의 매출/방문자/판매량이 즉시 반영
   - `best_available` 뷰에서 데이터 확인 가능
   - 분석 페이지에서도 반영됨

---

## 완료 체크리스트

- [x] 신규 페이지 생성 (`daily_input_hub.py`)
- [x] 사이드바 카테고리 변경 ("🟢 오늘 입력" 추가)
- [x] 기존 페이지 사이드바 제거 (라우팅은 유지)
- [x] 날짜 상태 자동 판정 구현
- [x] 기존 값 자동 로드 (매출, 방문자, 판매량)
- [x] 저장 로직 분기 (마감 있음/없음)
- [x] 마감 생성 버튼 구현
- [x] UX 메시지 구현
- [x] 에러 처리 강화
- [x] 린트 에러 없음

---

## 사용 예시

```python
# 통합 페이지 진입
render_daily_input_hub()

# ZONE A: 날짜 선택
# - 오늘 날짜 기본 선택
# - 상태 자동 판정 (마감/임시/미입력)

# ZONE B: 입력
# - 매출: 카드/현금 입력 (총 매출 자동 계산)
# - 네이버방문자: 수량 입력
# - 판매량: 전 메뉴 수량 입력

# ZONE C: 저장
# - [💾 저장]: 일반 저장 (보정 또는 임시 기록)
# - [📋 이 날짜 마감하기]: 마감 생성
```

---

## 완료일
2026-01-24
