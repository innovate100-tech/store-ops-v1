# 온보딩 화면이 안 뜨는 문제 해결 가이드

## 🔍 문제 원인

`user_profiles.onboarding_mode` 컬럼이 `NOT NULL DEFAULT 'coach'`로 설정되어 있어서:
- NULL을 설정할 수 없음
- INSERT 시 값을 지정하지 않으면 자동으로 'coach'가 설정됨
- 결과적으로 `needs_onboarding()`가 항상 `False`를 반환

## ✅ 해결 방법

### 1단계: DB 스키마 수정 (필수)

Supabase SQL Editor에서 다음 SQL을 실행하세요:

```sql
-- onboarding_mode 컬럼을 NULL 허용으로 변경
ALTER TABLE user_profiles 
ALTER COLUMN onboarding_mode DROP NOT NULL;
```

또는 생성된 SQL 파일 사용:
- `sql/fix_onboarding_mode_nullable.sql` 파일 내용을 Supabase SQL Editor에서 실행

### 2단계: 기존 사용자의 onboarding_mode를 NULL로 업데이트

새로 가입한 사용자도 기본값 'coach'로 설정되어 있을 수 있으므로, 다음 SQL로 확인하고 수정하세요:

```sql
-- 1. 현재 상태 확인
SELECT 
    id,
    onboarding_mode,
    created_at
FROM user_profiles
ORDER BY created_at DESC
LIMIT 10;

-- 2. onboarding_mode가 'coach'인 사용자를 NULL로 업데이트 (온보딩 미완료로 표시)
UPDATE user_profiles
SET onboarding_mode = NULL
WHERE onboarding_mode = 'coach'
AND created_at > NOW() - INTERVAL '1 day';  -- 최근 1일 이내 생성된 사용자만

-- 또는 모든 사용자를 NULL로 업데이트 (테스트용)
-- UPDATE user_profiles
-- SET onboarding_mode = NULL;
```

### 3단계: 확인

다음 SQL로 확인:

```sql
-- 컬럼이 NULL 허용인지 확인
SELECT 
    column_name,
    is_nullable,
    column_default
FROM information_schema.columns
WHERE table_name = 'user_profiles' 
AND column_name = 'onboarding_mode';

-- 결과: is_nullable이 'YES'여야 함
```

### 4단계: 앱 재시작 및 테스트

1. 앱 재시작
2. 새로 회원가입 또는 기존 계정으로 로그인
3. 온보딩 모드 선택 화면이 표시되는지 확인

---

## 🔧 빠른 해결 (한 번에 실행)

Supabase SQL Editor에서 다음 SQL을 한 번에 실행:

```sql
-- 1. NOT NULL 제약 제거
ALTER TABLE user_profiles 
ALTER COLUMN onboarding_mode DROP NOT NULL;

-- 2. 최근 생성된 사용자의 onboarding_mode를 NULL로 업데이트
UPDATE user_profiles
SET onboarding_mode = NULL
WHERE onboarding_mode = 'coach'
AND created_at > NOW() - INTERVAL '7 days';

-- 3. 확인
SELECT 
    column_name,
    is_nullable,
    column_default
FROM information_schema.columns
WHERE table_name = 'user_profiles' 
AND column_name = 'onboarding_mode';
```

---

## 📝 참고

- `sql/check_onboarding_mode_schema.sql` 파일로 현재 상태를 확인할 수 있습니다
- 스키마 수정 후에는 새로 가입하는 사용자부터 자동으로 NULL이 설정됩니다
- 기존 사용자는 위의 UPDATE 쿼리로 수동 업데이트가 필요합니다
