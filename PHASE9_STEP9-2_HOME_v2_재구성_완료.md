# PHASE 9 / STEP 9-2 — HOME v2 Rebuild 완료

## 📋 작업 목표

홈(사장 계기판)을 "코치 + 학교" 대표 화면으로 리빌드했습니다.
핵심은:
1. 사장이 10초 안에 상태를 판단
2. 이번 달 가장 중요한 문제 1개를 코치가 판결
3. 문제를 바로 해당 설계실/입력 페이지로 연결

**원칙**: 기능 확장 금지 (DB 스키마 변경 없음, 새 페이지 대량 생성 없음, 기존 분석 페이지 리팩토링 없음)

---

## ✅ 완료된 작업

### 1. HOME v2 구조 재구성
- **파일**: `ui_pages/home/home_page.py`
- **변경 내용**: 기존 홈 페이지를 5개 ZONE 구조로 재구성

### 2. 코치 판결 로직 구현
- **파일**: `ui_pages/home/home_verdict.py` (신규 생성)
- **기능**: 이번 달 가장 중요한 문제 1개 자동 판결
- **3개 분류**: 수익 구조 위험, 메뉴 수익 구조 위험, 재료 구조 위험

### 3. 데이터 정책 준수
- **best_available 우선 사용**: 모든 KPI/트렌드는 `v_daily_sales_best_available` VIEW 사용
- **네이버방문자 명칭 통일**: "방문자" → "네이버방문자"로 통일
- **마감률/스트릭**: `daily_close` 기준으로 계산

---

## 📝 HOME v2 구조 (5개 ZONE)

### ZONE 1: 오늘 상태판 (10초 판단)

#### A) KPI 4개 카드 (best_available 기준)
1. **어제 매출** (best_available)
2. **이번 달 누적 매출** (best_available)
3. **이번 달 평균 일매출** (best_available)
4. **객단가** 또는 **네이버방문자(이번 달 누적)** (객단가 우선)

#### B) 상태 스트립 1줄
- 이번 달 마감률 (daily_close)
- 연속 마감 스트릭 (daily_close)
- 미마감 일수 (이번 달 일수 - 마감된 일수)

#### C) 오늘 입력 바로가기 버튼
- [📋 점장마감]
- [💰 매출·네이버방문자 보정]
- [📦 판매량 보정]

---

### ZONE 2: 이번 달 코치 판결 (Verdict)

- **자동 생성 1개 문장** + **근거 2~3개 미니 카드**
- **판결 분류** (3개 중 1개):
  1. **수익 구조 위험** (손익분기/고정비/변동비율)
     - CTA: [💰 수익 구조 설계실] → "목표 비용구조" 페이지
  2. **메뉴 수익 구조 위험** (원가율/공헌이익/저마진 매출 집중)
     - CTA: [💰 메뉴 수익 구조 설계실] → "원가 파악" 페이지
  3. **재료 구조 위험** (원가 TOP 재료 집중/의존)
     - CTA: [🔧 재료 구조 설계실] → "재료 등록" 페이지

---

### ZONE 3: 문제 TOP3 (Action Radar)

- **룰 기반 TOP3 리스트**
- 각 카드에: **제목** / **한줄 설명** / **버튼**
- 버튼은 항상 "설계실 또는 분석 페이지"로 이동

---

### ZONE 4: 가게 구조 스냅샷 (Design Snapshot)

- **3개 점수**:
  1. **메뉴 구조** (메뉴 개수 기준: 10개 이상=A, 5개 이상=B, 3개 이상=C)
  2. **수익 구조** (손익분기점 대비 매출 기준)
  3. **재료 구조** (재료 개수 기준: 20개 이상=A, 10개 이상=B, 5개 이상=C)
- 점수 계산이 없으면 "—"로 표시하고 "진단 준비중" 문구 + 해당 설계실 이동 버튼 제공

---

### ZONE 5: 사장 학교 1줄 (School Strip)

- **1줄 개념 카드** (랜덤 또는 룰 기반)
- 예: "손익분기점은 목표가 아니라 생존선입니다."
- [더보기] 버튼은 향후 확장 포인트로만 남김 (기능 구현 최소)

---

## 📝 수정된 파일 목록

### 1. `ui_pages/home/home_page.py`
**변경 내용**:
- 라인 34: `home_verdict` import 추가
- 라인 229-298: 기존 코드를 HOME v2 구조로 재구성
  - `_render_zone1_status_board()`: ZONE 1 렌더링
  - `_render_zone2_coach_verdict()`: ZONE 2 렌더링
  - `_render_zone3_action_radar()`: ZONE 3 렌더링
  - `_render_zone4_design_snapshot()`: ZONE 4 렌더링
  - `_render_zone5_school_strip()`: ZONE 5 렌더링

### 2. `ui_pages/home/home_verdict.py` (신규 생성)
**변경 내용**:
- `get_coach_verdict()`: 이번 달 코치 판결 메인 함수
- `_check_revenue_structure_risk()`: 수익 구조 위험 판단
- `_check_menu_profit_risk()`: 메뉴 수익 구조 위험 판단
- `_check_ingredient_structure_risk()`: 재료 구조 위험 판단

### 3. `ui_pages/home/home_data.py`
**변경 내용**:
- 라인 103: 주석 "네이버 유입 기준" → "네이버방문자 기준"

---

## 🔍 데이터 정책 준수 확인

### best_available 기준 사용
- ✅ `load_home_kpis()`: `load_monthly_sales_total()` 사용 (best_available 기반)
- ✅ 어제 매출: `load_best_available_daily_sales()` 사용
- ✅ 이번 달 누적 매출: `load_monthly_sales_total()` 사용 (best_available 기반)
- ✅ 이번 달 평균 일매출: best_available 기반 계산

### 네이버방문자 명칭 통일
- ✅ "방문자" → "네이버방문자"로 통일
- ✅ "네이버 유입 기준" → "네이버방문자 기준"으로 변경

### 마감률/스트릭 계산
- ✅ `get_monthly_close_stats()`: `daily_close` 테이블 기준으로 계산
- ✅ 연속 마감 스트릭: `daily_close` 기준으로 계산

---

## 🎯 코치 판결 로직 상세

### 수익 구조 위험 판단 기준
1. **손익분기점 미달**: 월매출 < 손익분기점
2. **고정비 비율 위험**: 월매출 대비 30% 이상
3. **변동비율 위험**: 50% 이상

**위험 점수**: 3점 이상 시 판결

### 메뉴 수익 구조 위험 판단 기준
1. **고원가율 메뉴**: 원가율 50% 이상 메뉴 3개 이상
2. **저마진 메뉴**: 마진율 20% 미만 메뉴 3개 이상

**위험 점수**: 2점 이상 시 판결

### 재료 구조 위험 판단 기준
1. **재료 집중도**: TOP 3 재료가 전체 사용량의 70% 이상

**위험 점수**: 2점 이상 시 판결

---

## ✅ 앱 실행 시 확인 체크리스트

### ZONE 1: 오늘 상태판
- [ ] KPI 4개 카드 정상 표시 (어제 매출, 이번 달 누적, 평균 일매출, 객단가/네이버방문자)
- [ ] 상태 스트립 1줄 정상 표시 (마감률, 연속 마감, 미마감 일수)
- [ ] 오늘 입력 바로가기 버튼 3개 정상 동작

### ZONE 2: 이번 달 코치 판결
- [ ] 코치 판결 문장 정상 표시
- [ ] 근거 2~3개 미니 카드 정상 표시
- [ ] CTA 버튼 클릭 시 해당 설계실 페이지로 이동

### ZONE 3: 문제 TOP3
- [ ] 문제 TOP3 리스트 정상 표시
- [ ] 각 카드의 버튼 클릭 시 해당 페이지로 이동

### ZONE 4: 가게 구조 스냅샷
- [ ] 3개 점수 카드 정상 표시 (메뉴 구조, 수익 구조, 재료 구조)
- [ ] 점수 없을 때 "—" 및 "진단 준비중" 표시
- [ ] 각 설계실 버튼 클릭 시 해당 페이지로 이동

### ZONE 5: 사장 학교
- [ ] 1줄 개념 카드 정상 표시

### 데이터 정책 확인
- [ ] best_available 기준으로 어제/이번달 누적이 잘 표시되는지 확인
- [ ] 마감률/스트릭 계산이 daily_close 기준인지 확인
- [ ] 네이버방문자 명칭이 통일되어 있는지 확인

---

## 🎯 기대 동작

### 사용자 경험
1. **10초 판단**: ZONE 1에서 핵심 상태를 즉시 파악
2. **코치 판결**: ZONE 2에서 이번 달 가장 중요한 문제 1개를 명확히 제시
3. **즉시 액션**: 각 ZONE의 CTA 버튼으로 바로 해당 페이지로 이동

### 코드 안정성
- 모든 데이터 로더는 기존 함수 재사용
- best_available 기준으로 SSOT 정책 준수
- 기존 페이지 로직 변경 없음

---

## 📌 참고사항

### 코치 판결 로직
- **우선순위**: 수익 구조 위험 > 메뉴 수익 구조 위험 > 재료 구조 위험
- **데이터 부족 시**: "데이터가 부족하여 판결할 수 없습니다." 메시지 표시
- **위험 없음 시**: "이번 달은 구조적으로 안정적인 상태입니다." 메시지 표시

### 가게 구조 스냅샷 점수
- **임시 점수 기준**: 메뉴/재료 개수, 손익분기점 대비 매출
- **향후 개선**: 더 정교한 점수 계산 로직 추가 예정
- **점수 없을 때**: "—" 표시 + "진단 준비중" + 설계실 이동 버튼

### 사장 학교
- **현재**: 랜덤 개념 카드 1개 표시
- **향후 확장**: 더보기 버튼, 개념 카드 라이브러리 확장 예정

---

## 🚀 배포 준비

모든 수정이 완료되었습니다. 다음 단계:
1. ✅ 앱 재시작
2. ✅ ZONE 1-5 각각 정상 표시 확인
3. ✅ 코치 판결 로직 정상 동작 확인
4. ✅ CTA 버튼 클릭 시 페이지 이동 확인
5. ✅ best_available 기준 데이터 정상 표시 확인

---

## 📊 작업 요약

| 항목 | 상태 | 비고 |
|------|------|------|
| HOME v2 구조 재구성 | ✅ 완료 | 5개 ZONE 구조 |
| 코치 판결 로직 구현 | ✅ 완료 | 3개 분류 |
| 데이터 정책 준수 | ✅ 완료 | best_available 우선 |
| 네이버방문자 명칭 통일 | ✅ 완료 | "방문자" → "네이버방문자" |
| 마감률/스트릭 계산 | ✅ 완료 | daily_close 기준 |
| CTA 버튼 연결 | ✅ 완료 | 설계실/분석 페이지 |

---

## ✅ 최종 확인

- [x] HOME v2 구조 재구성 완료 (5개 ZONE)
- [x] 코치 판결 로직 구현 완료 (3개 분류)
- [x] 데이터 정책 준수 완료 (best_available 우선)
- [x] 네이버방문자 명칭 통일 완료
- [x] 마감률/스트릭 계산 완료 (daily_close 기준)
- [x] CTA 버튼 연결 완료
- [ ] 앱 실행 및 동작 확인 (사용자 확인 필요)

**참고**: 
- 모든 데이터는 best_available 기준으로 표시됩니다.
- 코치 판결은 데이터가 충분할 때만 생성됩니다.
- 가게 구조 스냅샷 점수는 임시 기준이며, 향후 개선 예정입니다.
