# Phase 0-1 변경사항 요약

**작성일**: 2026-01-26  
**목표**: 애니메이션이 '먹힐 수 있는 환경' 만들기

---

## 📝 변경 파일 목록

### 1. `app.py`
- **변경 위치**: 
  - 라인 85-95: 애니메이션 CSS 주입 규칙 주석 추가
  - 라인 626-829: Material Icons JS의 setInterval 제한
  - 라인 963-970: 사이드바에 응급모드 토글 추가
  - 라인 877-920: 메뉴에 "🧪 테스트" 섹션 및 "FX Sandbox" 추가
  - 라인 400-430: 사이드바 스크롤 강제 활성화 CSS 추가
  - 라인 1070-1203: 응급모드 CSS 조건부 주입 로직

### 2. `ui_pages/test/__init__.py` (신규)
- 테스트 페이지 모듈 초기화 파일

### 3. `ui_pages/test/fx_sandbox.py` (신규)
- FX Sandbox 테스트 페이지 (Phase 1)

---

## 🔍 각 변경의 이유/리스크

### 1. 응급모드 (Rescue Mode) CSS 격리

**변경 내용**:
- `final_safety_pin_css`를 `rescue_mode`로 변경
- 기본값: OFF (애니메이션 친화 모드)
- `transform: none`, `filter: none`, `backdrop-filter: none` 제거

**이유**:
- 애니메이션을 방해하는 전역 CSS 덮어쓰기 제거
- 필요 시에만 응급모드로 활성화 가능

**리스크**:
- ⚠️ **낮음**: 기존 동작은 응급모드 ON 시 유지
- ⚠️ **주의**: 응급모드 OFF 시 일부 레이아웃 문제가 재발할 수 있음
  - **대응**: 사이드바 토글로 즉시 ON/OFF 가능

**검증 필요**:
- 응급모드 OFF 상태에서 기존 페이지들이 정상 작동하는지 확인
- 애니메이션이 정상 작동하는지 확인

---

### 2. Material Icons JS setInterval 제한

**변경 내용**:
- `setInterval(fixMaterialIcons, 1000)` 제거
- DEV 모드에서만 제한된 횟수(10회) 실행
- PROD 모드에서는 MutationObserver만 사용

**이유**:
- 애니메이션 중단/재시작 가능성 제거
- 성능 개선 (주기적 실행 제거)

**리스크**:
- ⚠️ **낮음**: MutationObserver로 DOM 변경 감지 유지
- ⚠️ **주의**: Material Icons 폰트 적용이 늦을 수 있음
  - **대응**: 즉시 실행 + DOMContentLoaded + load 이벤트로 보완

**검증 필요**:
- Material Icons가 정상적으로 표시되는지 확인
- Expander 화살표 위치가 정상인지 확인

---

### 3. 애니메이션 CSS 주입 규칙 주석 추가

**변경 내용**:
- `app.py` 상단에 주석 블록 추가
- `inject_fx()` 사용 규칙 명시
- 직접 `st.markdown()` 사용 금지 안내

**이유**:
- 개발자 가이드라인 제공
- CSS 계층 관리 강화

**리스크**:
- ✅ **없음**: 주석만 추가

---

### 4. FX Sandbox 페이지 추가

**변경 내용**:
- `ui_pages/test/fx_sandbox.py` 신규 생성
- CSS-only 애니메이션 5개 데모
- `prefers-reduced-motion` 지원
- 독립 구현 (다른 페이지에 영향 없음)

**이유**:
- 애니메이션 패턴 검증 환경 제공
- rerun 안정성 테스트

**리스크**:
- ✅ **없음**: 독립 페이지로 다른 페이지에 영향 없음

---

### 5. 사이드바 스크롤 강제 활성화 (안전 버전 v2)

**변경 내용**:
- `inject_sidebar_premium_css()`에 사이드바 스크롤 CSS + JavaScript 추가
- **문제 1**: 사이드바가 접혀서 시작되고 햄버거 버튼 클릭이 안 먹음 → 해결
- **문제 2**: 스크롤이 처음에는 되다가 멈춤 → 해결

**해결 방법**:
- **CSS**: 내부 컨테이너만 `overflow-y: auto` 조정, `height`는 절대 건드리지 않음
- **JavaScript**: MutationObserver로 동적 감시, `overflow: hidden`이 되면 자동으로 `auto`로 복구
- **안전장치**: 사이드바 루트는 건드리지 않음, Streamlit 기본 동작 보호

**이유**:
- 페이지 이동 후 사이드바 스크롤바가 사라지는 문제 해결
- Streamlit이 동적으로 overflow를 변경하는 것에 대응

**리스크**:
- ⚠️ **낮음**: height는 건드리지 않아 토글 기능 보호
- ⚠️ **주의**: JavaScript가 주기적으로 실행되지만 최소화 (5회 후 중지)

**검증 필요**:
- 사이드바가 정상적으로 열리고 닫히는지 확인
- 햄버거 버튼 클릭이 정상 작동하는지 확인
- 스크롤이 계속 작동하는지 확인 (처음부터 끝까지)
- 여러 페이지 이동 후에도 스크롤이 정상 작동하는지 확인

---

## ✅ 검증 체크리스트

### Phase 0 검증

#### 1. 응급모드 토글 작동 확인
- [ ] 사이드바에 "🚨 응급모드 (Rescue Mode)" 체크박스가 표시되는가?
- [ ] 기본값이 OFF인가?
- [ ] 토글을 ON/OFF할 때 즉시 반영되는가?
- [ ] 응급모드 OFF 시 애니메이션이 정상 작동하는가?
- [ ] 응급모드 ON 시 기존 동작(transform/filter 강제 복구)이 유지되는가?

#### 2. Material Icons 정상 작동 확인
- [ ] Material Icons가 정상적으로 표시되는가?
- [ ] Expander 화살표가 제목 앞에 위치하는가?
- [ ] 콘솔에 에러가 없는가?
- [ ] DEV 모드에서 setInterval이 10회 후 중지되는가?
- [ ] PROD 모드에서 setInterval이 실행되지 않는가?

#### 3. 기존 페이지 정상 작동 확인
- [ ] 홈 페이지가 정상적으로 로드되는가?
- [ ] 입력 허브가 정상적으로 작동하는가?
- [ ] 분석 허브가 정상적으로 작동하는가?
- [ ] 사이드바 네비게이션이 정상 작동하는가?
- [ ] 레이아웃 깨짐이 없는가?

#### 3-1. 사이드바 기본 동작 확인 (우선 확인)
- [ ] 사이드바가 정상적으로 열려서 시작되는가? (접혀있지 않음)
- [ ] 햄버거 버튼이 클릭 가능한가?
- [ ] 햄버거 버튼 클릭 시 사이드바가 열리고 닫히는가?
- [ ] 사이드바 토글 기능이 정상 작동하는가?

#### 3-2. 사이드바 스크롤 작동 확인 (추후 해결)
- [ ] 로그인 직후 사이드바에서 마우스 휠 스크롤이 작동하는가?
- [ ] 홈 페이지에서 사이드바 스크롤이 작동하는가?
- [ ] 입력 허브로 이동 후 사이드바 스크롤이 작동하는가?
- [ ] 분석 허브로 이동 후 사이드바 스크롤이 작동하는가?
- [ ] 여러 페이지를 이동해도 사이드바 스크롤이 계속 작동하는가?
- [ ] 사이드바 스크롤바가 표시되는가? (콘텐츠가 많을 때)

### Phase 1 검증

#### 4. FX Sandbox 페이지 접근
- [ ] 사이드바 "🧪 테스트" 섹션에 "FX Sandbox"가 표시되는가?
- [ ] FX Sandbox 페이지로 이동할 수 있는가?
- [ ] 페이지가 정상적으로 로드되는가?

#### 5. 애니메이션 데모 작동 확인
- [ ] **Fade In**: 요소가 서서히 나타나는가? (0.6초)
- [ ] **Slide In Down**: 위에서 아래로 슬라이드하는가? (0.5초)
- [ ] **Shimmer**: 빛이 흐르는 효과가 반복되는가? (무한 반복)
- [ ] **Pulse**: 크기가 변하며 맥박치는가? (무한 반복)
- [ ] **Hover Scale**: 마우스 오버 시 확대되는가?

#### 6. rerun 안정성 확인
- [ ] "🔄 Rerun 테스트" 버튼 클릭 시 애니메이션이 재시작되는가?
- [ ] 다른 페이지로 이동 후 돌아와도 애니메이션이 정상 작동하는가?
- [ ] 페이지 새로고침 후에도 애니메이션이 정상 작동하는가?

#### 7. 접근성 확인
- [ ] 브라우저 설정에서 "애니메이션 감소" 옵션을 켜면 애니메이션이 비활성화되는가?
  - Chrome: `chrome://settings/accessibility` → "애니메이션 감소" 체크
  - 또는 개발자 도구에서 `prefers-reduced-motion: reduce` 미디어 쿼리 시뮬레이션

#### 8. 독립성 확인
- [ ] FX Sandbox 페이지의 CSS가 다른 페이지에 영향을 주지 않는가?
- [ ] 다른 페이지로 이동해도 레이아웃이 정상인가?

#### 9. 성능 확인
- [ ] 애니메이션이 부드럽게 실행되는가? (60fps)
- [ ] 브라우저 개발자 도구 Performance 탭에서 프레임 드롭이 없는가?
- [ ] 콘솔에 에러/경고가 없는가?

---

## 🚨 알려진 이슈 및 대응

### 이슈 1: 응급모드 토글 변경 시 CSS 재주입 지연
**현상**: 토글을 변경해도 즉시 반영되지 않을 수 있음  
**원인**: `inject_rescue`는 1회 주입이므로 키를 변경해야 함  
**대응**: 키에 모드 상태를 포함 (`rescue_mode_on` / `rescue_mode_off`)  
**상태**: ✅ 해결됨

### 이슈 2: Material Icons 폰트 적용 지연 가능성
**현상**: 일부 아이콘이 늦게 표시될 수 있음  
**원인**: setInterval 제거로 주기적 재적용 없음  
**대응**: 즉시 실행 + DOMContentLoaded + load 이벤트 + MutationObserver 유지  
**상태**: ⚠️ 모니터링 필요

### 이슈 3: 사이드바 스크롤 문제
**현상 1**: 사이드바가 접혀서 시작되고 햄버거 버튼 클릭이 안 먹음  
**원인**: CSS/JavaScript가 Streamlit 기본 동작 방해  
**대응**: 사이드바 스크롤 관련 CSS/JavaScript 완전 제거  
**상태**: ❌ **조사 필요** - 코드 제거 후에도 문제 지속

**현상 2**: 스크롤이 처음에는 되다가 멈춤  
**원인**: Streamlit이 동적으로 overflow를 변경하거나 다른 CSS가 덮어씀  
**대응**: 사이드바 스크롤 관련 코드 완전 제거 (기본 동작 복구 우선)  
**상태**: ⚠️ **임시 비활성화** - 기본 동작 복구 후 별도 해결 필요

**추가 조사 필요**:
- `bootstrap.py`의 `initial_sidebar_state="expanded"` 설정 확인
- 다른 CSS가 사이드바를 건드리는지 확인
- 브라우저 개발자 도구에서 사이드바 요소의 computed style 확인

---

## 📊 다음 단계

### Phase 0 완료 후
- [ ] 모든 검증 체크리스트 통과 확인
- [ ] 문제 발생 시 응급모드로 전환 가능 (토글 사용)

### Phase 1 완료 후
- [ ] FX Sandbox에서 애니메이션 패턴 검증 완료
- [ ] 검증된 패턴을 실제 페이지에 적용 시작

### Phase 2 준비
- [ ] 공통 애니메이션 CSS를 FX 계층에 통합
- [ ] 페이지 진입/퇴장 애니메이션 자동 적용
- [ ] 성능 최적화

---

## 💡 사용 가이드

### 응급모드 사용법
1. 사이드바 하단 "🚨 응급모드 (Rescue Mode)" 체크박스 클릭
2. ON: transform/filter/backdrop-filter 강제 복구 (애니메이션 방해 가능)
3. OFF: 애니메이션 친화 모드 (기본값)

### FX Sandbox 사용법
1. 사이드바 "🧪 테스트" → "FX Sandbox" 클릭
2. 각 애니메이션 데모 확인
3. "🔄 Rerun 테스트" 버튼으로 rerun 안정성 확인
4. 브라우저 설정에서 "애니메이션 감소" 옵션으로 접근성 확인

### 새 애니메이션 추가 시
1. `inject_fx()` 사용 (직접 `st.markdown()` 금지)
2. FX Sandbox에서 먼저 테스트
3. rerun 안정성 확인
4. 접근성 확인 (`prefers-reduced-motion`)

---

**작업 완료일**: 2026-01-26  
**검증 담당**: 사용자 직접 확인 필요
