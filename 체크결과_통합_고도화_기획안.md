# 체크결과·체크히스토리 통합 및 고도화 기획안

**작성 일자**: 2026-01-24  
**목적**: "검진 결과 요약" + "검진 히스토리" 2개 페이지를 **체크결과 / 체크히스토리**로 이름 변경 후 **1개 페이지로 통합**, 기능 고도화

---

## 1. 현재 구조 요약

### 1.1 검진 결과 요약 (→ 체크결과)

- **역할**: 최신 완료 체크 1건 기준 상세 결과 표시
- **데이터**: `health_check_sessions`, `health_check_results`, `health_check_diagnosis`
- **ZONE 구성**:
  - ZONE 0: 헤더 (날짜, 패턴, 종합 점수/등급, 판결 1줄)
  - ZONE 1: 9축 점수 요약 (Q/S/C/P1/P2/P3/M/H/F, 3x3 그리드)
  - ZONE 2: Top3 리스크 (축별 위험 + "바로 고치기" → 설계/매출하락 등)
  - ZONE 3: 권장 액션 Top3 ("실행하기" → 해당 페이지)
  - ZONE 4: 이전 체크 대비 (직전 1회와 축별 변화)
  - ZONE 5: 다음 체크 안내 + "매장 체크리스트 다시하기" / "체크 히스토리 보기"

### 1.2 검진 히스토리 (→ 체크히스토리)

- **역할**: 완료 체크 회차별 리스트 + 축별 변화 추이
- **데이터**: 동일 (sessions, results, diagnosis)
- **구성**:
  - 완료 세션 최근 10개 카드 (날짜, 패턴, 주요 위험/병목, 점수/등급, **"결과 보기"**)
  - "결과 보기" → **검진 결과 요약** 페이지로 이동 + `_health_check_session_id` 전달
  - 세션 ≥2일 때 **축별 변화 표** (축 × 최근 3회차 점수 + 변화 방향)

### 1.3 이슈

- 결과 / 히스토리가 **페이지 2개**로 분리되어, "히스토리 → 특정 회차 결과" 보려면 **페이지 이동** 발생
- "검진" 용어 사용; 사용자 요청에 따라 **체크결과 / 체크히스토리**로 변경
- 축별 추이가 **표** 위주라 트렌드 파악이 어렵고, **회차 선택** UX도 제한적

---

## 2. 이름 변경 및 통합 원칙

### 2.1 이름 변경

| 기존 | 변경 후 |
|------|---------|
| 검진 결과 요약 | **체크결과** |
| 검진 히스토리 | **체크히스토리** |

- **앱 내**  
  - 페이지/라우트: **"체크결과"** 1개만 사용 (통합 페이지).  
  - "체크히스토리"는 **통합 페이지 내 섹션명**으로 사용 (예: "체크 히스토리").
- 사이드바·분석허브·CTA 등에서 "검진 결과 요약" / "검진 히스토리" 노출처는 **"체크결과"** 1개로 통일.

### 2.2 통합 방식

- **단일 페이지**: "체크결과" (`page_key`: `체크결과`)
- **구성**:
  1. **상단**: **선택된 회차의 체크결과** (기본 = 최신 완료 1회)
     - 회차 선택 드롭다운: "이번 체크 (2025-01-20)" / "2025-01-05" / … (최근 10회)
     - 기존 ZONE 0~5에 해당하는 **결과 요약** 표시
  2. **하단**: **체크 히스토리** 섹션
     - 회차 카드 리스트 (기존 히스토리와 동일)
     - 카드 내 **"결과 보기"** → 상단 **선택 회차를 해당 회차로 변경** 후, 같은 페이지 내에서 결과 갱신 (리러닝 시 `session_id` 유지)
- **페이지 이동 없이** "히스토리에서 회차 선택 → 그 회차 결과 바로 보기" 가능하도록 통합.

---

## 3. 통합 페이지 구조 (ZONE)

### 3.1 ZONE A: 회차 선택 + 헤더 (신규 통합)

- **회차 선택**  
  - `st.selectbox` "어떤 체크를 볼까요?"  
    - 옵션: 최근 완료 10회 (예: "2025-01-20 (이번 체크)" / "2025-01-05" / …)  
  - 선택값 → `st.session_state["_health_check_session_id"]`에 저장, 결과/히스토리 모두 이 값 기준.
- **헤더**  
  - 선택된 회차 기준 **ZONE 0** 내용  
    - 완료일, 패턴, 종합 점수/등급, 판결 1줄, 패턴 설명  
- **체크 없음**  
  - 완료 세션 0개 시: "완료된 체크가 없습니다" + "매장 체크리스트 실시하기" CTA (기존과 동일).

### 3.2 ZONE B: 9축 점수 요약 (기존 ZONE 1)

- 선택 회차에 대한 9축 점수 (Q/S/C/P1/P2/P3/M/H/F)  
- 3x3 그리드 + 위험도 배지 유지  
- **개선**:  
  - 선택 회차가 2회차 이후일 경우, **직전 회차 대비 ↑/↓** 작게 표시 (옵션).

### 3.3 ZONE B2: 아니요·애매해요 질문 모아보기 (신규)

- **목적**: 해당 회차에서 **"아니요"** 또는 **"애매해요"**로 답한 질문만 모아서 보여, 개선 포인트를 한눈에 파악.
- **데이터**:  
  - `get_health_answers(session_id)`로 선택 회차 답변 조회  
  - `raw_value IN ('no', 'maybe')` 필터  
  - `QUESTIONS`(questions_bank)에서 `category` + `question_code`로 질문 문구 매핑
- **표시**:  
  - **축(한글)** | **질문** | **답변** (아니요 / 애매해요)  
  - 축별 그룹(예: Q → S → C → …) 정렬, 그 안에서 질문 코드 순  
  - `st.expander` "아니요·애매해요 질문 (N개)" 또는 `st.dataframe`  
  - **메모**가 있으면 함께 표시 (옵션)
- **위치**: ZONE B(9축 점수) 직후. 점수 요약 다음에 "이번 회차에서 보강이 필요한 질문"을 바로 확인할 수 있도록 배치.

### 3.4 ZONE C: Top3 리스크 (기존 ZONE 2)

- 선택 회차 기준 Top3 리스크  
- "바로 고치기" → 기존처럼 해당 설계/매출하락 등 페이지로 이동  
- 로직 변경 없음.

### 3.5 ZONE D: 권장 액션 Top3 (기존 ZONE 3)

- 선택 회차 기준 권장 액션  
- "실행하기" → 해당 페이지 이동  
- 로직 변경 없음.

### 3.6 ZONE E: 이전 체크 대비 (기존 ZONE 4)

- **선택 회차** vs **그 직전 1회**  
- 축별 변화 큰 것만 표시 (기존과 동일).  
- 선택 회차가 "이번 체크"가 아니어도, **그 회차 기준**으로 "직전 대비" 계산.

### 3.7 ZONE F: 체크 히스토리 (기존 히스토리 통합)

- **섹션 제목**: "체크 히스토리"
- **회차 카드 리스트**  
  - 최근 완료 10회  
  - 카드: 날짜, 패턴, 주요 위험/병목, 점수/등급  
  - **"결과 보기"**  
    - 클릭 시 `_health_check_session_id` = 해당 세션 ID로 설정 후 `st.rerun()`  
    - 상단 ZONE A 선택기가 해당 회차로 바뀌고, ZONE B~E가 그 회차 결과로 갱신.
- **축별 변화 추이**  
  - 세션 ≥2일 때 표시  
  - **고도화**:  
    - **테이블**: 기존처럼 축 × 최근 3회 점수 + 변화  
    - **라인 차트(추가)**: X=회차(일자), Y=점수, 9축별 선 (streamlit `line_chart` 또는 유사)  
    - 탭 "표" | "차트" 전환 가능.

### 3.8 ZONE G: 다음 체크 & CTA (기존 ZONE 5 개선)

- **다음 체크 안내**  
  - 권장 주기 (예: 월 2~3회) 안내 문구 유지.
- **CTA**  
  - "매장 체크리스트 다시하기" → 건강검진 실시  
  - "체크 히스토리"는 **같은 페이지 하단**이므로, 버튼 대신 **앵커/스크롤**로 "아래로 이동" 링크 처리 가능 (선택).

---

## 4. 데이터·함수 정리

### 4.1 사용 데이터 (기존 유지)

- `health_check_sessions`: id, completed_at, overall_score, overall_grade, main_bottleneck  
- `health_check_results`: session_id, category(축), score_avg, risk_level  
- `health_check_diagnosis`: session_id, primary_pattern, risk_axes, insight_summary, 권장 액션 등  
- `health_check_answers`: session_id, category, question_code, **raw_value** (yes/maybe/no), memo — **ZONE B2(아니요·애매해요 모아보기)** 에 사용  
- `QUESTIONS`, `CATEGORY_LABELS` (questions_bank): 질문 문구·축 한글명

### 4.2 함수 (기존 활용 + 통합용)

| 함수 | 용도 |
|------|------|
| `get_health_session(session_id)` | 선택 회차 세션 조회 |
| `get_health_results(session_id)` | 선택 회차 9축 점수 |
| `get_health_diagnosis(session_id)` | 선택 회차 판독(패턴, 리스크, 액션) |
| `get_health_answers(session_id)` | 선택 회차 **개별 답변** (category, question_code, raw_value, memo) |
| `_load_latest_completed_session(store_id)` | 기본 "이번 체크" |
| `_load_completed_sessions(store_id, limit=10)` | 히스토리 리스트 + 회차 선택 옵션 |
| `diagnose_health_check(...)` | 판독 없을 때 1회성 생성 (기존 로직) |
| `QUESTIONS`, `CATEGORY_LABELS` (questions_bank) | 질문 문구·축 한글명 매핑 |

### 4.3 통합 페이지 전용

- **`_resolve_display_session(store_id)`**  
  - `_health_check_session_id` 있으면 해당 세션 사용, 없으면 `_load_latest_completed_session`.  
  - 목록에 없는 ID면 최신으로 fallback.
- **회차 선택 옵션**  
  - `_load_completed_sessions(store_id, 10)`으로 `[(session_id, label), ...]` 생성.  
  - `label`: `completed_at` 기반 "YYYY-MM-DD (이번 체크)" / "YYYY-MM-DD".
- **`_no_maybe_questions(session_id)` (ZONE B2용)**  
  - `get_health_answers(session_id)` 조회 후 `raw_value IN ('no', 'maybe')` 필터.  
  - `QUESTIONS[category]`에서 `question_code`로 질문 `text` 매핑.  
  - `raw_value` → 한글: `no` → "아니요", `maybe` → "애매해요".  
  - 반환: `[{ "축", "축한글", "질문", "답변", "memo"?, ... }]` (축·질문코드 순 정렬).

---

## 5. UI/UX 요약

- **페이지 제목**: "체크결과" (상단 헤더)
- **회차 선택**: 상단 selectbox, 변경 시 `_health_check_session_id` 갱신 후 rerun.
- **체크 결과**: ZONE A~E (회차 선택·헤더·9축·**아니요·애매해요 질문 모아보기**·리스크·액션·이전 대비), 선택 회차 기준.
- **체크 히스토리**: ZONE F, 카드 리스트 + "결과 보기"로 **같은 페이지**에서 회차 전환.
- **축별 추이**: 표 + **라인 차트** 탭 전환.
- **CTA**: "매장 체크리스트 다시하기" 등 기존 유지, "체크 히스토리"는 동일 페이지 내 섹션으로 대체.
- **Empty**: 완료 체크 0건 시 "체크결과"만 표시, "실시하기" CTA. 히스토리 섹션은 미표시.

---

## 6. 제거·변경 대상

### 6.1 제거

- **"검진 히스토리" 페이지**  
  - `app.py` 라우팅, 사이드바/분석허브 **"검진 히스토리"** 항목  
  - `render_health_check_history` 호출부  
- **"체크 히스토리 보기" 버튼**  
  - 기존 ZONE 5 "체크 히스토리 보기" → **같은 페이지 하단**이므로 제거 또는 "아래로 스크롤" 링크로 대체.

### 6.2 변경

- **"검진 결과 요약"**  
  - **"체크결과"** 1개 페이지만 유지.  
  - `app.py`, `analysis_hub`, `strategy_card`, `evidence_builder`, `health_check_history` 내 "검진 결과 요약" / "검진 히스토리" → **"체크결과"**로 통일.
- **`health_check_result`**  
  - `render_health_check_result`를 **통합 페이지 렌더**로 확장  
    - `_health_check_session_id` 해석  
    - 회차 선택 UI  
    - ZONE A~G 구성  
- **`health_check_history`**  
  - **삭제**하거나, **통합 페이지용 컴포넌트**만 추출  
    - `_render_session_card`, `_render_axis_trend_table` 등 → `health_check_result`(또는 `health_check_unified`)로 이전.

---

## 7. 구현 순서 제안

| 단계 | 작업 |
|------|------|
| 1 | `_resolve_display_session`, 회차 선택 옵션 헬퍼 구현 |
| 2 | `render_health_check_result`에 회차 선택 UI + ZONE A 반영 |
| 3 | ZONE B~E를 "선택 회차" 기준으로 동작하도록 수정 |
| 4 | **ZONE B2 (아니요·애매해요 질문 모아보기)**: `_no_maybe_questions` 구현, 표·expander UI |
| 5 | ZONE F (체크 히스토리) 통합: 카드 리스트 + "결과 보기" 시 `session_id` 설정 후 rerun |
| 6 | 축별 추이: 테이블 유지 + 라인 차트 탭 추가 |
| 7 | ZONE G CTA 정리 ("체크 히스토리 보기" 제거 또는 스크롤 링크) |
| 8 | "검진 히스토리" 페이지 라우팅·메뉴 제거, "검진 결과 요약" → "체크결과"로 변경 |
| 9 | 분석허브·사이드바·전략카드 등 "체크결과" 1개로 링크 통일 |
| 10 | `health_check_history` 모듈 정리 (로직 이전 후 삭제 또는 deprecated) |

---

## 8. 기대 효과

- **1페이지**에서 "최근 결과 + 과거 회차 결과 + 히스토리" 모두 확인 가능.  
- **회차 선택**으로 이전 체크 결과를 **페이지 이동 없이** 바로 비교.  
- **체크결과 / 체크히스토리** 명칭 통일로 이해도 향상.  
- **축별 추이 차트**로 트렌드 파악 용이.  
- **아니요·애매해요 질문 모아보기**로 해당 회차의 보강 포인트를 한눈에 파악, 개선 액션에 직결.  
- 기존 리스크·액션·CTA 흐름 유지하면서, 진입점과 탐색 경로 단순화.

---

## 9. 정리

- **이름**: 검진 결과 요약 → **체크결과**, 검진 히스토리 → **체크 히스토리**(섹션명).  
- **통합**: **체크결과** 1개 페이지에 **선택 회차 결과** + **체크 히스토리** 통합.  
- **고도화**: 회차 선택기, **아니요·애매해요 질문 모아보기**, 축별 추이 라인 차트, "결과 보기" 시 같은 페이지 내 회차 전환.  
- **라우트/메뉴**: "체크결과" 단일 진입점으로 정리.

---

**작성일**: 2026-01-24  
**참고**: `ui_pages/health_check/health_check_result.py`, `health_check_history.py`, `app.py` 라우팅·메뉴
