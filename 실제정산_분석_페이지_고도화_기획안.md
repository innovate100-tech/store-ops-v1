# 실제정산 분석 페이지 고도화 기획안

**작성 일자**: 2026-01-24  
**목적**: 실제정산 입력 데이터 기반 성과 분석 강화 및 목표 vs 실제 비교 정확도·실용성 제고

---

## 📋 개요

현재 실제정산 분석 페이지는 **목표 vs 실제 요약**, **월간 성적표 상세**, **월별 트렌드(3개월)** 수준입니다.  
또한 **실제 비용 집계**가 `amount`만 합산하고 **변동비(percent)** 를 반영하지 않으며, **카테고리별 비용**에 **목표 비용구조(expense_structure)** 를 쓰는 등 **데이터 소스·계산 로직 오류**가 있습니다.

이 기획안은  
1) **실제정산 데이터(actual_settlement_items + cost_item_templates)** 를 올바르게 활용하고,  
2) **목표 vs 실제** 비교를 **5대 비용·금액/비율·등급**까지 명확히 하며,  
3) **매출·비용 분석** 등 다른 데이터와 연계한 **실질적 인사이트**를 제공하도록  
**실제정산 분석** 페이지를 고도화하는 내용을 담습니다.

---

## 1. 현재 이슈 정리

### 1.1 데이터·계산 오류

| 항목 | 현재 | 문제 | 해결 방향 |
|------|------|------|-----------|
| **실제 비용 합계** | `_total_actual_costs_from_items`: `amount`만 합산 | 변동비 항목은 `percent` 저장 → **총 비용 과소 산출** | `cost_item_templates` + `actual_settlement_items`로 input_type 구분, 고정비·변동비 각각 계산 후 합산 |
| **카테고리별 비용** | `expense_structure`(목표 비용구조) 사용 | **목표** 비용 표시 → 실제정산 분석과 무관 | **실제정산** 기준 카테고리별 집계(템플릿+실제 입력) |
| **월별 트렌드 비용** | `m_costs = sum(amount)` | 동일하게 **percent 미반영** | 월별도 실제정산 기반 올바른 비용 계산 |

### 1.2 기능적 한계

- **목표 vs 실제**: 매출 달성률만 부가 표시, **비용·순이익 목표 대비** 없음.
- **5대 비용 목표 vs 실제**: 카테고리별 **목표 vs 실제 비교·등급** 미제공.
- **트렌드**: 3개월 고정, 6/12개월 선택 없음.
- **실제정산 단독 분석**: 5대 비용 **실제** 구성을 상세히 보는 영역 부족.
- **다른 분석과 연계**: 매출 분석·비용 분석과 동일한 **목표/실제 지표**를 쓰지 않음.

---

## 2. 핵심 개선 사항

### 2.1 실제 비용 계산 로직 정립 (SSOT)

**원칙**: `actual_settlement_items` + `cost_item_templates` + **당월 매출**으로만 실제 비용 산출.

- **고정비(임차료·인건비·공과금)**  
  - `input_type = 'amount'` → `amount` 값 사용.  
  - 카테고리별 `amount` 합 = 해당 카테고리 실제 금액.
- **변동비(재료비·부가세&카드수수료)**  
  - `input_type = 'rate'` → `percent` 값 사용.  
  - **실제 금액 = 당월 매출 × (percent / 100)**.  
  - 카테고리별로 동일 비율 항목 합산 후 매출에 곱해 금액 계산.

**구현**:  
- `settlement_actual`의 `_calculate_category_total` / `_calculate_totals` 로직과 **동일 규칙** 사용.  
- 실제정산 분석용 **공용 헬퍼** 추출(`_actual_costs_from_settlement`) 권장.

### 2.2 목표 vs 실제 비교 강화

- **매출**: 목표 매출, 실제 매출, 달성률(%), 차이(원).
- **비용**:  
  - **목표** = `expense_structure`(목표 비용구조) + 목표 매출  
    - 고정비: 금액 그대로  
    - 변동비: 목표 매출 × 비율  
  - **실제** = 실제정산(위 2.1)  
  - 카테고리별 **목표 금액/비율 vs 실제 금액/비율**, **차이(금액·%p)**, **등급(🟢/🟡/🔴)**.
- **순이익**: 목표 순이익, 실제 순이익, 차이, 이익률(목표 vs 실제).

**등급 기준** (`settlement_actual`의 `_compute_scorecard`와 정합성 유지):

- **변동비**: `diff_rate <= 0` → 🟢, `0 < diff_rate <= 5` → 🟡, `> 5` → 🔴.  
- **고정비**: `diff_amount <= 0` → 🟢, `0 < diff_amount <= 목표의 5%` → 🟡, 그 이상 → 🔴.

### 2.3 5대 비용 실제 구성 상세 (실제정산 단독)

- **실제정산** 데이터만 사용.
- 5대 카테고리(임차료·인건비·공과금·재료비·부가세&카드수수료)별  
  - **금액**, **매출 대비 비율(%)**  
  - 세부 항목(템플릿 기준) **항목명, 금액 or 비율**.
- **바 차트**: 카테고리별 실제 금액.
- **파이/도넛**: 5대 비용 실제 구성 비중.

### 2.4 월별 트렌드 확장

- **기간**: 3개월 고정 → **3 / 6 / 12개월** 선택.
- **지표**: 월별 **매출·실제 비용·순이익** (실제 비용은 2.1 로직 적용).
- **차트**: 라인(매출·비용·순이익) + 선택적 막대(전월 대비 등).

### 2.5 매출·비용 분석과 연계

- **매출 분석**:  
  - 동일한 **목표 매출·실제 매출·달성률** 사용.  
  - “매출 분석에서 보기” 등 **바로가기** 제공.
- **비용 분석**:  
  - **목표 비용구조 vs 실제정산** 비교는 비용 분석 **ZONE F**와 동일한 **데이터 소스·계산** 사용.  
  - 실제정산 분석에서는 “성적표 관점(목표 vs 실제)” 요약, 상세는 비용 분석으로 연결 가능.

### 2.6 인사이트·액션 제안

- **자동 코멘트**  
  - 매출 미달/초과, 비용 초과 카테고리, 순이익 부족 등 한 줄 요약.  
  - `_render_scorecard`의 comments 확장.
- **액션 제안**  
  - “재료비율 초과 → 재료 사용량·단가 점검”, “인건비 초과 → 인력·시급 검토” 등 **우선순위별** 1~3개.

---

## 3. 페이지 구조 (ZONE 구분)

### 3.1 ZONE A: 핵심 지표

- **목표 매출**, **실제 매출**, **달성률(%)**, **차이(원)**  
- **목표 비용**, **실제 비용**, **비용률(목표 vs 실제)**  
- **목표 순이익**, **실제 순이익**, **차이(원)**, **이익률**  
- 목표 미설정 시: “목표 매출·비용 설정 후 표시” 등 안내.

### 3.2 ZONE B: 목표 vs 실제 성적표

- **성적표 요약**  
  - 매출 달성률, 총비용률(목표 vs 실제), 순이익(목표 vs 실제), 이익률 차이.  
  - `_compute_scorecard`와 동일한 구조 사용 권장.
- **5대 비용 목표 vs 실제**  
  - 테이블: 카테고리 | 목표 금액 | 실제 금액 | 차이 | 목표 비율 | 실제 비율 | 차이(%p) | 등급.  
  - 색상: 🟢/🟡/🔴.
- **한 줄 코멘트**  
  - 매출·비용·이익 요약 문장.

### 3.3 ZONE C: 5대 비용 실제 구성 (실제정산 단독)

- **실제정산** 기준 5대 카테고리별 **금액·비율**.
- **차트**: 카테고리별 실제 금액(바), 구성 비중(파이/도넛).
- **세부 항목**  
  - 템플릿별 항목명 + 금액 or 비율(펼치기/탭 등).

### 3.4 ZONE D: 월별 트렌드

- **기간 선택**: 3 / 6 / 12개월.
- **월별 매출·실제 비용·순이익** 테이블 + **라인 차트**.
- 실제 비용은 **2.1** 로직으로 월별 계산.

### 3.5 ZONE E: 인사이트 및 액션

- **자동 진단**  
  - 매출 미달, 비용 초과 카테고리, 순이익 부족 등.
- **액션 제안**  
  - 우선순위별 1~3개, “비용 분석에서 상세 보기” 등 링크.

### 3.6 기타

- **실제정산 미입력 시**: ZONE B/C는 “실제정산 입력 후 표시” 안내 + **실제정산** 페이지 이동 버튼.  
- **목표 미설정 시**: ZONE A/B의 목표 관련 칸만 “목표 미설정” 처리, 실제만 표시.

---

## 4. 데이터 함수 정리 및 증명

### 4.1 실제 비용 계산 (공용)

```text
_actual_costs_from_settlement(store_id, year, month, monthly_sales) → dict
```

- **입력**:  
  - `load_actual_settlement_items(store_id, year, month)`  
  - `load_cost_item_templates(store_id)`  
  - `monthly_sales` (당월 매출).
- **로직**:  
  - 템플릿의 `category` + `input_type`(또는 카테고리 기본값) 사용.  
  - `input_type == 'amount'` → `amount` 합산.  
  - `input_type == 'rate'` → `percent` 합산 후 `monthly_sales * sum(percent)/100`.  
  - 카테고리별 `amount`(실제 금액), `rate`(실제 비율) 반환.
- **출력**:  
  - `{ '임차료': {amount, rate}, ... }`, `total_cost`, `category_totals` 등.  
  - `_calculate_category_total` / `_calculate_totals`와 **동일 결과**가 나오도록 정의.

**증명**:  
- 고정비: `amount`만 사용 → `expense_structure`의 “금액”과 의미 동일.  
- 변동비: `percent`만 사용, `금액 = 매출 × percent/100` → 정의와 일치.

### 4.2 목표 비용 계산 (목표 vs 실제용)

```text
_target_costs_from_structure(store_id, year, month, target_sales, actual_sales)
```

- **입력**:  
  - `load_expense_structure(year, month, store_id)`  
  - `target_sales`, `actual_sales` (목표 매출, 실제 매출).
- **로직**:  
  - 고정비: `expense_structure` 금액 합.  
  - 변동비: `expense_structure` 비율 합 → **목표 금액**은 `target_sales * rate/100`, **실제 매출 기준 목표 대응 금액**이 필요하면 `actual_sales * rate/100` 사용.  
  - `_normalize_targets`와 동일 규칙.
- **출력**:  
  - `{ '임차료': {amount, rate}, ... }`, `target_total_cost`.

### 4.3 성적표 계산 (목표 vs 실제)

```text
_settlement_scorecard(store_id, year, month) → dict
```

- **입력**:  
  - `_actual_costs_from_settlement(...)`  
  - `_target_costs_from_structure(...)`  
  - `load_monthly_sales_total`, `targets`.
- **로직**:  
  - `_compute_scorecard`와 동일한 비교·등급 규칙.  
  - 매출 달성률, 비용(목표 vs 실제), 순이익(목표 vs 실제), 카테고리별 비교·등급.
- **출력**:  
  - `sales`, `total_cost`, `profit`, `comparisons`(카테고리별), `comments` 등.

**증명**:  
- 실제 비용: 4.1.  
- 목표 비용: 4.2.  
- 등급: `_compute_scorecard` 규칙 문서화 후 동일 적용.

---

## 5. UI/UX 요약

- **연·월 선택**: 상단 유지.  
- **ZONE 간 구분**: `render_section_header` / `render_section_divider` 사용 (매출·비용 분석과 동일).  
- **테이블**:  
  - 목표 vs 실제 테이블은 **정렬 가능**, **등급** 컬럼 색상(🟢/🟡/🔴) 유지.  
- **차트**:  
  - 5대 비용 실제 구성을 **바 차트**·**파이/도넛**으로 표시.  
  - 트렌드는 **라인 차트** 위주.  
- **실제정산/목표 미입력 시**:  
  - 해당 ZONE 안내 문구 + **실제정산**·**목표 매출/비용** 입력 페이지로 이동 버튼.

---

## 6. 구현 순서 제안

| 단계 | 작업 | 비고 |
|------|------|------|
| 1 | **실제 비용 계산 수정** | `_actual_costs_from_settlement` 구현, `_total_actual_costs_from_items` 제거 및 교체 |
| 2 | **목표 비용·성적표** | `_target_costs_from_structure`, `_settlement_scorecard` 구현 (또는 `_compute_scorecard` 공용화) |
| 3 | **ZONE A** | 핵심 지표(매출·비용·순이익 목표 vs 실제) 반영 |
| 4 | **ZONE B** | 목표 vs 실제 성적표, 5대 비용 비교 테이블·등급 |
| 5 | **ZONE C** | 5대 비용 실제 구성 상세, 차트, 세부 항목 |
| 6 | **ZONE D** | 월별 트렌드 3/6/12개월, 실제 비용 로직 적용 |
| 7 | **ZONE E** | 인사이트·액션 제안 |
| 8 | **연계** | 매출·비용 분석 링크, 동일 지표 사용 처리 |

---

## 7. 기대 효과

- **정확한 실제 비용**: 변동비(percent) 반영으로 **월 비용·순이익** 산출 정확도 확보.  
- **명확한 목표 vs 실제**: 5대 비용·금액/비율·등급까지 한 화면에서 파악.  
- **실제정산 전용 분석**: 5대 비용 **실제** 구성 상세로 “우리 가게 실제 구조” 이해 용이.  
- **트렌드 활용**: 6/12개월로 **중기 추이** 확인 가능.  
- **매출·비용 분석과 일관성**: 동일한 목표/실제·비용 정의 사용으로 **지표 통일**.

---

## 8. 정리

### 핵심 원칙

1. **실제정산 SSOT**: 실제 비용·카테고리별 집계는 **actual_settlement_items + templates + 당월 매출**만 사용.  
2. **목표 vs 실제 명확화**: 목표 = 비용구조 + 목표 매출, 실제 = 실제정산, **등급·차이**까지 표시.  
3. **금액/비율 구분**: 고정비(금액), 변동비(비율→금액)를 혼동하지 않도록 **함수·UI**에서 일관 적용.  
4. **다른 분석과 연계**: 매출·비용 분석과 **동일 계산·지표** 사용, 필요 시 상호 링크.

### 다음 단계

1. 기획안 검토 및 확정  
2. `_actual_costs_from_settlement` 등 **데이터 함수** 구현 및 단위 검증  
3. ZONE A → B → C → D → E 순으로 UI 적용  
4. 실제정산·목표 미입력 등 **엣지 케이스** 확인  
5. 매출·비용 분석과 **지표·링크** 정합성 검증  

---

**작성일**: 2026-01-24  
**참고**:  
- `ui_pages/analysis/settlement_analysis.py` (현재)  
- `ui_pages/settlement_actual.py` (`_calculate_totals`, `_compute_scorecard`, `_normalize_targets`)  
- `비용_분석_페이지_고도화_기획안.md` (목표 vs 실제 비교)  
- `매출_분석_페이지_고도화_기획안.md` (ZONE 구조)
