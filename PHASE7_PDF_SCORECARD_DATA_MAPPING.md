# PHASE 7-2 — PDF 성적표 데이터 매핑 & 구조 설계

## 📋 설계 개요

### PDF 성적표의 정체성
- ❌ 회계 리포트
- ❌ 매출표
- ✅ **"매장의 현재 위치 지도"**

### 핵심 원칙 (PHASE 7-1 문장 헌법)
1. 판단보다 먼저 '구조'를 보여준다
2. 숫자는 항상 '의미 문장'과 함께 간다
3. 비교는 '내 가게의 변화' 중심
4. 모든 페이지는 사장의 질문에 답해야 한다

---

## A. PDF 전체 구조 (8페이지)

| 페이지 | 이름 | 핵심 질문 | 역할 |
|--------|------|----------|------|
| **1P** | 표지 | "이 가게는 어떤 가게인가?" | 정체성 선언 |
| **2P** | 매장 요약 | "이번 달 가게 상태는?" | 현황 요약 |
| **3P** | 매출 흐름 | "장사력은 어떤가?" | 흐름 분석 |
| **4P** | 손익 구조 | "생존선은 어디인가?" | 구조 이해 |
| **5P** | 원가 구조 | "체력은 어떤가?" | 원가 분석 |
| **6P** | 문제 & 잘한 점 | "무엇을 고쳐야 하나?" | 문제 발견 |
| **7P** | 메뉴 구조 | "메뉴는 건강한가?" | 메뉴 분석 |
| **8P** | 코치 총평 | "다음 달은 어떻게 할 것인가?" | 전략 제안 |

---

## B. 페이지별 숫자 블록 설계

### 1P. 표지

**핵심 질문**: "이 가게는 어떤 가게인가?"

**역할**: 정체성 선언

**숫자 블록**:

#### [가게 기본 정보]
- **의미**: 가게 이름, 기간
- **데이터 출처**: `stores` 테이블 (name)
- **현재 구조로 가능?**: ✅ O
- **보완 필요 사항**: 없음

#### [이번 달 핵심 숫자 1줄]
- **의미**: "이번 달은 X만원 매출, Y만원 이익"
- **데이터 출처**: 
  - 매출: `sales` 테이블 (월합계) 또는 `load_monthly_sales_total()`
  - 이익: `actual_settlement` 테이블 (영업이익)
- **현재 구조로 가능?**: ✅ O
- **보완 필요 사항**: 없음

---

### 2P. 매장 요약

**핵심 질문**: "이번 달 가게 상태는?"

**역할**: 현황 요약

**숫자 블록**:

#### [이번 달 매출]
- **의미**: 총 매출액
- **계산식/SSOT**: `load_monthly_sales_total(store_id, year, month)`
- **사용 테이블**: `sales` 테이블
- **현재 구조로 가능?**: ✅ O
- **보완 필요 사항**: 없음

#### [이번 달 영업이익]
- **의미**: 실제 남은 돈
- **계산식/SSOT**: `actual_settlement` 테이블의 `operating_profit`
- **사용 테이블**: `actual_settlement`
- **현재 구조로 가능?**: ✅ O (actual_settlement 존재 시)
- **보완 필요 사항**: 없음

#### [손익분기점]
- **의미**: 생존선
- **계산식/SSOT**: `calculate_break_even_sales(store_id, year, month)`
- **사용 테이블**: `expense_structure` 또는 `actual_settlement`
- **현재 구조로 가능?**: ✅ O
- **보완 필요 사항**: 없음

#### [목표 달성률]
- **의미**: 목표 대비 달성 정도
- **계산식/SSOT**: (실제 매출 / 목표 매출) × 100
- **사용 테이블**: `sales` (실제), `targets` (목표)
- **현재 구조로 가능?**: ✅ O
- **보완 필요 사항**: 없음

#### [마감률]
- **의미**: 기록 습관 지표
- **계산식/SSOT**: (마감 일수 / 총 일수) × 100
- **사용 테이블**: `daily_close`
- **현재 구조로 가능?**: ✅ O
- **보완 필요 사항**: 없음

#### [이번 달 상태 한 줄]
- **의미**: "구조 안정 + 운영 리듬 양호" 같은 요약
- **계산식/SSOT**: `get_month_status_summary()` (홈에서 사용 중)
- **사용 테이블**: `get_problems_top3()`, `get_anomaly_signals()`, `actual_settlement`
- **현재 구조로 가능?**: ✅ O
- **보완 필요 사항**: 없음

---

### 3P. 매출 흐름

**핵심 질문**: "장사력은 어떤가?"

**역할**: 흐름 분석

**숫자 블록**:

#### [일별 매출 그래프]
- **의미**: 매출 흐름 시각화
- **계산식/SSOT**: `sales` 테이블 일별 집계
- **사용 테이블**: `sales` (date, total_sales)
- **현재 구조로 가능?**: ✅ O
- **보완 필요 사항**: 없음

#### [요일별 평균 매출]
- **의미**: 요일 패턴
- **계산식/SSOT**: 요일별 그룹핑 후 평균
- **사용 테이블**: `sales` (date → 요일 추출)
- **현재 구조로 가능?**: ✅ O
- **보완 필요 사항**: 없음

#### [전월 대비 변화율]
- **의미**: 매출 증가/감소 추세
- **계산식/SSOT**: ((이번 달 매출 - 전월 매출) / 전월 매출) × 100
- **사용 테이블**: `sales` (이번 달, 전월)
- **현재 구조로 가능?**: ✅ O
- **보완 필요 사항**: 없음

#### [최근 3일 vs 직전 3일 비교]
- **의미**: 단기 흐름 변화
- **계산식/SSOT**: 최근 3일 평균 vs 직전 3일 평균
- **사용 테이블**: `sales`
- **현재 구조로 가능?**: ✅ O
- **보완 필요 사항**: 없음

#### [객단가]
- **의미**: 손님당 평균 결제액
- **계산식/SSOT**: 총 매출 / 총 방문자 수
- **사용 테이블**: `sales` (total_sales), `daily_close` (visitors)
- **현재 구조로 가능?**: ✅ O
- **보완 필요 사항**: 없음

#### [매출 흐름 문장]
- **의미**: "최근 3일 평균이 직전 기간 대비 X% 증가/감소"
- **계산식/SSOT**: `get_coach_summary()` 로직 활용
- **사용 테이블**: `sales`
- **현재 구조로 가능?**: ✅ O
- **보완 필요 사항**: 없음

---

### 4P. 손익 구조

**핵심 질문**: "생존선은 어디인가?"

**역할**: 구조 이해

**숫자 블록**:

#### [고정비]
- **의미**: 매출과 관계없이 나가는 돈
- **계산식/SSOT**: `get_fixed_costs(store_id, year, month)`
- **사용 테이블**: `expense_structure` 또는 `actual_settlement`
- **현재 구조로 가능?**: ✅ O
- **보완 필요 사항**: 없음

#### [변동비율]
- **의미**: 매출 대비 변동비 비율
- **계산식/SSOT**: `get_variable_cost_ratio(store_id, year, month)`
- **사용 테이블**: `expense_structure` 또는 `actual_settlement`
- **현재 구조로 가능?**: ✅ O
- **보완 필요 사항**: 없음

#### [손익분기점 매출]
- **의미**: 생존선
- **계산식/SSOT**: `calculate_break_even_sales(store_id, year, month)`
- **사용 테이블**: `expense_structure` 또는 `actual_settlement`
- **현재 구조로 가능?**: ✅ O
- **보완 필요 사항**: 없음

#### [실제 매출 vs 손익분기점]
- **의미**: 생존선 대비 위치
- **계산식/SSOT**: 실제 매출 - 손익분기점
- **사용 테이블**: `sales`, `calculate_break_even_sales()`
- **현재 구조로 가능?**: ✅ O
- **보완 필요 사항**: 없음

#### [매출 구간별 예상 이익]
- **의미**: "매출 X만원이면 이익 Y만원"
- **계산식/SSOT**: `get_store_financial_structure()`의 `example_table`
- **사용 테이블**: `expense_structure` 또는 `actual_settlement`
- **현재 구조로 가능?**: ✅ O
- **보완 필요 사항**: 없음

#### [구조 문장]
- **의미**: "이 가게는 매출 X만원부터 흑자, 10만원 늘면 Y만원 남는 구조"
- **계산식/SSOT**: `get_store_financial_structure()` 로직
- **사용 테이블**: `expense_structure` 또는 `actual_settlement`
- **현재 구조로 가능?**: ✅ O
- **보완 필요 사항**: 없음

---

### 5P. 원가 구조

**핵심 질문**: "체력은 어떤가?"

**역할**: 원가 분석

**숫자 블록**:

#### [총 원가]
- **의미**: 재료비 총합
- **계산식/SSOT**: `calculate_ingredient_usage()` → 총 사용 단가
- **사용 테이블**: `v_daily_sales_items_effective`, `recipes`, `ingredient_master`
- **현재 구조로 가능?**: ✅ O
- **보완 필요 사항**: 없음

#### [원가율]
- **의미**: 매출 대비 원가 비율
- **계산식/SSOT**: (총 원가 / 총 매출) × 100
- **사용 테이블**: `calculate_ingredient_usage()`, `sales`
- **현재 구조로 가능?**: ✅ O
- **보완 필요 사항**: 없음

#### [재료별 사용량 TOP 10]
- **의미**: 가장 많이 쓰는 재료
- **계산식/SSOT**: `calculate_ingredient_usage()` → 정렬
- **사용 테이블**: `v_daily_sales_items_effective`, `recipes`, `ingredient_master`
- **현재 구조로 가능?**: ✅ O
- **보완 필요 사항**: 없음

#### [재료별 사용 단가 TOP 10]
- **의미**: 돈이 가장 많이 나가는 재료
- **계산식/SSOT**: `calculate_ingredient_usage()` → 총사용단가 정렬
- **사용 테이블**: `v_daily_sales_items_effective`, `recipes`, `ingredient_master`
- **현재 구조로 가능?**: ✅ O
- **보완 필요 사항**: 없음

#### [ABC 분석]
- **의미**: 재료 중요도 분류
- **계산식/SSOT**: `abc_analysis()` (analytics.py)
- **사용 테이블**: `calculate_ingredient_usage()` 결과
- **현재 구조로 가능?**: ✅ O
- **보완 필요 사항**: 없음

#### [원가 구조 문장]
- **의미**: "이번 달 원가율은 X%, 목표 대비 Y%p 차이"
- **계산식/SSOT**: 실제 원가율 vs 목표 원가율
- **사용 테이블**: `calculate_ingredient_usage()`, `targets`
- **현재 구조로 가능?**: ✅ O
- **보완 필요 사항**: 없음

---

### 6P. 문제 & 잘한 점

**핵심 질문**: "무엇을 고쳐야 하나?"

**역할**: 문제 발견

**숫자 블록**:

#### [문제 TOP 3]
- **의미**: 발견된 문제점
- **계산식/SSOT**: `get_problems_top3(store_id)`
- **사용 테이블**: `sales`, `daily_close`, `v_daily_sales_items_effective`
- **현재 구조로 가능?**: ✅ O
- **보완 필요 사항**: 없음

#### [잘한 점 TOP 3]
- **의미**: 잘 유지되고 있는 점
- **계산식/SSOT**: `get_good_points_top3(store_id)`
- **사용 테이블**: `sales`, `daily_close`, `v_daily_sales_items_effective`
- **현재 구조로 가능?**: ✅ O
- **보완 필요 사항**: 없음

#### [이상 징후]
- **의미**: 조기 경보 신호
- **계산식/SSOT**: `get_anomaly_signals(store_id)`
- **사용 테이블**: `sales`, `daily_close`, `v_daily_sales_items_effective`
- **현재 구조로 가능?**: ✅ O
- **보완 필요 사항**: 없음

#### [행동 연결 문장]
- **의미**: "이 문제는 보통 요일/메뉴/객단가 흐름에서 원인이 보입니다"
- **계산식/SSOT**: 문제 유형별 고정 템플릿 (홈에서 사용 중)
- **사용 테이블**: 없음 (문장 템플릿)
- **현재 구조로 가능?**: ✅ O
- **보완 필요 사항**: 없음

---

### 7P. 메뉴 구조

**핵심 질문**: "메뉴는 건강한가?"

**역할**: 메뉴 분석

**숫자 블록**:

#### [메뉴별 판매량 TOP 10]
- **의미**: 가장 많이 팔린 메뉴
- **계산식/SSOT**: `v_daily_sales_items_effective` → 메뉴별 합계
- **사용 테이블**: `v_daily_sales_items_effective`
- **현재 구조로 가능?**: ✅ O
- **보완 필요 사항**: 없음

#### [메뉴별 매출 TOP 10]
- **의미**: 매출 기여도가 높은 메뉴
- **계산식/SSOT**: 메뉴별 판매량 × 판매가
- **사용 테이블**: `v_daily_sales_items_effective`, `menu_master`
- **현재 구조로 가능?**: ✅ O
- **보완 필요 사항**: 없음

#### [메뉴별 이익 TOP 10]
- **의미**: 실제 돈을 만드는 메뉴
- **계산식/SSOT**: 메뉴별 매출 - 메뉴별 원가
- **사용 테이블**: `v_daily_sales_items_effective`, `menu_master`, `recipes`, `ingredient_master`
- **현재 구조로 가능?**: ✅ O
- **보완 필요 사항**: 없음

#### [메뉴별 이익률]
- **의미**: 메뉴의 수익성
- **계산식/SSOT**: (이익 / 매출) × 100
- **사용 테이블**: 메뉴별 매출, 메뉴별 원가
- **현재 구조로 가능?**: ✅ O
- **보완 필요 사항**: 없음

#### [메뉴 쏠림도]
- **의미**: 상위 1개 메뉴가 차지하는 비율
- **계산식/SSOT**: (최대 판매량 / 전체 판매량) × 100
- **사용 테이블**: `v_daily_sales_items_effective`
- **현재 구조로 가능?**: ✅ O
- **보완 필요 사항**: 없음

#### [메뉴 구조 문장]
- **의미**: "메뉴 A가 전체의 60% 차지, 하지만 이익률은 15%"
- **계산식/SSOT**: 메뉴별 판매량/매출/이익 분석
- **사용 테이블**: `v_daily_sales_items_effective`, `menu_master`, `recipes`
- **현재 구조로 가능?**: ✅ O
- **보완 필요 사항**: 없음

---

### 8P. 코치 총평

**핵심 질문**: "다음 달은 어떻게 할 것인가?"

**역할**: 전략 제안

**숫자 블록**:

#### [이번 달 코치 요약]
- **의미**: 전체 상태 요약 문장
- **계산식/SSOT**: `get_coach_summary(store_id)` (홈에서 사용 중)
- **사용 테이블**: `get_problems_top3()`, `get_good_points_top3()`, `get_anomaly_signals()`
- **현재 구조로 가능?**: ✅ O
- **보완 필요 사항**: 없음

#### [핵심 개선 포인트 3개]
- **의미**: 다음 달에 집중할 것
- **계산식/SSOT**: 문제 TOP 3 + 구조 분석 조합
- **사용 테이블**: `get_problems_top3()`, `actual_settlement`, `expense_structure`
- **현재 구조로 가능?**: ✅ O
- **보완 필요 사항**: 없음

#### [다음 달 목표 제안]
- **의미**: "다음 달은 매출 X만원, 이익 Y만원 목표"
- **계산식/SSOT**: 이번 달 실제 + 성장률 가정
- **사용 테이블**: `sales`, `actual_settlement`
- **현재 구조로 가능?**: ✅ O
- **보완 필요 사항**: 없음

#### [성장 시뮬레이션]
- **의미**: "매출이 10% 오르면 이익은 얼마나 오르는가"
- **계산식/SSOT**: (현재 매출 × 1.1) × (1 - 변동비율) - 고정비
- **사용 테이블**: `sales`, `get_fixed_costs()`, `get_variable_cost_ratio()`
- **현재 구조로 가능?**: ✅ O
- **보완 필요 사항**: 없음

#### [코치 총평 문장]
- **의미**: "이 가게는 구조적으로 건강하고, 다음 달은 X에 집중하면 Y가 개선됩니다"
- **계산식/SSOT**: 전체 분석 종합 (룰 기반)
- **사용 테이블**: 모든 분석 결과 종합
- **현재 구조로 가능?**: ✅ O
- **보완 필요 사항**: 없음

---

## C. 현재 시스템 기준 매핑

### SSOT 함수 연결

#### 매출 관련
- `load_monthly_sales_total(store_id, year, month)` → 2P, 3P
- `sales` 테이블 직접 조회 → 3P (일별, 요일별)

#### 손익 구조 관련
- `get_fixed_costs(store_id, year, month)` → 4P
- `get_variable_cost_ratio(store_id, year, month)` → 4P
- `calculate_break_even_sales(store_id, year, month)` → 2P, 4P
- `get_store_financial_structure(store_id, year, month)` → 4P

#### 원가 관련
- `calculate_ingredient_usage(sales_df, recipe_df, ingredient_df)` → 5P
- `abc_analysis(daily_sales_df, menu_df, cost_df)` → 5P

#### 메뉴 관련
- `v_daily_sales_items_effective` 뷰 → 7P
- `menu_master` 테이블 → 7P
- `recipes` 테이블 → 7P

#### 문제/분석 관련
- `get_problems_top3(store_id)` → 6P, 8P
- `get_good_points_top3(store_id)` → 6P, 8P
- `get_anomaly_signals(store_id)` → 6P, 8P
- `get_coach_summary(store_id)` → 8P
- `get_month_status_summary(store_id, year, month)` → 2P

#### 정산 관련
- `actual_settlement` 테이블 → 2P, 4P (영업이익)
- `actual_settlement_items` 테이블 → 4P (비용 상세)

### 테이블 매핑

| 테이블 | 사용 페이지 | 용도 |
|--------|------------|------|
| `sales` | 2P, 3P | 매출 데이터 |
| `daily_close` | 2P, 3P, 6P | 마감률, 방문자 수 |
| `actual_settlement` | 2P, 4P, 8P | 영업이익, 비용 구조 |
| `actual_settlement_items` | 4P | 비용 상세 |
| `expense_structure` | 4P | 목표 구조 (fallback) |
| `v_daily_sales_items_effective` | 5P, 6P, 7P | 판매 내역 |
| `menu_master` | 7P | 메뉴 정보 |
| `recipes` | 5P, 7P | 레시피 |
| `ingredient_master` | 5P | 재료 정보 |
| `targets` | 2P, 5P | 목표 매출, 목표 원가율 |
| `stores` | 1P | 가게 정보 |

---

## D. 위험 구간 표시

### 📗 지금 당장 구현 가능한 MVP PDF 범위

**완전 구현 가능 (8페이지 모두)**:
- ✅ 1P. 표지
- ✅ 2P. 매장 요약
- ✅ 3P. 매출 흐름
- ✅ 4P. 손익 구조
- ✅ 5P. 원가 구조
- ✅ 6P. 문제 & 잘한 점
- ✅ 7P. 메뉴 구조
- ✅ 8P. 코치 총평

**이유**: 모든 필요한 SSOT 함수와 테이블이 이미 존재하며, 홈 화면에서 이미 사용 중인 로직을 재활용 가능

### 📒 구조 보완하면 더 풍부해지는 영역

#### 비교 분석 강화
- **현재**: 전월 대비만 가능
- **보완 후**: 전년 동월 대비, 분기 평균 대비 가능
- **필요 작업**: 과거 데이터 쿼리 최적화

#### 목표 달성 분석 강화
- **현재**: 목표 매출만 비교
- **보완 후**: 목표 원가율, 목표 이익률 등 세부 목표 비교
- **필요 작업**: `targets` 테이블 활용 확대

#### 트렌드 분석 강화
- **현재**: 최근 3일 vs 직전 3일
- **보완 후**: 주간/월간 트렌드, 계절성 분석
- **필요 작업**: 시계열 분석 함수 추가

### 📕 현재 구조로 불가능한 페이지/지표

**없음** ✅

모든 페이지와 지표가 현재 구조로 구현 가능합니다.

---

## E. 구현 우선순위 제안

### Phase 1 (MVP): 핵심 4페이지
1. **2P. 매장 요약** - 가장 중요한 현황
2. **4P. 손익 구조** - 구조 이해의 핵심
3. **6P. 문제 & 잘한 점** - 행동 유도
4. **8P. 코치 총평** - 전략 제안

### Phase 2: 분석 강화
5. **3P. 매출 흐름** - 흐름 분석
6. **5P. 원가 구조** - 원가 분석
7. **7P. 메뉴 구조** - 메뉴 분석

### Phase 3: 완성도 향상
8. **1P. 표지** - 브랜딩

---

## F. 데이터 검증 체크리스트

### 필수 데이터 존재 여부 확인

각 페이지 렌더링 전에 확인:

#### 2P. 매장 요약
- [ ] `sales` 데이터 존재 여부
- [ ] `actual_settlement` 존재 여부 (이익 표시용)
- [ ] `expense_structure` 또는 `actual_settlement` 존재 여부 (손익분기점용)

#### 3P. 매출 흐름
- [ ] `sales` 데이터 최소 3일 이상
- [ ] `daily_close` 데이터 (객단가 계산용)

#### 4P. 손익 구조
- [ ] `expense_structure` 또는 `actual_settlement` 존재 여부
- [ ] 고정비 > 0
- [ ] 변동비율 > 0

#### 5P. 원가 구조
- [ ] `v_daily_sales_items_effective` 데이터 존재
- [ ] `recipes` 데이터 존재
- [ ] `ingredient_master` 데이터 존재

#### 6P. 문제 & 잘한 점
- [ ] `sales` 데이터 최소 6일 이상 (문제 분석용)
- [ ] `daily_close` 데이터 (마감 분석용)

#### 7P. 메뉴 구조
- [ ] `v_daily_sales_items_effective` 데이터 존재
- [ ] `menu_master` 데이터 존재
- [ ] `recipes` 데이터 존재 (이익 계산용)

#### 8P. 코치 총평
- [ ] 모든 위 페이지 데이터 종합 가능 여부

---

## G. PDF 렌더링 고려사항

### 레이아웃
- A4 세로 방향
- 여백: 상하좌우 20mm
- 폰트: 본문 10pt, 제목 14pt, 큰 숫자 18pt

### 색상
- 메인: #667eea (보라)
- 성공: #28a745 (초록)
- 경고: #ffc107 (노랑)
- 위험: #dc3545 (빨강)
- 중립: #6c757d (회색)

### 차트
- 라인 차트: 매출 흐름
- 바 차트: 요일별, 메뉴별
- 파이 차트: 메뉴 비율 (선택적)

### 문장 배치
- 숫자 위에 의미 문장
- 숫자 아래 비교 문장
- 페이지 하단에 핵심 질문 답변

---

## 결론

### 현재 구조 평가
✅ **모든 페이지와 지표가 현재 구조로 구현 가능**

### 핵심 강점
1. SSOT 함수가 잘 구축되어 있음
2. 홈 화면 로직을 재활용 가능
3. 데이터 구조가 PDF 요구사항에 부합

### 다음 단계
1. PDF UI 설계 (PHASE 7-3)
2. PDF 렌더링 코드 구현 (PHASE 7-4)
3. SaaS 유료 기능 통합

**이 문서는 이후 모든 PDF 관련 작업의 기준 문서입니다.**
