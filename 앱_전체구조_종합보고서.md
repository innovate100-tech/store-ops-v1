# 매장 운영 시스템 v1 - 전체 구조 종합 보고서

**작성일**: 2026-01-24  
**목적**: 기획 전문가와의 논의를 위한 앱 전체 구조 문서  
**대상**: 이 문서만으로 앱의 모든 구조, 기능, 데이터 흐름을 이해할 수 있도록 작성

---

## 📋 목차

1. [앱 개요 및 철학](#1-앱-개요-및-철학)
2. [전체 사이드바 카테고리 구조](#2-전체-사이드바-카테고리-구조)
3. [각 페이지 상세 설명](#3-각-페이지-상세-설명)
4. [데이터 구조 및 SSOT 정책](#4-데이터-구조-및-ssot-정책)
5. [주요 기능 흐름](#5-주요-기능-흐름)
6. [기술 스택 및 아키텍처](#6-기술-스택-및-아키텍처)
7. [코드 구조](#7-코드-구조)

---

## 1. 앱 개요 및 철학

### 1.1 앱 한줄 정의
**"외식업 점장을 위한 숫자 기반 운영 코치 시스템 - 매출부터 원가, 발주, 전략까지 자동 진단 및 실행 유도"**

### 1.2 핵심 철학
- **"Coach + School"**: 단순 데이터 입력이 아닌, 문제 진단 → 해결 방향 제시 → 실행 유도
- **"Design System"**: 가게 구조(메뉴/재료/수익)를 설계하는 전략실 개념
- **"Operation Instruction"**: 숫자 중심이 아닌 "오늘 무엇을 해야 하는가" 중심
- **"Single Source of Truth (SSOT)"**: 데이터 일관성 보장, 중복 제거

### 1.3 타겟 유저
- **1차 타겟**: 소규모 외식업 점장 (1-3개 매장 운영)
- **2차 타겟**: 프랜차이즈 본부 (다중 매장 관리)
- **3차 타겟**: 외식업 컨설턴트/회계사

### 1.4 핵심 가치 제안
1. **자동 진단**: 매출/원가/구조 위험 자동 감지
2. **전략 자동 생성**: 가게 상태에 따른 TOP3 전략 카드 제공
3. **실행 로드맵**: 주간 실행 가능한 작업 목록 제공
4. **통합 입력**: 일일 입력을 하나의 화면으로 통합

---

## 2. 전체 사이드바 카테고리 구조

### 2.1 사이드바 카테고리 전체 목록

```
🏠 HOME
├── 홈 (사장 계기판)
└── 전략 보드

🔥 가게 설계 (최상단 고정, Expander)
├── 가게 설계 센터 (통합 진단실)
├── 메뉴 포트폴리오 설계실
├── 메뉴 수익 구조 설계실 (가격·마진)
├── 재료 구조 설계실 (원가 집중 · 대체재 · 발주 구조)
└── 수익 구조 설계실 (가게 전체 돈 구조)

🚨 문제 분석
├── 매출 하락 원인 찾기 (원클릭 플로우)
├── 매출 분석
├── 판매·메뉴 분석
└── 원가 분석

🟢 오늘 입력
└── 일일 입력(통합)

🛠 운영 입력 · 관리
├── 메뉴 관리
├── 재료 관리
├── 레시피 관리
├── 목표 비용 구조(입력)
└── 목표 매출 구조(입력)

📄 성적표 · 리포트
├── 월간 성적표
└── 주간 리포트

👥 운영 도구
├── 직원 연락망
├── 협력사 연락망
└── 게시판
```

### 2.2 카테고리별 역할

| 카테고리 | 역할 | 특징 |
|---------|------|------|
| 🏠 HOME | 진입점 및 전략 요약 | 오늘의 운영 지시, 전략 보드 |
| 🔥 가게 설계 | 전략 설계 및 진단 | 4개 설계실 + 통합 센터 |
| 🚨 문제 분석 | 원인 분석 및 진단 | 매출 하락, 원가, 판매 분석 |
| 🟢 오늘 입력 | 일일 데이터 입력 | 통합 입력 페이지 |
| 🛠 운영 입력 · 관리 | 마스터 데이터 관리 | 메뉴, 재료, 레시피, 목표 |
| 📄 성적표 · 리포트 | 결과 확인 | 월간/주간 리포트 |
| 👥 운영 도구 | 부가 기능 | 연락망, 게시판 |

---

## 3. 각 페이지 상세 설명

### 3.1 🏠 HOME 카테고리

#### 3.1.1 홈 (사장 계기판)
**파일**: `ui_pages/home/home_page.py`  
**라우팅 키**: `"홈"`

**구조 (HOME v3 - 운영 지시 홈)**:
- **ZONE 0: 오늘의 운영 지시** (최상단)
  - 전략 로드맵 1순위 또는 전략 카드 1순위 표시
  - 근거 1줄 (숫자 포함)
  - [지금 실행하기] 버튼
  - [📊 이번 달 전략 보기] 버튼

- **ZONE 1: 이번 달 가게 전략 요약**
  - 가게 상태 (생존/회복/구조/성장)
  - 메인 전략 (한 줄 thesis)
  - 가장 위험한 구조 (메뉴/재료/수익/매출 중 1)
  - [전략 보드 전체 보기], [가게 설계 센터] 버튼

- **ZONE 2: 문제 인식 & 빠른 진입**
  - [🔍 매출 하락 원인 찾기] 버튼
  - [🏗 가게 구조 진단하기] 버튼
  - [🛠 오늘 입력/보정] 버튼

- **ZONE 3: 오늘 상태판** (숫자, 크기 축소)
  - KPI 4개: 어제 매출, 이번 달 누적, 평균 일매출, 객단가
  - 상태 스트립: 마감률, 연속 마감, 미마감 일수

- **ZONE 4: 이번 주 우선순위 TOP3**
  - 로드맵 기반 실행 항목
  - 각 항목: 할 일 문장, 소요시간 배지, [바로 실행] 버튼

- **ZONE 5: 가게 구조 스냅샷**
  - 메뉴 구조 / 메뉴 수익 / 재료 구조 / 수익 구조 점수
  - [가게 설계 센터로] 버튼

**데이터 소스**:
- `v_daily_sales_best_available` (매출 SSOT)
- `classify_store_state()` (가게 상태 분류)
- `build_strategy_cards()` (전략 카드 생성)
- `build_weekly_roadmap()` (주간 로드맵)

#### 3.1.2 전략 보드
**파일**: `ui_pages/strategy/strategy_board.py`  
**라우팅 키**: `"전략 보드"`

**구조**:
- **가게 상태 배지**: 생존/회복/구조/성장 + overall score
- **근거 섹션**: evidence 3개 카드
- **전략 카드 TOP3**: 각 카드에 CTA 버튼
- **이번 주 실행 TOP3**: 로드맵 기반 실행 항목
- **DEV 전용**: debug 정보 표시

**데이터 소스**:
- `classify_store_state()` (10-7A)
- `build_strategy_cards()` (10-7B)
- `build_weekly_roadmap()` (10-7C)

---

### 3.2 🔥 가게 설계 카테고리

#### 3.2.1 가게 설계 센터 (통합 진단실)
**파일**: `ui_pages/design_lab/design_center.py`  
**라우팅 키**: `"가게 설계 센터"`

**구조 (Design Lab 공통 프레임 4층)**:
- **ZONE A: 코치 요약(통합)**
  - 카드 4개 (설계실 4개와 1:1 매핑):
    1. 메뉴 포트폴리오 상태 (균형 점수, 미분류 비율)
    2. 메뉴 수익 구조 상태 (고원가율 메뉴 수, 평균 공헌이익)
    3. 재료 구조 상태 (TOP3 집중도, 고위험 재료 수)
    4. 수익 구조 상태 (손익분기점, 변동비율, 예상매출 대비)
  - 각 카드: 상태 배지 (✅ 안정 / ⚠️ 주의 / 🔴 위험) + [바로가기] 버튼

- **ZONE B: 구조 레이더/요약 맵**
  - 4개 축(포트폴리오/메뉴수익/재료구조/수익구조) 점수/상태 비교 테이블
  - 간단 bar chart

- **ZONE C: 코치 1차 판결**
  - "이번 달 가장 의심되는 구조 1개" 자동 선택
  - 판결문 + 근거 2~3줄 (숫자 포함)
  - CTA: [가장 의심되는 설계실로 이동]

- **ZONE D: 전략 실행 런치패드**
  - 문제 상황별 실행 버튼 3~6개 (개인화 Top3 + 나머지)
  - 예: 매출 하락 원인 찾기, 고원가율 메뉴 정리, 포트폴리오 미분류 정리 등

**데이터 소스**:
- `get_design_center_summary()` (통합 요약)
- `get_primary_concern()` (주요 우려사항)
- `get_design_insights()` (설계 인사이트)

#### 3.2.2 메뉴 포트폴리오 설계실
**파일**: `ui_pages/menu_management.py`  
**라우팅 키**: `"메뉴 등록"`

**구조 (Design Lab 공통 프레임 4층)**:
- **ZONE A: 코치 요약 (Portfolio Verdict)**
  - 총 메뉴 수, 평균 가격, 포트폴리오 균형 점수
  - "미끼/볼륨/마진" 분포 요약
  - 판결문 1줄 + 추천 액션

- **ZONE B: 구조 맵 (Portfolio Map)**
  - 가격대 분포 또는 역할 x 카테고리 매트릭스

- **ZONE C: 사장 학교 (Portfolio Theory)**
  - 고정 카드 3개: 대표/주력/유인/보조 역할, 조합 최적화, 볼륨/마진

- **ZONE D: 설계 도구 (Portfolio Tools)**
  - 메뉴 분류 테이블: 메뉴명, 판매가, 카테고리(대표/주력/유인/보조), 역할(미끼/볼륨/마진)
  - 포트폴리오 권장 조합 가이드
  - 기존 메뉴 등록/수정/삭제 기능

**데이터 저장**:
- `menu_master` 테이블 (카테고리)
- `menu_portfolio_state` 테이블 (역할 태그, DB 저장)

#### 3.2.3 메뉴 수익 구조 설계실 (가격·마진)
**파일**: `ui_pages/menu_profit_design_lab.py`  
**라우팅 키**: `"메뉴 수익 구조 설계실"`

**구조 (Design Lab 공통 프레임 4층)**:
- **ZONE A: 코치 요약**
  - 원가율 35% 초과 메뉴 수
  - 최고/최저 원가율 메뉴
  - 평균 공헌이익
  - 판결문 + 추천 액션

- **ZONE B: 구조 맵**
  - 메뉴별 원가율 분포 (bar chart)
  - 공헌이익 TOP/Bottom 5 표

- **ZONE C: 사장 학교**
  - 고정 카드 3개: 원가율과 공헌이익, 가격의 영향, 미끼/볼륨/마진 조합

- **ZONE D: 설계 도구**
  - 위험 메뉴 테이블 (원가율 >= 35%, 공헌이익 하위)
  - 가격/마진 시뮬레이터
  - 메뉴 역할 태그 (표시만, session_state)

**데이터 소스**:
- `menu_master` (price)
- `recipes` + `ingredients` (원가 계산)

#### 3.2.4 재료 구조 설계실 (원가 집중 · 대체재 · 발주 구조)
**파일**: `ui_pages/ingredient_management.py`  
**라우팅 키**: `"재료 등록"`

**구조 (Design Lab 공통 프레임 4층)**:
- **ZONE A: 코치 요약 (Ingredient Structure Verdict)**
  - 총 재료 수
  - 원가 TOP3 집중도 (%)
  - 고위험 재료 수 (상위 원가 20% + 사용 메뉴 3개 이상)
  - 발주 구조 상태 (안전/주의/위험)
  - 판결문 + 추천 액션

- **ZONE B: 구조 맵**
  - 재료 원가 집중도 Pareto 차트 (70%, 90% 기준선)
  - 재료 영향도 테이블 (재료명, 총 사용금액, 원가 비중 %, 연결 메뉴 수, 위험도)

- **ZONE C: 사장 학교**
  - 고정 카드 3개: 원가 집중도, 대체 불가능 재료 리스크, 발주 구조

- **ZONE D: 설계 도구**
  - 고위험 재료 테이블 (대체 가능 여부 toggle, 발주 유형 selectbox)
  - 대체 구조 설계 패널 (대체 가능 재료 메모, 구조 전략 메모)
  - 기존 재료 관리 기능 (등록, 단가 수정, 단위 관리, 안전재고 설정)

**데이터 저장**:
- `ingredients` 테이블 (기본 정보)
- `ingredient_structure_state` 테이블 (대체 가능, 발주 유형, 메모, DB 저장)

#### 3.2.5 수익 구조 설계실 (가게 전체 돈 구조)
**파일**: `ui_pages/revenue_structure_design_lab.py`  
**라우팅 키**: `"수익 구조 설계실"`

**구조 (Design Lab 공통 프레임 4층)**:
- **ZONE A: 코치 요약 (Coach Board)**
  - 고정비 합계 (이번 달 목표 비용 구조 기반)
  - 변동비율 (재료비율 + 부가세&카드수수료율)
  - 손익분기점 매출 = 고정비 / (1 - 변동비율)
  - 이번 달 예상 매출 (best_available 기반)
  - 판결문 + 추천 액션

- **ZONE B: 구조 맵**
  - 매출 구간별 예상 이익 테이블
  - 손익분기점 vs 예상매출 비교 시각화

- **ZONE C: 사장 학교**
  - 고정 카드 3개: 손익분기점은 생존선, 고정비/변동비, 목표 매출

- **ZONE D: 설계 도구**
  - 구조 파라미터 편집 (읽기+이동 중심)
  - 시나리오 시뮬레이터 (가정 매출 입력 → 즉시 계산)

**데이터 소스**:
- `expense_structure` / `targets` (목표 비용 구조)
- `v_daily_sales_best_available` (이번 달 매출)

---

### 3.3 🚨 문제 분석 카테고리

#### 3.3.1 매출 하락 원인 찾기 (원클릭 플로우)
**파일**: `ui_pages/analysis/sales_drop_investigation.py`  
**라우팅 키**: `"매출 하락 원인 찾기"`

**구조 (3단 플로우)**:
- **STEP 1: 언제부터 떨어졌나?**
  - 기간 선택: [7일/14일/30일] (default 14)
  - 비교 방식: [전주 대비 / 전월 대비] (default 전주)
  - 결과: 하락 시작 추정일, 하락 강도, 최근 추세
  - 요약 카드 3개: 최근 N일 평균 매출, 비교구간 평균 매출, 변화율/변화액
  - 간단 라인차트 (매출 vs baseline)

- **STEP 2: 무엇이 떨어졌나?**
  - KPI 분해:
    - 네이버방문자 변화 (유입)
    - 객단가 변화 (매출/네이버방문자)
    - 판매량 변화 (총 판매수량)
    - 상위메뉴 변화 (Top 메뉴 매출/수량 순위 변동)
  - "원인 후보" 카드 자동 생성 (최대 3개)
  - KPI delta 테이블, 상위메뉴 변화 테이블

- **STEP 3: 어디를 고치나?**
  - 추천 수리 액션 카드 3개 (우선 1개 강조)
  - 각 카드: 제목 + 한 줄 이유(숫자 포함) + CTA 버튼
  - "다른 가능성 보기" expander

**데이터 소스**:
- `v_daily_sales_best_available` (매출 SSOT)
- `daily_sales_items_effective` (판매량)
- `core/sales_drop_engine.py` (분석 엔진)

#### 3.3.2 매출 분석
**파일**: `ui_pages/sales_management.py`  
**라우팅 키**: `"매출 관리"`

**주요 기능**:
- 월별 매출 추이 차트
- 전월 대비 비교
- 예상 매출 계산
- 매출-방문자 상관계수
- 미마감 데이터 포함 경고 배지
- 저장된 매출 내역 표 (date, total_sales, visitors, is_official)

**데이터 소스**:
- `v_daily_sales_best_available` (KPI/트렌드)
- `v_daily_sales_official` (마감률/스트릭)

#### 3.3.3 판매·메뉴 분석
**파일**: `ui_pages/sales_analysis.py`  
**라우팅 키**: `"판매 관리"`

**주요 기능**:
- 메뉴별 판매량 집계
- ABC 분석 (매출 기여도)
- 메뉴별 원가율 표시
- 판매량 추이 차트

#### 3.3.4 원가 분석
**파일**: `ui_pages/cost_overview.py`  
**라우팅 키**: `"원가 파악"`

**주요 기능**:
- 메뉴별 원가/원가율 계산
- 원가율 높은 순 정렬 및 경고 표시 (35% 이상)
- 원가 구성 분석

---

### 3.4 🟢 오늘 입력 카테고리

#### 3.4.1 일일 입력(통합)
**파일**: `ui_pages/daily_input_hub.py`  
**라우팅 키**: `"일일 입력(통합)"`

**구조**:
- **ZONE A: 날짜 & 상태**
  - 날짜 선택 (기본값: 오늘)
  - 상태 자동 판정: 마감 완료(보정 가능) / 임시 기록 / 미입력
  - 현재 값 요약: 총 매출, 네이버방문자

- **ZONE B: 입력 영역**
  - 매출: 카드 매출, 현금 매출, 총 매출 (자동 계산)
  - 네이버방문자: 방문자 수
  - 판매량: 전 메뉴 수량 입력 (3열 그리드)
  - 기존 값 자동 로드

- **ZONE C: 메모 & 저장**
  - 운영 메모 (선택사항)
  - [💾 저장] 버튼: 일반 저장 (보정 또는 임시 기록)
  - [📋 이 날짜 마감하기] 버튼: 마감 생성

**저장 로직**:
- 마감 있는 날: `save_sales_entry()` + `save_daily_sales_item()` → daily_close 동기화
- 마감 없는 날: `save_sales_entry()` + `save_daily_sales_item()` → 임시 기록
- 마감 생성: `save_daily_close()` → 공식 마감 생성

---

### 3.5 🛠 운영 입력 · 관리 카테고리

#### 3.5.1 메뉴 관리
**파일**: `ui_pages/menu_management.py`  
**라우팅 키**: `"메뉴 등록"`  
**참고**: 메뉴 포트폴리오 설계실과 동일 페이지 (Design Lab 프레임 적용)

#### 3.5.2 재료 관리
**파일**: `ui_pages/ingredient_management.py`  
**라우팅 키**: `"재료 등록"`  
**참고**: 재료 구조 설계실과 동일 페이지 (Design Lab 프레임 적용)

#### 3.5.3 레시피 관리
**파일**: `app.py` (인라인 구현)  
**라우팅 키**: `"레시피 등록"`

**주요 기능**:
- 레시피 일괄 등록 (한 메뉴에 여러 재료 한 번에 등록, 최대 30개)
- 레시피 검색 및 수정
- 조리방법 입력 및 저장
- 메뉴별 원가 자동 계산 표시

#### 3.5.4 목표 비용 구조(입력)
**파일**: `ui_pages/target_cost_structure.py`  
**라우팅 키**: `"목표 비용구조"`

**주요 기능**:
- 월별 목표 비용 구조 입력
- 카테고리별 항목 입력 (임차료, 인건비, 재료비, 공과금, 부가세&카드수수료)
- 템플릿 저장/복사 기능

#### 3.5.5 목표 매출 구조(입력)
**파일**: `ui_pages/target_sales_structure.py`  
**라우팅 키**: `"목표 매출구조"`

**주요 기능**:
- 월별 목표 매출 입력
- 목표 대비 실적 비교

---

### 3.6 📄 성적표 · 리포트 카테고리

#### 3.6.1 월간 성적표
**파일**: `ui_pages/settlement_actual.py`  
**라우팅 키**: `"실제정산"`

**주요 기능**:
- 월별 실제 정산 입력
- 비용 항목 템플릿 관리
- 월 매출 자동 불러오기 (best_available 기반)
- 마감률/공식 일수 표시 (official 기준)
- 미마감 데이터 포함 경고
- 구조 리포트 섹션 (월간 구조 리포트)
- 이번 달 구조 점검 완료 처리

#### 3.6.2 주간 리포트
**파일**: `ui_pages/weekly_report.py`  
**라우팅 키**: `"주간 리포트"`

**주요 기능**:
- 기간별 운영 리포트 생성
- PDF 다운로드 기능
- 포함 내용: 총매출, 방문자수, 매출 vs 방문자 추세, 메뉴별 판매 TOP 10, 재료 사용량 TOP 10

---

### 3.7 👥 운영 도구 카테고리

#### 3.7.1 직원 연락망
**파일**: `ui_pages/staff_contacts.py`  
**라우팅 키**: `"직원 연락망"`

#### 3.7.2 협력사 연락망
**파일**: `ui_pages/vendor_contacts.py`  
**라우팅 키**: `"협력사 연락망"`

#### 3.7.3 게시판
**파일**: `ui_pages/board.py`  
**라우팅 키**: `"게시판"`

---

### 3.8 기타 페이지 (사이드바 제거, 직접 접근 가능)

#### 3.8.1 점장 마감
**파일**: `ui_pages/manager_close.py`  
**라우팅 키**: `"점장 마감"`

**주요 기능**:
- 공식 마감 기록 입력
- 매출, 네이버방문자, 판매량, 메모 입력
- 임시 매출/네이버방문자 승격 안내
- `save_daily_close()` 호출

#### 3.8.2 매출·네이버방문자 보정
**파일**: `ui_pages/sales_entry.py`  
**라우팅 키**: `"매출 등록"`

**주요 기능**:
- 매출/네이버방문자 빠른 수정
- 마감된 날짜: daily_close 동기화
- 미마감 날짜: sales/naver_visitors만 저장
- `save_sales_entry()` 호출

#### 3.8.3 판매량 보정
**파일**: `ui_pages/sales_volume_entry.py`  
**라우팅 키**: `"판매량 등록"`

**주요 기능**:
- 판매량 수정/과거 입력
- 전 메뉴 일괄 입력
- `save_daily_sales_item()` 호출 (UPSERT + audit)

---

## 4. 데이터 구조 및 SSOT 정책

### 4.1 핵심 데이터 정책

#### 4.1.1 Single Source of Truth (SSOT)

**매출 데이터 SSOT**:
- **통계/분석/대부분 KPI**: `v_daily_sales_best_available`
  - daily_close 우선, 없으면 sales 사용
  - is_official=false로 미마감 구분
- **마감/공식/루틴 지표**: `v_daily_sales_official`
  - daily_close만 포함
  - 마감률, 연속마감, 공식 메모 기반 지표

**금지 사항**:
- ❌ `sales` 테이블 직접 집계 금지
- ❌ `daily_close` 직접 집계는 "마감 여부 판단용"으로만 사용

#### 4.1.2 주요 테이블 구조

**매출 관련**:
- `daily_close`: 공식 마감 기록 (SSOT)
- `sales`: 보조 입력 채널 (마감 못한 날/과거 입력용)
- `naver_visitors`: 네이버방문자 수
- `daily_sales_items`: 메뉴별 판매량 (DELETE 금지, UPSERT + audit)
- `daily_sales_items_audit`: 판매량 변경 이력

**마스터 데이터**:
- `menu_master`: 메뉴 정보 (메뉴명, 판매가, 카테고리)
- `ingredients`: 재료 정보 (재료명, 단위, 단가, 발주단위)
- `recipes`: 레시피 (메뉴-재료 매핑, 사용량)

**설계 데이터 (DB 저장)**:
- `menu_portfolio_state`: 메뉴 역할 태그 (미끼/볼륨/마진)
- `ingredient_structure_state`: 재료 설계 상태 (대체 가능, 발주 유형, 메모)
- `design_routine_log`: 설계 루틴 체크 (주간/월간 완료 기록)

**목표/정산**:
- `targets`: 목표 매출/비용 구조
- `expense_structure`: 월별 비용 구조
- `actual_settlement_items`: 실제 정산 항목 값

**전략 실행**:
- `strategy_missions`: 전략 미션 (생성, 실행, 모니터링, 재개입)
- `mission_effects`: 미션 효과 기록

#### 4.1.3 주요 VIEW

- `v_daily_sales_official`: daily_close 기준 공식 매출
- `v_daily_sales_best_available`: daily_close 우선, 없으면 sales 사용
- `v_daily_sales_items_effective`: 판매량 유효 데이터

---

### 4.2 데이터 흐름

#### 4.2.1 일일 입력 → 통계 반영 흐름

```
일일 입력(통합) 페이지
    ↓
[💾 저장] 클릭
    ↓
save_sales_entry() → sales, naver_visitors upsert
save_daily_sales_item() → daily_sales_items upsert + audit
    ↓
(마감 있는 날) daily_close 동기화
    ↓
캐시 무효화 (soft_invalidate)
    ↓
v_daily_sales_best_available 뷰 자동 반영
    ↓
홈/분석 페이지에서 즉시 확인 가능
```

#### 4.2.2 마감 생성 흐름

```
일일 입력(통합) 페이지
    ↓
[📋 이 날짜 마감하기] 클릭
    ↓
save_daily_close() → RPC 호출
    ↓
daily_close 생성/업데이트
sales, naver_visitors 파생 동기화
daily_sales_items UPSERT
    ↓
캐시 무효화
    ↓
v_daily_sales_official 뷰 자동 반영
마감률/스트릭 증가
```

#### 4.2.3 마스터 데이터 체인

```
재료 등록
    ↓ [재료명, 단위, 단가]
메뉴 등록
    ↓ [메뉴명, 판매가]
레시피 등록
    ↓ [메뉴명 + 재료명 + 사용량]
원가 파악
    ↓ [메뉴별 원가, 원가율 계산]
```

---

## 5. 주요 기능 흐름

### 5.1 전략 자동 생성 흐름

```
홈 진입
    ↓
classify_store_state() (10-7A)
    ↓
가게 상태 분류: survival/recovery/restructure/growth
점수 계산: sales, menu, ingredient, revenue, overall
    ↓
build_strategy_cards() (10-7B)
    ↓
전략 카드 TOP3 생성
    ↓
build_weekly_roadmap() (10-7C)
    ↓
이번 주 실행 TOP3 생성
    ↓
홈 ZONE 0/1/4에 표시
```

### 5.2 설계 데이터 활용 흐름

```
설계실에서 데이터 입력
    ↓
DB 저장 (menu_portfolio_state, ingredient_structure_state)
    ↓
get_design_insights() (10-5)
    ↓
통합 인사이트 집계
    ↓
HOME 판결 업그레이드
설계센터 런치패드 Top3 개인화
```

### 5.3 매출 하락 원인 찾기 플로우

```
[📉 매출 하락 원인 찾기] 버튼 클릭
    ↓
STEP 1: 언제부터 떨어졌나?
    - 기간 선택, 비교 방식 선택
    - 하락 시작 추정일, 하락 강도 계산
    ↓
STEP 2: 무엇이 떨어졌나?
    - 네이버방문자/객단가/판매량/상위메뉴 변화 분석
    - 원인 후보 카드 자동 생성
    ↓
STEP 3: 어디를 고치나?
    - 추천 수리 액션 카드 3개
    - CTA 버튼으로 설계실/분석 페이지 이동
```

---

## 6. 기술 스택 및 아키텍처

### 6.1 기술 스택

**프론트엔드**:
- Streamlit (Python 웹 프레임워크)
- Pandas (데이터 처리)
- Plotly/Matplotlib (차트 시각화)

**백엔드**:
- Supabase (PostgreSQL + Auth + RLS)
- Python 3.11+

**인프라**:
- Streamlit Cloud (호스팅)
- Supabase Cloud (DB)

### 6.2 아키텍처 패턴

**레이어 구조**:
```
UI Layer (ui_pages/)
    ↓
Business Logic Layer (src/analytics.py, src/strategy/)
    ↓
Data Access Layer (src/storage_supabase.py)
    ↓
Database Layer (Supabase PostgreSQL)
```

**모듈 구조**:
- `ui_pages/`: 페이지 렌더링 함수
- `src/storage_supabase.py`: 데이터 저장/로드 함수
- `src/analytics.py`: 분석 계산 함수
- `src/auth.py`: 인증/권한 관리
- `ui_pages/strategy/`: 전략 엔진 (상태 분류, 카드 생성, 로드맵)
- `ui_pages/design_lab/`: 설계실 공통 프레임 및 헬퍼
- `ui_pages/coach/`: 코치 판결 및 렌더링
- `ui_pages/routines/`: 루틴 상태 관리

### 6.3 캐싱 전략

- `@st.cache_data`: 데이터 로딩 함수 캐싱
- `soft_invalidate()`: 저장 시 관련 캐시만 무효화
- `bump_data_version()`: 버전 토큰 기반 캐시 무효화

### 6.4 보안

- Row Level Security (RLS): Supabase RLS 정책
- `auth.uid()` 기반 데이터 접근 제어
- `store_members` 테이블 기반 멤버십 확인

---

## 7. 코드 구조

### 7.1 디렉토리 구조

```
store_ops_v1/
├── app.py                          # 메인 앱 (라우팅, 사이드바)
├── ui_pages/                       # 페이지 렌더링 함수
│   ├── home/                       # 홈 페이지 모듈
│   │   ├── home_page.py           # 홈 메인
│   │   ├── home_v3_zones.py       # HOME v3 ZONE 렌더링
│   │   ├── home_data.py           # 데이터 로더
│   │   ├── home_verdict.py        # 판결 로직
│   │   └── ...
│   ├── design_lab/                 # 설계실 공통 모듈
│   │   ├── design_center.py       # 가게 설계 센터
│   │   ├── design_lab_frame.py   # 공통 프레임
│   │   ├── design_insights.py    # 통합 인사이트
│   │   └── ...
│   ├── strategy/                  # 전략 엔진
│   │   ├── store_state.py        # 가게 상태 분류 (10-7A)
│   │   ├── strategy_cards.py     # 전략 카드 생성 (10-7B)
│   │   ├── roadmap.py            # 로드맵 생성 (10-7C)
│   │   └── strategy_board.py     # 전략 보드 페이지
│   ├── analysis/                   # 분석 모듈
│   │   ├── sales_drop_investigation.py  # 매출 하락 원인 찾기
│   │   └── strategy_engine.py    # 전략 엔진
│   ├── coach/                      # 코치 모듈
│   ├── routines/                   # 루틴 모듈
│   ├── common/                     # 공통 컴포넌트
│   ├── daily_input_hub.py         # 일일 입력 통합
│   ├── menu_management.py         # 메뉴 포트폴리오 설계실
│   ├── ingredient_management.py   # 재료 구조 설계실
│   ├── menu_profit_design_lab.py  # 메뉴 수익 구조 설계실
│   ├── revenue_structure_design_lab.py  # 수익 구조 설계실
│   ├── sales_management.py        # 매출 분석
│   ├── sales_analysis.py          # 판매·메뉴 분석
│   ├── settlement_actual.py      # 월간 성적표
│   └── ...
├── src/                            # 핵심 비즈니스 로직
│   ├── storage_supabase.py       # 데이터 저장/로드 (4000+ 라인)
│   ├── analytics.py               # 분석 계산 함수
│   ├── auth.py                    # 인증/권한 관리
│   ├── bootstrap.py               # 공통 설정
│   ├── ui_helpers.py              # UI 헬퍼 함수
│   └── ...
├── sql/                            # SQL 스크립트
│   ├── schema.sql                 # 기본 스키마
│   ├── ssot_views_and_audit.sql  # SSOT 뷰 및 audit
│   ├── design_lab_state_tables.sql  # 설계 데이터 테이블
│   ├── phase10_strategy_execution.sql  # 전략 실행 스키마
│   └── ...
└── docs/                           # 문서
```

### 7.2 주요 함수 분류

**데이터 저장/로드** (`src/storage_supabase.py`):
- `save_daily_close()`: 마감 저장
- `save_sales_entry()`: 매출/방문자 저장 (daily_close 동기화 포함)
- `save_daily_sales_item()`: 판매량 저장 (UPSERT + audit)
- `get_day_record_status()`: 날짜 상태 확인
- `load_best_available_daily_sales()`: best_available 뷰 조회
- `load_monthly_sales_total()`: 월 매출 합계 (best_available 기반)

**전략 엔진** (`ui_pages/strategy/`):
- `classify_store_state()`: 가게 상태 분류 (survival/recovery/restructure/growth)
- `build_strategy_cards()`: 전략 카드 TOP3 생성
- `build_weekly_roadmap()`: 이번 주 실행 로드맵 생성

**설계 인사이트** (`ui_pages/design_lab/`):
- `get_design_insights()`: 통합 설계 인사이트 집계
- `get_design_state()`: 설계 상태 점수/신호
- `get_design_center_summary()`: 설계 센터 요약

**분석 엔진** (`core/`, `ui_pages/analysis/`):
- `sales_drop_engine.py`: 매출 하락 분석 엔진
- `strategy_engine.py`: 전략 엔진

**코치 판결** (`ui_pages/coach/`):
- `get_home_coach_verdict()`: 홈 판결
- `get_design_center_verdict()`: 설계 센터 판결
- `render_verdict_card()`: 판결 카드 렌더링

### 7.3 공통 컴포넌트

**Design Lab 프레임** (`ui_pages/design_lab/design_lab_frame.py`):
- `render_coach_board()`: ZONE A 코치 요약
- `render_structure_map_container()`: ZONE B 구조 맵
- `render_school_cards()`: ZONE C 사장 학교
- `render_design_tools_container()`: ZONE D 설계 도구

**네비게이션** (`ui_pages/design_lab/design_lab_nav.py`):
- `render_back_to_design_center_button()`: 가게 설계 센터로 돌아가기 버튼

**전략 카드** (`ui_pages/common/today_strategy_card.py`):
- 공통 전략 카드 컴포넌트

---

## 8. 주요 기능 상세

### 8.1 HOME v3 (운영 지시 홈)

**핵심 개념**: "오늘 뭘 해야 하는지" → "이번 달 전략" → "그 다음 숫자"

**ZONE별 역할**:
- ZONE 0: 오늘의 1순위 행동 (로드맵/전략 카드 기반)
- ZONE 1: 이번 달 가게 전략 요약 (상태, 메인 전략, 위험 구조)
- ZONE 2: 문제 해결 진입 버튼
- ZONE 3: 숫자 근거 정보 (크기 축소)
- ZONE 4: 이번 주 우선순위 TOP3
- ZONE 5: 가게 구조 스냅샷

### 8.2 전략 보드

**핵심 개념**: 가게 상태 분류 + 전략 카드 TOP3 + 실행 로드맵

**가게 상태 분류 (4가지)**:
- **survival**: 생존 (overall score <= 30)
- **recovery**: 회복 (30 < score <= 50)
- **restructure**: 구조 개편 (50 < score <= 70)
- **growth**: 성장 (score > 70)

**점수 계산**:
- sales_score: 매출 추세, 하락 신호
- menu_score: 메뉴 포트폴리오 균형, 원가율 위험
- ingredient_score: 원가 집중도, 고위험 재료
- revenue_score: 손익분기점 대비, 변동비율
- overall_score: 가중 평균

**전략 카드 템플릿 (6가지)**:
1. 생존선 복구 (Revenue)
2. 마진 구조 복구 (Menu Profit)
3. 원가 집중 분산 (Ingredient)
4. 포트폴리오 재배치 (Portfolio)
5. 매출 하락 원인 찾기 (Sales Recovery)
6. 데이터 채우기/설계 시작 (Fallback)

### 8.3 가게 설계 센터

**핵심 개념**: 4개 설계실 통합 진단 + 런치패드

**통합 진단 카드 4개**:
1. 메뉴 포트폴리오 상태
2. 메뉴 수익 구조 상태
3. 재료 구조 상태
4. 수익 구조 상태

**런치패드 개인화**:
- 설계 인사이트 기반 Top3 선정
- 우선순위 점수화 (break_even_gap_ratio < 0.9 => +100점 등)

### 8.4 일일 입력 통합

**핵심 개념**: 날짜 선택 → 숫자 입력 → 저장만 (마감/보정/임시 자동 처리)

**저장 분기**:
- 마감 있는 날 저장 → 보정 기록 (daily_close 동기화)
- 마감 없는 날 저장 → 임시 기록 (sales/visitors/items만)
- 마감 생성 → 공식 마감 (daily_close 생성)

---

## 9. 데이터베이스 스키마 요약

### 9.1 핵심 테이블

**매출/판매**:
- `daily_close`: 공식 마감 (date, store_id, total_sales, card_sales, cash_sales, visitors, memo, issues)
- `sales`: 보조 매출 (date, store_id, total_sales, card_sales, cash_sales)
- `naver_visitors`: 네이버방문자 (date, store_id, visitors)
- `daily_sales_items`: 판매량 (date, store_id, menu_id, qty)
- `daily_sales_items_audit`: 판매량 변경 이력

**마스터**:
- `menu_master`: 메뉴 (name, price, category, cooking_method)
- `ingredients`: 재료 (name, unit, unit_cost, order_unit, conversion_rate, safety_stock)
- `recipes`: 레시피 (menu_id, ingredient_id, qty)

**설계 데이터**:
- `menu_portfolio_state`: 메뉴 역할 태그 (menu_id, role_tag: 미끼/볼륨/마진)
- `ingredient_structure_state`: 재료 설계 상태 (ingredient_id, is_substitutable, order_type, substitute_memo, strategy_memo)
- `design_routine_log`: 설계 루틴 체크 (routine_type, period_key, completed_at)

**목표/정산**:
- `targets`: 목표 매출/비용 구조 (year, month, target_sales, target_cost_rate, ...)
- `expense_structure`: 월별 비용 구조 (year, month, category, item_name, amount)
- `actual_settlement_items`: 실제 정산 항목 (year, month, template_id, amount, percent, status)

**전략 실행**:
- `strategy_missions`: 전략 미션 (store_id, year, month, mission_type, status, monitor_start_date, evaluation_date, result_type)
- `mission_effects`: 미션 효과 (mission_id, metric_name, before_value, after_value, change_pct)

### 9.2 주요 VIEW

- `v_daily_sales_official`: daily_close 기준 공식 매출
- `v_daily_sales_best_available`: daily_close 우선, 없으면 sales 사용
- `v_daily_sales_items_effective`: 판매량 유효 데이터

### 9.3 주요 RPC 함수

- `save_daily_close_transaction`: 마감 저장 트랜잭션
- `log_daily_sales_item_change`: 판매량 변경 audit 로깅

---

## 10. 주요 기능별 데이터 연계

### 10.1 매출 입력 → 통계 반영

```
일일 입력(통합) 저장
    ↓
sales / naver_visitors / daily_sales_items 저장
    ↓
v_daily_sales_best_available 뷰 자동 반영
    ↓
홈 KPI 즉시 업데이트
매출 분석 페이지 반영
월간 성적표 반영
```

### 10.2 설계 데이터 → 판결 반영

```
설계실에서 역할 태그/대체 가능/발주 유형 저장
    ↓
menu_portfolio_state / ingredient_structure_state 저장
    ↓
get_design_insights() 집계
    ↓
HOME 판결 업그레이드
설계센터 런치패드 Top3 개인화
```

### 10.3 전략 생성 → 실행

```
가게 상태 분류 (classify_store_state)
    ↓
전략 카드 생성 (build_strategy_cards)
    ↓
로드맵 생성 (build_weekly_roadmap)
    ↓
홈/전략 보드에 표시
    ↓
사용자 실행 → mission 생성
    ↓
효과 모니터링 → 재개입 결정
```

---

## 11. 페이지간 숫자 연계 및 충돌

### 11.1 매출 숫자 연계

**SSOT 정책 준수**:
- ✅ 모든 KPI/트렌드/비교: `v_daily_sales_best_available`
- ✅ 마감률/스트릭: `v_daily_sales_official`
- ❌ `sales` 테이블 직접 집계 금지

**연계 흐름**:
```
일일 입력 저장
    ↓
v_daily_sales_best_available 뷰 자동 반영
    ↓
홈 KPI (어제 매출, 이번 달 누적, 평균 일매출)
    ↓
매출 분석 (월별 추이, 전월 대비)
    ↓
월간 성적표 (월 매출 자동 불러오기)
```

### 11.2 설계 데이터 연계

**DB 저장 우선**:
- 메뉴 역할 태그: `menu_portfolio_state` 테이블
- 재료 설계 상태: `ingredient_structure_state` 테이블
- session_state는 캐시용으로만 사용

**연계 흐름**:
```
설계실에서 태그/상태 저장
    ↓
DB 저장 (menu_portfolio_state, ingredient_structure_state)
    ↓
get_design_insights() 집계
    ↓
HOME 판결 반영
설계센터 요약 반영
전략 카드 생성에 반영
```

### 11.3 충돌 방지 정책

**데이터 일관성**:
- SSOT 뷰 사용으로 중복 제거
- UPSERT 구조로 DELETE 방지
- Audit 로깅으로 변경 이력 추적

**캐시 무효화**:
- 저장 시 `soft_invalidate()` 호출
- 관련 테이블만 선택적 무효화
- 버전 토큰 기반 무효화

---

## 12. 개발 구조 및 패턴

### 12.1 모듈화 원칙

**페이지 모듈**:
- 각 페이지는 독립적인 `render_*()` 함수
- `ui_pages/` 디렉토리 하위에 구조화

**비즈니스 로직 모듈**:
- `src/storage_supabase.py`: 데이터 저장/로드
- `src/analytics.py`: 분석 계산
- `ui_pages/strategy/`: 전략 엔진
- `ui_pages/design_lab/`: 설계 인사이트

**공통 컴포넌트**:
- `ui_pages/design_lab/design_lab_frame.py`: 설계실 공통 프레임
- `ui_pages/common/`: 공통 UI 컴포넌트
- `src/ui_helpers.py`: UI 헬퍼 함수

### 12.2 에러 처리

**안전 가드**:
- 데이터 부족 시 graceful fallback
- try-except로 에러 처리
- DEV 모드에서만 상세 에러 표시

**Fallback 전략**:
- 설계 데이터 없으면 기본값 사용
- 전략 엔진 에러 시 안내 문구 + 기본 버튼
- 캐시 실패 시 직접 조회

### 12.3 성능 최적화

**캐싱**:
- `@st.cache_data`로 데이터 로딩 캐싱
- store_id/year/month 키 포함
- TTL 설정 (60초 ~ 3600초)

**지연 로딩**:
- 무거운 계산은 expander 내부로 이동
- 탭 전환 시 선택적 로딩

---

## 13. 주요 개선 이력 (PHASE 8-10)

### PHASE 8: SSOT 정책 수립
- daily_close를 공식 SSOT로 확정
- v_daily_sales_official, v_daily_sales_best_available 뷰 생성
- daily_sales_items DELETE 금지 + audit 구조 도입
- 매출보정/점장마감 통합 플로우

### PHASE 9: UI 구조 개편
- 사이드바 카테고리 재구성
- HOME v2 리빌드 (Coach + School)
- Design Lab 공통 프레임 적용 (4개 설계실)
- 가게 설계 센터 생성

### PHASE 10: 전략 자동화 및 통합
- 설계 데이터 DB화 (menu_portfolio_state, ingredient_structure_state)
- 설계 데이터 활용 자동 연결 (design_insights)
- 매출 하락 원인 찾기 원클릭 플로우
- 가게 상태 분류 엔진 (store_state)
- 전략 카드 TOP3 생성 엔진 (strategy_cards)
- 전략 실행 로드맵 + 전략 보드
- 코치모드/빠른모드 제거 (통합 UX)
- HOME v3 전환 (운영 지시 홈)
- 일일 입력 UX 1플로우 통합

---

## 14. 향후 확장 포인트

### 14.1 계획된 기능
- 방문·객단가 분석 페이지
- 미션 효과 자동 모니터링 및 재개입
- 설계 루틴 자동화

### 14.2 개선 가능 영역
- POS 연동 (API)
- 예측 분석 (AI)
- 직원 관리 (근무 스케줄, 인건비 자동 계산)
- 공급업체 관리 (발주 업체 정보, 발주 이력)

---

## 15. 핵심 개념 정리

### 15.1 용어 통일
- "방문자" → "네이버방문자" (전면 통일)
- "코치모드/빠른모드" → 제거 (통합 UX)
- "일일 입력(통합)" → 점장 마감/매출보정/판매량보정 통합

### 15.2 철학 키워드
- **Coach + School**: 문제 진단 + 해결 방향 제시
- **Design System**: 가게 구조를 설계하는 전략실
- **Operation Instruction**: "오늘 무엇을 해야 하는가" 중심
- **Single Source of Truth**: 데이터 일관성 보장

---

## 16. 완료일
2026-01-24

---

**이 문서는 앱의 전체 구조를 이해하기 위한 종합 보고서입니다.**
**기획 전문가와의 논의 시 이 문서를 기준으로 진행하시기 바랍니다.**
